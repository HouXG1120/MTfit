

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="English" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="English" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>17.1.3. MTfit.probability &mdash; MTfit documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="17.1.4. MTfit.sampling" href="source-sampling.html" />
    <link rel="prev" title="17.1.2.2.3. MTfit.algorithms.markov_chain_monte_carlo" href="source-markov_chain_monte_carlo.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> MTfit
          

          
            
            <img src="_static/MTfitsphinx.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.3a15
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">2. Running MTfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="real-tutorial.html">4. Tutorial: Real Data Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">5. Bayesian Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">7. Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtconvert.html">8. Moment Tensor Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">9. Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplot.html">10. Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_classes.html">11. Plot Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplotcli.html">12. MTplot Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="inversion.html">13. Inversion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">14. Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">16. Glossary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="source.html">17. Source Code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="source.html#contents">17.1. Contents:</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="source-inversion.html">17.1.1. MTfit.inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-algorithms.html">17.1.2. MTfit.algorithms</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">17.1.3. MTfit.probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-sampling.html">17.1.4. MTfit.sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-run.html">17.1.5. MTfit.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-utilities.html">17.1.6. MTfit.utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-extensions.html">17.1.7. MTfit.extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-convert.html">17.1.8. MTfit.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-plot.html">17.1.9. MTfit.plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/djpugh/MTfit">GitHub Repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MTfit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="source.html">17. MTfit Source Code</a> &raquo;</li>
        
      <li>17.1.3. MTfit.probability</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/source-probability.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mtfit-probability">
<h1>17.1.3. MTfit.probability<a class="headerlink" href="#mtfit-probability" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">probability.py</span>
<span class="sd">**************</span>

<span class="sd">Probability module for MTfit, handles all probability calculations and</span>
<span class="sd">contains the base LnPDF class for acting on probabilities.</span>

<span class="sd">LnPDF object acts as a wrapper around a numpy matrix, allowing some</span>
<span class="sd">additional pdf specific operations.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># **Restricted:  For Non-Commercial Use Only**</span>
<span class="c1"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c1"># and non-commercially funded academic research purposes.</span>
<span class="c1">#</span>
<span class="c1"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>


<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">norm</span> <span class="k">as</span> <span class="n">gaussian</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">beta</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">erf</span>

<span class="kn">from</span> <span class="nn">..utilities</span> <span class="k">import</span> <span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;MTfit.probability&#39;</span><span class="p">)</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">cprobability</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">cprobability</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error importing c extension&#39;</span><span class="p">)</span>
    <span class="n">cprobability</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Set to prevent numpy warnings</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">)</span>

<span class="c1"># Set flags for running with/without the c library</span>

<span class="c1"># Flag for testing Cython based C library functions even if they would be skipped</span>
<span class="c1"># e.g. polarity_ln_pdf on windows due to missing functions in math.h</span>
<span class="n">_C_LIB_TESTS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Value of a very small non-zero number for handling zero error values</span>
<span class="n">_SMALL_NUMBER</span> <span class="o">=</span> <span class="mf">0.000000000000000000000001</span>

<span class="c1"># TODO - tidy and refactor code to avoid duplication</span>


<span class="k">def</span> <span class="nf">_6sphere_prior</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    6-sphere prior</span>

<span class="sd">    Returns 1 as samples are generated directly from the prior</span>

<span class="sd">    Other priors can be used either by non-uniform sampling in the prior</span>
<span class="sd">    and using the prior as the correction term in the bayesian evidence</span>
<span class="sd">    calculation, or by leaving the prior as 1 and sampling from the prior</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">1.</span>


<span class="k">def</span> <span class="nf">polarity_ln_pdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">_use_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability of a positive polarity</span>

<span class="sd">    Calculates the probability of a positive polarity observation given</span>
<span class="sd">    a theoretical amplitude X and a fractional uncertainty sigma.</span>

<span class="sd">    The derivation of this pdf for the polarity observation can be seen in:</span>
<span class="sd">        Pugh, D. J., White, R. S., &amp; Christie, P. A. F., 2016.</span>
<span class="sd">        A Bayesian method for microseismic source inversion,</span>
<span class="sd">        Geophysical Journal International , 206(2), 1009-1038.</span>

<span class="sd">    Args:</span>
<span class="sd">        a: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">        mt: np.array - 2 dimensional numpy array of moment tensor 6</span>
<span class="sd">                vector samples</span>
<span class="sd">        sigma: np.array - 1 dimensional array of fractional uncertainties.</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        incorrect_polarity_probability: float (default=0) - probability</span>
<span class="sd">                of a receiver orientation error, flipping the polarity dist.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.array - probabilities for each moment tensor sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check inputs and expcected dimensions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sigma</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: sigma is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: a is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mt</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: mt is expected to be a two-dimensional numpy array of moment tensor six vectors&#39;</span><span class="p">)</span>
    <span class="c1"># For fractional uncertainties that are zero make them really small</span>
    <span class="c1"># to avoid zero divison errors</span>
    <span class="n">sigma</span><span class="p">[</span><span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_use_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_use_c</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_use_c</span><span class="p">:</span>
                <span class="c1"># Raise an exception due to windows C_LIB using VS2008 VC math.h</span>
                <span class="c1"># which has no erf</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Windows&#39;</span><span class="p">)</span>
            <span class="c1"># Run using C library</span>
            <span class="c1"># Handle incorrect polarity probability</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sigma</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">incorrect_polarity_probability</span>
            <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: incorrect_polarity_probability is expected to be a one-dimensional numpy array or a float&#39;</span><span class="p">)</span>
            <span class="c1"># Check types and convert to the correct types in place</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mt</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                                                                       <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Make sure moment tensors are C contiguous</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mt</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
                <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
            <span class="c1"># Calculate log of pdf</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">polarity_ln_pdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Run using python</span>
            <span class="c1"># Testing C code</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_C_LIB_TESTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">completed</span><span class="p">:</span>
        <span class="c1"># Check moment tensor shape is correct</span>
        <span class="k">if</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="c1"># Calcuate Theoretical Amplitude for moment tensors</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Expand errors and incorrect_polarity_probability dimensions to be</span>
        <span class="c1"># expected</span>
        <span class="k">while</span> <span class="n">sigma</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                    <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Calculate probability</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">erf</span><span class="p">(</span><span class="n">X</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))))</span> <span class="o">*</span>
                      <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">+</span>
                      <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="n">X</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">))))</span> <span class="o">*</span>
                      <span class="n">incorrect_polarity_probability</span><span class="p">)</span>
        <span class="c1"># Set NaNs to zero probability</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="c1"># Combine probabilities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_prod</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">ln_p</span>


<span class="k">def</span> <span class="nf">polarity_probability_ln_pdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">positive_probability</span><span class="p">,</span> <span class="n">negative_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">_use_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability of a given theoretical amplitude giving an</span>
<span class="sd">    observed polarity probability.</span>

<span class="sd">    Calculates the probability of a polarity probability observation</span>
<span class="sd">    given a theoretical amplitude X.</span>

<span class="sd">    The derivation of this pdf for the polarity probability observation</span>
<span class="sd">    can be seen in:</span>
<span class="sd">        Pugh, D. J., White, R. S., &amp; Christie, P. A. F., 2016.</span>
<span class="sd">        Automatic Bayesian polarity determination,</span>
<span class="sd">        Geophysical Journal International , 206(1), 275-291.</span>

<span class="sd">    Args</span>
<span class="sd">        a: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">        mt: np.array - 2 dimensional numpy array of moment tensor 6 vector</span>
<span class="sd">                samples</span>
<span class="sd">        positive_probability: float/np.array - the probability of a positive polarity</span>
<span class="sd">                observation. Needs to be same length as mt, or a scalar.</span>
<span class="sd">        negative_probability: float/np.array - the probability of a negative polarity</span>
<span class="sd">                observation. Needs to be same length as mt, or a scalar.</span>

<span class="sd">    Optional Args:</span>
<span class="sd">        incorrect_polarity_probability: float (default=0) - probability of a</span>
<span class="sd">                receiver orientation error, flipping the polarity dist.</span>

<span class="sd">    Returns</span>
<span class="sd">        float/np.array -  probabilities for each moment tensor sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check inputs and expcected dimensions</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">positive_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">negative_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="n">negative_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">negative_probability</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">positive_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: positive_probability is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">negative_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">negative_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: negative_probability is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: a is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mt</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: mt is expected to be a two-dimensional numpy array of moment tensor six vectors&#39;</span><span class="p">)</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_use_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_use_c</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run using C library</span>
            <span class="c1"># Handle incorrect polarity probability</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">positive_probability</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">incorrect_polarity_probability</span>
            <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: incorrect_polarity_probability is expected to be a one-dimensional numpy array or a float&#39;</span><span class="p">)</span>
            <span class="c1"># Check types and convert to the correct types in place</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mt</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                                                                                       <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positive_probability</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">positive_probability</span> <span class="o">=</span> <span class="n">positive_probability</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">negative_probability</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                <span class="n">negative_probability</span> <span class="o">=</span> <span class="n">negative_probability</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Make sure moment tensors are C contiguous</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mt</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
                <span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
            <span class="c1"># Calculate log of pdf</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">polarity_probability_ln_pdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">positive_probability</span><span class="p">,</span> <span class="n">negative_probability</span><span class="p">,</span>
                                                            <span class="n">incorrect_polarity_probability</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Run using python</span>
            <span class="c1"># Testing C code</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_C_LIB_TESTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">completed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="c1"># Calculate theoretical amplitude</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Expand errors and incorrect_polarity_probability dimensions to be</span>
        <span class="c1"># expected</span>
        <span class="k">while</span> <span class="n">positive_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">positive_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">negative_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">negative_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">negative_probability</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">incorrect_polarity_probability</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span>
                    <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="p">((</span><span class="n">heaviside</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">positive_probability</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">heaviside</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">negative_probability</span><span class="p">))</span> <span class="o">*</span>
            <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">+</span>
            <span class="p">((</span><span class="n">heaviside</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">negative_probability</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">heaviside</span><span class="p">(</span><span class="o">-</span><span class="n">X</span><span class="p">)</span> <span class="o">*</span> <span class="n">positive_probability</span><span class="p">))</span> <span class="o">*</span>
            <span class="n">incorrect_polarity_probability</span><span class="p">)</span>
        <span class="c1"># Set NaNs to zero probability</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="c1"># Combine probabilities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_prod</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">ln_p</span>


<span class="k">def</span> <span class="nf">amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">a_x</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">percentage_error_x</span><span class="p">,</span> <span class="n">percentage_error_y</span><span class="p">,</span> <span class="n">_use_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability of a given theoretical amplitude ratio giving</span>
<span class="sd">    an observed ratio</span>

<span class="sd">    Calculates the probability of an amplitude ratio observation given a</span>
<span class="sd">    theoretical amplitude ratio and uncertainties on the numerator and</span>
<span class="sd">    denominator</span>

<span class="sd">    The derivation of this pdf for the amplitude ratio observation can be</span>
<span class="sd">    seen in:</span>
<span class="sd">        Pugh, D. J., White, R. S., &amp; Christie, P. A. F., 2016.</span>
<span class="sd">        A Bayesian method for microseismic source inversion,</span>
<span class="sd">        Geophysical Journal International , 206(2), 1009-1038.</span>

<span class="sd">    Args</span>
<span class="sd">        ratio: np.array - 1 dimensional numpy array of observed ratio</span>
<span class="sd">                values</span>
<span class="sd">        mt: np.array - 2 dimensional numpy array of moment tensor 6</span>
<span class="sd">                vector samples</span>
<span class="sd">        a_x: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">                for the numerator</span>
<span class="sd">        a_y: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">                for the denominator</span>
<span class="sd">        percentage_error_x: np.array - 1 dimensional numpy array of</span>
<span class="sd">                percentage errors for the numerator</span>
<span class="sd">        percentage_error_y: np.array - 1 dimensional numpy array of</span>
<span class="sd">                percentage errors for the denominator</span>

<span class="sd">    Returns</span>
<span class="sd">        float/np.array -  probabilities for each moment tensor sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check inputs and expcected dimensions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable a_x is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: a_y is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mt</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: mt is expected to be a two-dimensional numpy array of moment tensor six vectors&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ratio</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: ratio is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">percentage_error_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: percentage_error_x is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">percentage_error_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Variable: percentage_error_y is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="c1"># Handle zero errors by making them small to avoid zero division errors</span>
    <span class="n">percentage_error_x</span><span class="p">[</span><span class="n">percentage_error_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="n">percentage_error_y</span><span class="p">[</span><span class="n">percentage_error_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="c1"># Make sure the errors are positive</span>
    <span class="n">percentage_error_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">)</span>
    <span class="n">percentage_error_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">)</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_use_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_use_c</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">a_x</span><span class="p">,</span> <span class="n">a_y</span><span class="p">,</span> <span class="n">percentage_error_x</span><span class="p">,</span>
                                                       <span class="n">percentage_error_y</span><span class="p">)</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Run using python</span>
            <span class="c1"># Testing C code</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_C_LIB_TESTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">completed</span><span class="p">:</span>
        <span class="c1"># Calculate probability using Python code</span>
        <span class="c1"># Calculate means for numerator and denominator</span>
        <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a_x</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a_y</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure they are positive</span>
        <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mu_x</span><span class="p">)</span>
        <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mu_y</span><span class="p">)</span>
        <span class="c1"># Expand errors and ratio values to be 3 dimensional</span>
        <span class="k">while</span> <span class="n">percentage_error_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">percentage_error_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">ratio</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Get error on numerator and denominator</span>
        <span class="n">numerator_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
        <span class="n">denominator_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">)</span>
        <span class="c1"># Calculate log of pdf</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ratio_pdf</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">numerator_error</span><span class="p">,</span> <span class="n">denominator_error</span><span class="p">)</span> <span class="o">+</span>
                      <span class="n">ratio_pdf</span><span class="p">(</span><span class="o">-</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">numerator_error</span><span class="p">,</span> <span class="n">denominator_error</span><span class="p">))</span>
        <span class="c1"># Set NaNs to zero probability</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="c1"># Combine probabilities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_prod</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">ln_p</span>


<span class="k">def</span> <span class="nf">relative_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">,</span> <span class="n">mt_1</span><span class="p">,</span> <span class="n">mt_2</span><span class="p">,</span> <span class="n">a_1</span><span class="p">,</span> <span class="n">a_2</span><span class="p">,</span> <span class="n">percentage_error_1</span><span class="p">,</span> <span class="n">percentage_error_2</span><span class="p">,</span> <span class="n">_use_c</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the probability of a given theoretical relative amplitude</span>
<span class="sd">    ratio giving an observed ratio.</span>

<span class="sd">    Calculates the probability of an amplitude ratio observation given a</span>
<span class="sd">    theoretical amplitude ratio and uncertainties on the numerator and</span>
<span class="sd">    denominator.</span>

<span class="sd">    The derivation of this pdf for the relative amplitude observation</span>
<span class="sd">    can be seen in:</span>
<span class="sd">        Pugh, D. J., 2015.</span>
<span class="sd">        Bayesian Source Inversion of Microseismic Events,</span>
<span class="sd">        Ph.D. thesis, University of Cambridge.</span>

<span class="sd">    Args</span>
<span class="sd">        x: np.array - 1 dimensional numpy array of observed numerator</span>
<span class="sd">                values</span>
<span class="sd">        y: np.array - 1 dimensional numpy array of observed denominator</span>
<span class="sd">                values</span>
<span class="sd">        mt_1: np.array - 2 dimensional numpy array of moment tensor 6</span>
<span class="sd">                vector samples for numerator</span>
<span class="sd">        mt_2: np.array - 2 dimensional numpy array of moment tensor 6</span>
<span class="sd">                vector samples for denominator</span>
<span class="sd">        a_1: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">                for the numerator</span>
<span class="sd">        a_2: np.array - 3 dimensional numpy array of station coefficients</span>
<span class="sd">                for the denominator</span>
<span class="sd">        percentage_error_1: np.array - 1 dimensional numpy array of</span>
<span class="sd">            percentage errors for the numerator</span>
<span class="sd">        percentage_error_2: np.array - 1 dimensional numpy array of</span>
<span class="sd">            percentage errors for the denominator</span>

<span class="sd">    Returns</span>
<span class="sd">        (np.array, np.array. np.array) -  tuple of probabilities for</span>
<span class="sd">                each joint moment tensor sample, scale factors for the</span>
<span class="sd">                event and the uncertainties in the scale factor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check inputs and expcected dimensions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Variable: a_1 is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">a_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;a_2 is expected to be a three-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mt_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;mt_1 is expected to be a two-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">mt_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;mt_2 is expected to be a two-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;x is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;y is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error_1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">percentage_error_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;percentage_error_1 is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error_2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">percentage_error_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;percentage_error_2 is expected to be a one-dimensional numpy array&#39;</span><span class="p">)</span>
    <span class="c1"># For fractional uncertainties that are zero make them really small</span>
    <span class="c1"># to avoid zero divison errors</span>
    <span class="n">percentage_error_1</span><span class="p">[</span><span class="n">percentage_error_1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="n">percentage_error_2</span><span class="p">[</span><span class="n">percentage_error_2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="c1"># Make sure the errors are positive</span>
    <span class="n">percentage_error_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percentage_error_1</span><span class="p">)</span>
    <span class="n">percentage_error_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">percentage_error_2</span><span class="p">)</span>
    <span class="n">completed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_use_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_use_c</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># raise ValueError(&#39;C code returning incorrect result for probabilities&#39;)</span>
            <span class="n">ln_p</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale_uncertainty</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">relative_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x_1</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">x_2</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mt_1</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mt_2</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_1</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_2</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">percentage_error_1</span><span class="p">),</span>
                                                                                          <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">percentage_error_2</span><span class="p">))</span>
            <span class="n">completed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Run using python</span>
            <span class="c1"># Testing C code</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_C_LIB_TESTS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">completed</span><span class="p">:</span>
        <span class="c1"># Calculate probability using Python code</span>
        <span class="c1"># Calculate the ratio</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_2</span><span class="p">)</span>
        <span class="c1"># Calculate means for numerator and denominator</span>
        <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a_1</span><span class="p">,</span> <span class="n">mt_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a_2</span><span class="p">,</span> <span class="n">mt_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Make sure they are positive</span>
        <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mu_x</span><span class="p">)</span>
        <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mu_y</span><span class="p">)</span>
        <span class="c1"># Expand errors and ratio values to be 3 dimensional</span>
        <span class="k">while</span> <span class="n">percentage_error_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">percentage_error_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">ratio</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Estimate scale factor</span>
        <span class="n">scale</span><span class="p">,</span> <span class="n">scale_uncertainty</span> <span class="o">=</span> <span class="n">scale_estimator</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span>
                                                   <span class="n">percentage_error_1</span><span class="p">,</span> <span class="n">percentage_error_2</span><span class="p">)</span>
        <span class="c1"># Multiply in the scale factor</span>
        <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
        <span class="c1"># Calculate the numerator and denominator errors</span>
        <span class="n">numerator_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">percentage_error_1</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
        <span class="n">denominator_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">percentage_error_2</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">)</span>
        <span class="c1"># Calculate the log pdf</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ratio_pdf</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">numerator_error</span><span class="p">,</span> <span class="n">denominator_error</span><span class="p">)</span> <span class="o">+</span>
                      <span class="n">ratio_pdf</span><span class="p">(</span><span class="o">-</span><span class="n">ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">numerator_error</span><span class="p">,</span> <span class="n">denominator_error</span><span class="p">))</span>
        <span class="c1"># Set NaNs to zero probability</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="c1"># Combine probabilities</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_prod</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">ln_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ln_p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale_uncertainty</span>


<span class="k">def</span> <span class="nf">scale_estimator</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">percentage_error_x</span><span class="p">,</span> <span class="n">percentage_error_y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the scale factor between the two events given the observed_ratio</span>
<span class="sd">    and theoretical ratios.</span>

<span class="sd">    The derivation of this calculation can be found in:</span>
<span class="sd">        Pugh, D. J., 2015.</span>
<span class="sd">        Bayesian Source Inversion of Microseismic Events,</span>
<span class="sd">        Ph.D. thesis, University of Cambridge.</span>

<span class="sd">    Args</span>
<span class="sd">        observed_ratio: np.array - numpy array of observed_ratio ratio values</span>
<span class="sd">        mu_x: np.array - numpy array of mean values for the numerator</span>
<span class="sd">        mu_y: np.array - numpy array of station coefficients for the</span>
<span class="sd">            denominator</span>
<span class="sd">        percentage_error_x: np.array - numpy array of percentage errors</span>
<span class="sd">            for the numerator</span>
<span class="sd">        percentage_error_y: np.array - numpy array of percentage errors</span>
<span class="sd">            for the denominator</span>

<span class="sd">    Returns</span>
<span class="sd">        (np.array, np.array) -  tuple of means and standard deviations</span>
<span class="sd">                of the scale factor for each sample</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Expand arrays to be correct dimensions</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mu_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">observed_ratio</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">observed_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">percentage_error_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">percentage_error_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">percentage_error_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Calculate standard deviations for the numerator and denominator</span>
    <span class="n">sx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">percentage_error_x</span><span class="p">),</span> <span class="n">mu_x</span><span class="p">)</span>
    <span class="n">sy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">percentage_error_y</span><span class="p">),</span> <span class="n">mu_y</span><span class="p">)</span>
    <span class="c1"># Convert the observed_ratio values to an array</span>
    <span class="n">observed_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observed_ratio</span><span class="p">)</span>
    <span class="c1"># Calculate PDF coefficients</span>
    <span class="n">mu_x_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
    <span class="n">mu_x_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x_2</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
    <span class="n">sx_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sx</span><span class="p">)</span>
    <span class="n">sy_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sy</span><span class="p">,</span> <span class="n">sy</span><span class="p">)</span>
    <span class="n">mu1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">),</span> <span class="n">mu_x</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sy_2</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">),</span> <span class="n">observed_ratio</span><span class="p">)</span> <span class="o">+</span> <span class="n">sx_2</span><span class="p">,</span> <span class="n">mu_x_2</span><span class="p">))</span>
    <span class="n">s1_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span>
    <span class="n">mu1_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu1</span><span class="p">,</span> <span class="n">mu1</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">observed_ratio</span><span class="p">),</span> <span class="n">sy_2</span><span class="p">),</span> <span class="n">mu_x_3</span><span class="p">)</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">sx_2</span><span class="p">),</span> <span class="n">mu_x_3</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sx_2</span><span class="p">,</span> <span class="n">sy</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">),</span>
                                          <span class="n">sy_2</span><span class="p">))</span>
                    <span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x_3</span><span class="p">,</span> <span class="n">s1_2</span><span class="p">))</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">mu1</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span> <span class="o">+</span> <span class="n">C</span>
    <span class="c1"># Calculate mean and standard deviations</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="n">s1_2</span> <span class="o">+</span> <span class="n">mu1_2</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">mu1</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">s1_2</span><span class="p">,</span> <span class="n">mu1</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu1_2</span><span class="p">,</span> <span class="n">mu1</span><span class="p">)))</span> <span class="o">+</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="p">(</span><span class="n">s1_2</span> <span class="o">+</span> <span class="n">mu1_2</span><span class="p">))</span> <span class="o">+</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sx_2</span><span class="p">,</span> <span class="n">mu_x_2</span><span class="p">)),</span>
                          <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">mu</span><span class="p">))</span>
    <span class="c1"># Combine mean over stations</span>
    <span class="k">return</span> <span class="n">combine_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">combine_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine the mean and standard deviations over stations</span>

<span class="sd">    Args</span>
<span class="sd">        mu: np.array - 2 dimensional numpy array of mean values</span>
<span class="sd">        s: np.array - 2 dimensional numpy array of standard deviation values</span>

<span class="sd">    Returns</span>
<span class="sd">        (np.array, np.array) - tuple of combined mean and standard deviation</span>
<span class="sd">            values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop over each sample</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># First sample so initialise the mean and standard debiation</span>
            <span class="n">combined_mu</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">combined_s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Combine with existing values</span>
            <span class="n">si_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">s_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">combined_s</span><span class="p">,</span> <span class="n">combined_s</span><span class="p">)</span>
            <span class="n">combined_mu</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">combined_mu</span><span class="p">,</span> <span class="n">si_2</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">s_2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">s_2</span><span class="o">+</span><span class="n">si_2</span><span class="p">)</span>
            <span class="n">combined_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">combined_s</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s_2</span><span class="o">+</span><span class="n">si_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">combined_mu</span><span class="p">,</span> <span class="n">combined_s</span>


<span class="c1"># Supporting PDF functions</span>


<span class="k">def</span> <span class="nf">gaussian_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Gaussian probability</span>

<span class="sd">    Calculates the Gaussian probability of x given a mean mu and</span>
<span class="sd">    standard deviation sigma.</span>

<span class="sd">    Args</span>
<span class="sd">        x: Number or np.array of theoretical amplitudes</span>
<span class="sd">        mu: Number or list or np.array of means.</span>
<span class="sd">            Needs to be same dimensions as x, or a scalar.</span>
<span class="sd">        sigma: Number or list or np.array of standard deviations.</span>
<span class="sd">            Needs to be same dimensions as x, or a scalar.</span>

<span class="sd">    Returns</span>
<span class="sd">        float/np.array of probabilities.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Avoid nan overflows for 0 errors, make the error very small to get a large number</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)):</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="k">elif</span> <span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">gaussian</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gaussian_cdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Gaussian Cumulative Distribution Function</span>

<span class="sd">    Calculates the Gaussian CDF of x given a mean mu and standard</span>
<span class="sd">    deviation sigma.</span>

<span class="sd">    Args</span>
<span class="sd">        x: Number or np.array of theoretical amplitudes</span>
<span class="sd">        mu: Number or list or np.array of means. Needs to be same</span>
<span class="sd">                dimensions as x, or a scalar.</span>
<span class="sd">        sigma: Number or list or np.array of standard deviations. Needs</span>
<span class="sd">                to be same dimensions as x, or a scalar.</span>

<span class="sd">    Returns</span>
<span class="sd">        float/np.array of CDF values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Avoid nan overflows for 0 errors, make the error very small to get a large number</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)):</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="k">elif</span> <span class="n">sigma</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">_SMALL_NUMBER</span>
    <span class="k">return</span> <span class="n">gaussian</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ratio_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">,</span> <span class="n">corr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Ratio Probability</span>

<span class="sd">    Calculates the Ratio pdf (D. Hinkley, On the ratio of two correlated</span>
<span class="sd">    normal random variables, 1969, Biometrika vol 56 pp 635-639).</span>

<span class="sd">    Given Z = X/Y and means mu_x, mu_y and standard deviation sigma_x and</span>
<span class="sd">    sigma_y. The pdf is normalised.</span>

<span class="sd">    Args</span>
<span class="sd">        z: Number or numpy array of theoretical amplitudes</span>
<span class="sd">        mu_x: Number or list or numpy array of means. Needs to be same</span>
<span class="sd">                dimensions as z, or a scalar.</span>
<span class="sd">        mu_y: Number or list or numpy array of means. Needs to be same</span>
<span class="sd">                dimensions as z, or a scalar.</span>
<span class="sd">        sigma_x: Number or list or numpy array of standard deviations.</span>
<span class="sd">                Needs to be same dimensions as z, or a scalar.</span>
<span class="sd">        sigma_y: Number or list or numpy array of standard deviations.</span>
<span class="sd">                Needs to be same dimensions as z, or a scalar.</span>

<span class="sd">    Returns</span>
<span class="sd">        float/np.array of probabilities</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set to prevent numpy warnings</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="c1"># Expand parameters</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mu_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mu_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mu_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mu_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mu_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">mu_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sigma_x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sigma_y</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Calculate some coefficients</span>
    <span class="n">z_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">sigma_x_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_x</span><span class="p">)</span>
    <span class="n">sigma_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_x</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">)</span>
    <span class="n">sigma_y_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_y</span><span class="p">,</span> <span class="n">sigma_y</span><span class="p">)</span>
    <span class="n">mu_x_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">z_2</span><span class="p">,</span> <span class="n">sigma_x_2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">corr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">sigma_xy</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">sigma_y_2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">z_2</span><span class="p">,</span> <span class="n">sigma_x_2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">/</span><span class="n">sigma_y_2</span><span class="p">)</span>
    <span class="n">a_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">sigma_x_2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">corr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sigma_x_2</span><span class="p">,</span> <span class="n">sigma_xy</span><span class="p">))</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">sigma_y_2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">mu_x_2</span><span class="p">,</span> <span class="n">sigma_x_2</span><span class="p">)</span> <span class="o">+</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_y</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">),</span> <span class="n">sigma_y_2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">corr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">-=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">corr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">mu_x</span><span class="p">,</span> <span class="n">mu_y</span><span class="p">),</span> <span class="n">sigma_xy</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">a_2</span><span class="p">)),</span>
                         <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">corr</span><span class="o">*</span><span class="n">corr</span><span class="p">)</span> <span class="o">*</span> <span class="n">a_2</span><span class="p">)))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span>
                  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_xy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_2</span><span class="p">))))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">gaussian_cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">corr</span><span class="o">*</span><span class="n">corr</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
                     <span class="n">gaussian_cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">corr</span><span class="o">*</span><span class="n">corr</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">corr</span><span class="o">*</span><span class="n">corr</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">sigma_xy</span><span class="p">,</span> <span class="n">a_2</span><span class="p">)),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">corr</span><span class="o">*</span><span class="n">corr</span><span class="p">))))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Clear arrays and force a garbage collection to free up memory</span>
    <span class="k">del</span> <span class="n">z_2</span>
    <span class="k">del</span> <span class="n">sigma_x_2</span>
    <span class="k">del</span> <span class="n">sigma_xy</span>
    <span class="k">del</span> <span class="n">sigma_y_2</span>
    <span class="k">del</span> <span class="n">mu_x_2</span>
    <span class="k">del</span> <span class="n">a</span>
    <span class="k">del</span> <span class="n">b</span>
    <span class="k">del</span> <span class="n">c</span>
    <span class="k">del</span> <span class="n">d</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">p</span>


<span class="k">def</span> <span class="nf">beta_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Beta Probability</span>

<span class="sd">    Calculates the Beta pdf for X given shape parameters a and b.</span>
<span class="sd">    Uses scipy.stats.beta.pdf docstring.</span>

<span class="sd">    Args</span>
<span class="sd">        x: Number or numpy object.</span>
<span class="sd">        a: Number or list or numpy object of first shape parameter.</span>
<span class="sd">        b: Number or list or numpy object of second shape parameter.</span>

<span class="sd">    Returns</span>
<span class="sd">        np.array of probabilities</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">heaviside</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the heaviside step function.</span>

<span class="sd">    The heaviside step function is defined as:</span>
<span class="sd">        H(x) = 0   x &lt; 0</span>
<span class="sd">        H(x) = 0.5 x = 0</span>
<span class="sd">        H(x) = 1   x &gt; 0</span>

<span class="sd">    Args:</span>
<span class="sd">        x: float/np.array - array or float of x values</span>

<span class="sd">    Returns:</span>
<span class="sd">        float/np.array - array of heaviside values for x values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dkl</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">,</span> <span class="n">ln_probability_q</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Kullback-Liebler divergence for two distributions, p</span>
<span class="sd">    and q</span>

<span class="sd">    Args</span>
<span class="sd">        ln_probability_p: LnPDF - First distribution (p)</span>
<span class="sd">        ln_probability_q: LnPDF - Second distribution (q)</span>

<span class="sd">    Keyword Args</span>
<span class="sd">        dV: float value for the Monte Carlo integration volume element</span>
<span class="sd">            (V/N)</span>

<span class="sd">    Returns</span>
<span class="sd">        float - Kullback-Liebler divergence estimate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">,</span> <span class="n">LnPDF</span><span class="p">):</span>
        <span class="n">ln_probability_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_probability_q</span><span class="p">,</span> <span class="n">LnPDF</span><span class="p">):</span>
        <span class="n">ln_probability_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_probability_q</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">dkl</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">ln_probability_q</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">dV</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">ln_probability_p</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">ln_probability_p</span> <span class="o">=</span> <span class="n">ln_probability_p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="n">ln_probability_p</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ln_probability_q</span> <span class="o">=</span> <span class="n">ln_probability_q</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="n">ln_probability_q</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">probability_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">)</span>
    <span class="c1"># Normalise PDF p</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probability_p</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span>
    <span class="n">ln_probability_p</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">probability_p</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="c1"># Normalise PDF q</span>
    <span class="n">probability_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_probability_q</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probability_q</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span>
    <span class="n">ln_probability_q</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">probability_p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span>
                  <span class="n">ln_probability_q</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">*</span><span class="n">probability_p</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">*</span> <span class="n">dV</span>


<span class="k">def</span> <span class="nf">ln_marginalise</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marginalise the pdf from the log pdf input</span>

<span class="sd">    Marginalises the pdf given a dV, without the dV the normalisation is</span>
<span class="sd">    only proportional to the normalised marginalised distribution.</span>

<span class="sd">    Args</span>
<span class="sd">        pdf: np.array/LnPDF - array or object that can be multiplied by dV</span>


<span class="sd">    Optional Args</span>
<span class="sd">        axis: integer - axis over which to marginalise [default = 0]</span>
<span class="sd">        dV: float - volume element in marginalisation, default value is</span>
<span class="sd">                 1.0 giving a proportional marginalised distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">        np.array - marginalised distribtion over axis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">LnPDF</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_marginalise</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_marginalise</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="c1"># scale and then marginalise:</span>
    <span class="n">ln_scale</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Probably shouldn&#39;t be marginalising over the last parameter</span>
        <span class="k">return</span> <span class="n">ln_pdf</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="n">ln_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="c1"># if axis == 0:</span>
        <span class="c1">#     # Get consistency with c code</span>
        <span class="c1">#     ln_pdf = np.array(ln_pdf)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">+</span><span class="n">ln_scale</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span> <span class="o">-</span> <span class="n">ln_scale</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">ln_normalise</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalise the pdf the pdf from the log pdf input.</span>

<span class="sd">    Normalises the pdf given a dV without the dV the normalisation is</span>
<span class="sd">    only proportional to the normalised distribution.</span>

<span class="sd">    Args</span>
<span class="sd">        pdf: Object that can be multiplied by dV (numpy array/matrix or PDF object)</span>

<span class="sd">    Optional Args</span>
<span class="sd">        dV: float - volume element in normalisation, default value is</span>
<span class="sd">                 1.0 giving a proportional normalised distribution.</span>
<span class="sd">    Returns</span>
<span class="sd">        np.array - normalised distribtion</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Incorrect shape&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">normalised_ln_pdf</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_normalise</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normalised_ln_pdf</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_normalise</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">normalised_ln_pdf</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="c1"># scale and then marginalise:</span>
    <span class="n">ln_scale</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="o">-</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
        <span class="n">ln_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="n">ln_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">+</span><span class="n">ln_scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">dV</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span> <span class="o">-</span> <span class="n">ln_scale</span>
    <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="mi">1</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ln_pdf</span><span class="p">])</span>
    <span class="c1"># ln_probability_scale_factor is automatically included in normalisation</span>
    <span class="k">return</span> <span class="n">ln_pdf</span> <span class="o">-</span> <span class="n">ln_n</span>


<span class="k">def</span> <span class="nf">model_probabilities</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the model probabilities for a discrete set of models using the</span>
<span class="sd">    ln_bayesian_evidences, provided as args.</span>

<span class="sd">    e.g. to compare between DC and MT:</span>

<span class="sd">        pDC,pMT=model_probabilities(dc_ln_bayesian_evidence,mt_ln_bayesian_evidence)</span>

<span class="sd">    Args</span>
<span class="sd">        floats - ln_bayesian_evidence for each model type</span>

<span class="sd">    Returns</span>
<span class="sd">        tuple: Tuple of the normalised model probabilities for the corresponding</span>
<span class="sd">            ln_bayesian_evidence inputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_LnBE</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">output_model_probabilities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ln_bayesian_evidence</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">max_LnBE</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">max_LnBE</span><span class="p">,</span> <span class="n">ln_bayesian_evidence</span><span class="p">])</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ln_bayesian_evidence</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_bayesian_evidence</span><span class="o">-</span><span class="n">max_LnBE</span><span class="p">)</span>
        <span class="n">output_model_probabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">+=</span> <span class="n">p</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">model_probability</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_model_probabilities</span><span class="p">):</span>
        <span class="n">output_model_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_probability</span><span class="o">/</span><span class="n">norm</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output_model_probabilities</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dkl_estimate</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Kullback-Leibeler divergence for the ln_pdf from the</span>
<span class="sd">    prior distribution.</span>

<span class="sd">    Assumes that the moment tensor prior is uniform in the sampling</span>
<span class="sd">    and that is the form that the PDFs have been evaluated in.</span>

<span class="sd">    Args</span>
<span class="sd">        ln_pdf: input LnPDF object</span>
<span class="sd">        V: float value for the Volume of the sample space for Monte</span>
<span class="sd">            Carlo delta V and prior estimates</span>
<span class="sd">        N: integer number of tried samples</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dV</span> <span class="o">=</span> <span class="n">V</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="c1"># Doesnt use dkl function as can be simplified to reduce calculation</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">LnPDF</span><span class="p">):</span>
        <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">dkl_uniform</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">V</span><span class="p">,</span> <span class="n">dV</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">ln_pdf</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">ln_pdf</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">-</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
    <span class="c1"># Normalise PDF</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span>
    <span class="n">ln_pdf</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">pdf</span> <span class="o">/=</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dV</span>


<span class="k">class</span> <span class="nc">LnPDF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LnPDF object, to allow arithmetic operations on the pdf</span>

<span class="sd">    A simple object containing a pdf and several methods for acting on the pdf.</span>
<span class="sd">    _ln_pdf is a numpy matrix containing the natural logarithm of the pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln_pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;LnPDF Initialisation</span>

<span class="sd">        Initialises the LnPDF object.</span>

<span class="sd">        Optional Args</span>
<span class="sd">            ln_pdf:[None] numpy array/matrix or list containing log pdf samples</span>
<span class="sd">            pdf:[None] numpy array/matrix or list containing pdf samples</span>
<span class="sd">            dV:[1] default volume element for normalisation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Possibly good to add initialisation size arg for LnPDF,</span>
        <span class="c1"># initSize=(1,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">ln_pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_ln_pdf</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pdf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_ln_pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pdf</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dV</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dv</span><span class="p">(</span><span class="n">dV</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dV</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln_pdf</span><span class="p">,</span> <span class="n">dV</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ln_pdf</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dv</span><span class="p">(</span><span class="n">dV</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__getattr__(y) &lt;==&gt; x.y&quot;&quot;&quot;</span>
        <span class="c1"># Handles cases not picked up by __getattribute__</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the length of ln_pdf</span>

<span class="sd">        Returns</span>
<span class="sd">            int - length of ln_pdf (axis=-1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__repr__() &lt;==&gt; repr(x)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__getitem__(index) &lt;==&gt; x[index]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__getslice__(i, j) &lt;==&gt; x[i:j]&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">__getslice__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__setitem__(index, val) &lt;==&gt; x[index] = val&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setslice__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__setslice__(i, j, val) &lt;==&gt; x[i, j] = val&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">__setslice__</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cmp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">operator_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base comparison function.</span>

<span class="sd">        Args</span>
<span class="sd">            other: object - object for comparison</span>
<span class="sd">            operator_func: func - function from the operator module to compare using</span>

<span class="sd">        Returns:</span>
<span class="sd">            boolean: result of the comparison</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">operator_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">operator_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__lt__(y) &lt;==&gt; x &lt; y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__lt__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__gt__(y) &lt;==&gt; x &gt; y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__gt__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__le__(y) &lt;==&gt; x &lt;= y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__le__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__ge__(y) &lt;==&gt; x &gt;= y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__ge__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__eq__(y) &lt;==&gt; x == y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__ne__(y) &lt;==&gt; x != y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmp</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__ne__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_arithmetic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">arithmetic_func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base comparison function.</span>

<span class="sd">        Args</span>
<span class="sd">            other: object - object for comparison</span>
<span class="sd">            operator_func: func - function from the operator module to compare using</span>

<span class="sd">        Returns:</span>
<span class="sd">            boolean: result of the comparison</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dV</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dV</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">=</span><span class="n">arithmetic_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Incorrect dV, should match between self and other&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">=</span><span class="n">arithmetic_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__mul__(y) &lt;==&gt; x*y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__div__(y) &lt;==&gt; x/y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__div__(y) &lt;==&gt; x/y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__div__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__add__(y) &lt;==&gt; x+y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__add__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__sub__(y) &lt;==&gt; x-y&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__rsub__(y) &lt;==&gt; y-x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">-</span><span class="n">other</span><span class="p">)</span><span class="o">*-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__radd__(y) &lt;==&gt; y+x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">+</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__rmul__(y) &lt;==&gt; y*x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">*</span><span class="n">other</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__rdiv__(2) &lt;==&gt; 2/x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">=</span><span class="p">(</span><span class="n">other</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rtruediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__rdiv__(2) &lt;==&gt; 2/x&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rdiv__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x.__abs__() &lt;==&gt; abs(x)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert pdf to float</span>

<span class="sd">        Returns</span>
<span class="sd">            Converted LnPDF to float (if a unit object, else error)</span>

<span class="sd">        Raises</span>
<span class="sd">            TypeError: array not length 1 so cannot be converted to a scalar.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">argmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the index of maximum value over an axis</span>

<span class="sd">        Returns the indices of the maximum values from the pdf over the</span>
<span class="sd">        given axis. If the axis is set to -1 returns the index of the</span>
<span class="sd">        maximum value over the marginalised pdf.</span>

<span class="sd">        Optional Args</span>
<span class="sd">            axis: int - axis over which to find the argmax [default=1]</span>

<span class="sd">        Returns</span>
<span class="sd">            np.array - array of indices to maximum values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">axis</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the maximum values over a given axis</span>

<span class="sd">        Returns the maximum values from the LnPDF over the given axis.</span>
<span class="sd">        If the axis is set to -1 returns the maximum value over the</span>
<span class="sd">        marginalised pdf.</span>

<span class="sd">        Optional Args</span>
<span class="sd">            axis: int - axis over which to find the argmax [default=1]</span>

<span class="sd">        Returns</span>
<span class="sd">            np.array - array of maximum values.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">axis</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_set_dv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dV</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private Function to set dV value&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dV</span> <span class="o">=</span> <span class="n">dV</span>

    <span class="k">def</span> <span class="nf">_set_ln_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln_pdf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Private Function to set _ln_pdf value&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the marginalised pdf for outputting.</span>

<span class="sd">        Optional Args</span>
<span class="sd">            normalise: bool - flag to normalise the PDF before</span>
<span class="sd">                    outputting [default = True]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">()</span><span class="o">.</span><span class="n">normalise</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error running cython code&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">C_EXTENSION_FALLBACK_LOG_MSG</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="mf">100000.</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the non-zero indices of the pdf</span>

<span class="sd">        Returns the non zero indices of the marginalised pdf.</span>

<span class="sd">        Samples with probability less than n_samples*discard of the max</span>
<span class="sd">        probability can be discarded.</span>

<span class="sd">        Optional Args</span>
<span class="sd">            discard: float - discard scale [default = 100000.]</span>
<span class="sd">            n_samples: integer - number of samples generated [default = 0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">m_val</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="n">n_samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">discard</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">m_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">discard</span><span class="o">*</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">ln_pdf</span> <span class="o">&gt;</span> <span class="n">m_val</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Normalise the pdf object</span>

<span class="sd">        Optional Args</span>
<span class="sd">            dV: float - update the object&#39;s dV value.</span>

<span class="sd">        Returns</span>
<span class="sd">            LnPDF object with normalised pdf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dV</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dv</span><span class="p">(</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">ln_normalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">marginalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Marginalise the pdf object over a given axis</span>

<span class="sd">        Optional Args</span>
<span class="sd">            axis: integer - axis over which to marginalise [default = 0]</span>
<span class="sd">            dV: float - update the object&#39;s dV value.</span>

<span class="sd">        Returns</span>
<span class="sd">            LnPDF object with marginalised pdf.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dV</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dv</span><span class="p">(</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">ln_marginalise</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dV</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append values to pdf</span>

<span class="sd">        Args</span>
<span class="sd">            other: LnPDF/np.array - Object to append to ln_pdf</span>

<span class="sd">        Optional Args</span>
<span class="sd">            axis: integer - axis over which to append [default = 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_ln_pdf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dV</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">dV</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">other</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dV</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dV</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also Cython functions:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="c"># cython: infer_types=True</span>
<span class="c">#define NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION</span>

<span class="c"># **Restricted:  For Non-Commercial Use Only** </span>
<span class="c"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c"># and non-commercially funded academic research purposes.</span>
<span class="c">#</span>
<span class="c"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>

<span class="k">cimport</span> <span class="nn">cython</span>
<span class="k">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="k">from</span> <span class="nn">cython.view</span> <span class="k">cimport</span> <span class="n">array</span> <span class="k">as</span> <span class="n">cvarray</span>
<span class="k">from</span> <span class="nn">cpython</span> <span class="k">cimport</span> <span class="nb">bool</span>
<span class="k">import</span> <span class="nn">unittest</span>
<span class="c"># DTYPE=np.float64</span>
<span class="c"># ctypedef np.float64_t DTYPE_t</span>
<span class="k">ctypedef</span> <span class="n">double</span> <span class="n">DTYPE_t</span>
<span class="k">ctypedef</span> <span class="nb">long</span> <span class="nb">long</span> <span class="n">LONG</span>
<span class="c"># ctypedef long long</span>
<span class="k">from</span> <span class="nn">libc.stdlib</span> <span class="k">cimport</span> <span class="n">rand</span><span class="p">,</span> <span class="n">RAND_MAX</span>
<span class="cp">IF</span> <span class="n">UNAME_SYSNAME</span> <span class="o">==</span> <span class="s">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">HUGE_VAL</span> <span class="k">as</span> <span class="n">inf</span>
<span class="cp">ELSE</span><span class="p">:</span>
    <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">INFINITY</span> <span class="k">as</span> <span class="n">inf</span>
    <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">fmax</span>
    <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">fmin</span>
    <span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">erf</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sqrt</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">exp</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">log</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">fabs</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">cos</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">sin</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">M_PI</span> <span class="k">as</span> <span class="n">pi</span>
<span class="k">from</span> <span class="nn">libc.math</span> <span class="k">cimport</span> <span class="n">M_SQRT2</span> <span class="k">as</span> <span class="n">sqrt2</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">RAND_MAX_D</span><span class="o">=&lt;</span><span class="n">DTYPE_t</span><span class="o">&gt;</span> <span class="n">RAND_MAX</span>

<span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">cutoff</span><span class="o">=</span><span class="mf">0.0</span> <span class="c">#Ratio PDF cutoff to approximate as Gaussian - improve calculation speed at the expense of some accuracy</span>
<span class="c">#corresponds to the Percentage error in the denominator as this governs the deviation of the ratio PDF from the Gaussian</span>
<span class="c"># 0.1 seems good by eye, little deviation over a range of percentage unc in x</span>

<span class="c">#cdef bool bc=True</span>

<span class="cp">IF</span> <span class="n">UNAME_SYSNAME</span> <span class="o">==</span> <span class="s">&quot;Windows&quot;</span><span class="p">:</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">erf</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
        <span class="c"># constants</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a1</span> <span class="o">=</span>  <span class="mf">0.254829592</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.284496736</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a3</span> <span class="o">=</span>  <span class="mf">1.421413741</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.453152027</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">a5</span> <span class="o">=</span>  <span class="mf">1.061405429</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">p</span>  <span class="o">=</span>  <span class="mf">0.3275911</span>
        <span class="c"># Save the sign of x</span>
        <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">sign</span> <span class="o">=</span> <span class="mf">1</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">fabs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c"># A&amp;S formula 7.1.26</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">t</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(((((</span><span class="n">a5</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">a4</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">a3</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">a1</span><span class="p">)</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sign</span><span class="o">*</span><span class="n">y</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">cpdef</span> <span class="nf">ln_marginalise</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,:]</span> <span class="n">ln_p</span><span class="p">):</span>
        <span class="c">#cdefs</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:]</span> <span class="n">Ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">wmax</span><span class="p">))</span> 
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">scale</span><span class="p">,</span><span class="nf">p</span>
        <span class="k">if</span> <span class="n">vmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
            <span class="n">Ln_P</span><span class="o">=</span><span class="n">ln_p</span><span class="p">[</span><span class="mf">0</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">scale</span><span class="o">=-</span><span class="n">inf</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;</span><span class="n">scale</span><span class="p">:</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">scale</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">if</span> <span class="n">scale</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
                <span class="n">Ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Ln_P</span><span class="p">)</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">cpdef</span> <span class="nf">ln_normalise</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">w</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">scale</span><span class="o">=-</span><span class="n">inf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>            
            <span class="k">if</span> <span class="n">scale</span><span class="o">&lt;</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]:</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scale</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">scale</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">N</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span><span class="o">*</span><span class="n">dV</span>
        <span class="n">N</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">-</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">-=</span><span class="n">N</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="nf">fmax</span><span class="p">(</span><span class="n">double</span> <span class="n">x</span><span class="p">,</span><span class="n">double</span> <span class="n">y</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span><span class="n">y</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span> 
<span class="cp">ELSE</span><span class="p">:</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">cpdef</span> <span class="nf">ln_marginalise</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,:]</span> <span class="n">ln_p</span><span class="p">):</span>
        <span class="c">#cdefs</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:]</span> <span class="n">Ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">wmax</span><span class="p">))</span> 
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">scale</span><span class="p">,</span><span class="nf">p</span>
        <span class="k">if</span> <span class="n">vmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
            <span class="n">Ln_P</span><span class="o">=</span><span class="n">ln_p</span><span class="p">[</span><span class="mf">0</span><span class="p">,:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
                <span class="n">p</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">scale</span><span class="o">=-</span><span class="n">inf</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">])</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">fmin</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scale</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">scale</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
                <span class="n">Ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Ln_P</span><span class="p">)</span>

    <span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">cpdef</span> <span class="nf">ln_normalise</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">w</span>
        <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">scale</span><span class="o">=-</span><span class="n">inf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
        <span class="n">scale</span><span class="o">=</span><span class="n">fmin</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="mf">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">N</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span><span class="o">*</span><span class="n">dV</span>
        <span class="n">N</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">-</span><span class="n">fabs</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">-=</span><span class="n">N</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">erf_inv_approx</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">t</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># // Abramowitz and Stegun formula 26.2.23.</span>
    <span class="c"># // The absolute value of the error should be less than 4.5 e-4.</span>
    <span class="k">return</span> <span class="n">t</span> <span class="o">-</span> <span class="p">((</span><span class="mf">0.010328</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mf">0.802853</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mf">2.515517</span><span class="p">)</span><span class="o">/</span><span class="p">(((</span><span class="mf">0.001308</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mf">0.189269</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1.432788</span><span class="p">)</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span>  <span class="nf">erf_inv</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">p</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">erf_inv_approx</span><span class="p">(</span> <span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">erf_inv_approx</span><span class="p">(</span> <span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">p</span><span class="p">))</span> <span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">gaussian_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">mu</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">s</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="p">))</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="p">))</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">gaussian_cdf</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">mu</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">s</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">erf</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">sqrt2</span><span class="p">)))</span>

<span class="c">#</span>
<span class="c"># Basic PDFs</span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">pol_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">s</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c"># print x,s,i,0.5*((1-i)*(1+erf(x/(sqrt2*s)))+i*(1+erf(-x/(sqrt2*s))))</span>
    <span class="k">return</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="mf">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">s</span><span class="p">)))</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">s</span><span class="p">))))</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">pol_prob_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">p</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">n</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">i</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
       <span class="k">return</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">n</span>
    <span class="k">elif</span> <span class="n">x</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">p</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">ar_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">z</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">mux</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">muy</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">psy</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">sqrtpi</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">a</span><span class="p">,</span><span class="nf">b1</span><span class="p">,</span><span class="nf">b2</span><span class="p">,</span><span class="nf">c</span><span class="p">,</span><span class="nf">d1</span><span class="p">,</span><span class="nf">d2</span><span class="p">,</span><span class="nf">f1</span><span class="p">,</span><span class="nf">f2</span><span class="p">,</span><span class="nf">sx</span><span class="p">,</span><span class="nf">sy</span>
    <span class="k">if</span> <span class="n">psy</span><span class="o">&lt;</span><span class="n">cutoff</span><span class="p">:</span>
        <span class="n">a</span><span class="o">=</span><span class="n">fabs</span><span class="p">(</span><span class="n">mux</span><span class="o">/</span><span class="n">muy</span><span class="p">)</span>
        <span class="n">sx</span><span class="o">=</span><span class="n">a</span><span class="o">*</span><span class="n">sqrt</span><span class="p">((</span><span class="n">psx</span><span class="o">*</span><span class="n">psx</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">psy</span><span class="o">*</span><span class="n">psy</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">gaussian_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">sx</span><span class="p">)</span><span class="o">+</span><span class="n">gaussian_pdf</span><span class="p">(</span><span class="o">-</span><span class="n">z</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">sx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sx</span><span class="o">=</span><span class="n">psx</span><span class="o">*</span><span class="n">fabs</span><span class="p">(</span><span class="n">mux</span><span class="p">)</span>
        <span class="n">sy</span><span class="o">=</span><span class="n">psy</span><span class="o">*</span><span class="n">fabs</span><span class="p">(</span><span class="n">muy</span><span class="p">)</span>
        <span class="n">a</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span><span class="p">)</span><span class="o">+</span><span class="mf">1</span><span class="o">/</span><span class="p">(</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span><span class="p">))</span>
        <span class="n">b1</span><span class="o">=</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span><span class="p">)</span><span class="o">+</span><span class="n">muy</span><span class="o">/</span><span class="p">(</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span><span class="p">)</span>
        <span class="n">b2</span><span class="o">=-</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span><span class="p">)</span><span class="o">+</span><span class="n">muy</span><span class="o">/</span><span class="p">(</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span><span class="p">)</span>
        <span class="n">c</span><span class="o">=</span><span class="n">mux</span><span class="o">*</span><span class="n">mux</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span><span class="p">)</span><span class="o">+</span><span class="n">muy</span><span class="o">*</span><span class="n">muy</span><span class="o">/</span><span class="p">(</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span><span class="p">)</span>
        <span class="n">d1</span><span class="o">=</span><span class="n">exp</span><span class="p">((</span><span class="n">b1</span><span class="o">*</span><span class="n">b1</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
        <span class="n">f1</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="n">b1</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">a</span><span class="p">)))</span>
        <span class="n">d2</span><span class="o">=</span><span class="n">exp</span><span class="p">((</span><span class="n">b2</span><span class="o">*</span><span class="n">b2</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
        <span class="n">f2</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1</span><span class="o">+</span><span class="n">erf</span><span class="p">(</span><span class="n">b2</span><span class="o">/</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">a</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">b1</span><span class="o">*</span><span class="n">d1</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sqrtpi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">f1</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">+</span><span class="mf">2</span><span class="o">/</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">sx</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span><span class="o">/</span><span class="mf">2</span><span class="p">)</span><span class="o">+</span><span class="n">b2</span><span class="o">*</span><span class="n">d2</span><span class="o">/</span><span class="p">(</span><span class="n">sx</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sqrtpi</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">f2</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Station Loops</span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_polarity_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="c"># print &#39;===========&#39;,ipmax,umax</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
            <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="c"># print a[u*vmax*kmax+v*kmax+k],mt[k*wmax+w],a[u*vmax*kmax+v*kmax+k]*mt[k*wmax+w]</span>
        <span class="c"># print &#39;x&#39;,x</span>
        <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
        <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="c"># print &#39;P&#39;,ln_P[index]</span>

        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_polarity_probability_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">positive_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">negative_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
            <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>               <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
        <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_ar_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="c"># print &#39;---------&#39;</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
        <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
            <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
        <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
        <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="c"># print ln_P[index]</span>
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_combined_polarity_ar_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">uarmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmin</span><span class="o">=</span><span class="n">umax</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmax</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="k">if</span> <span class="n">umax</span><span class="o">&gt;</span><span class="n">uarmax</span><span class="p">:</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">umax</span>
        <span class="n">utmin</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="c"># print &#39;----------&#39;</span>
        <span class="c"># print &#39;P&#39;,ln_P[index]</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">utmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">&lt;</span><span class="n">utmin</span><span class="p">:</span><span class="c">#both</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="c"># print &#39;b&#39;,x,mux,muy,sigma[u],z[u],psx[u],psy[u],&#39;=&#39;,ln_P[index]</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">umax</span><span class="p">:</span><span class="c">#Only AR</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="c"># print &#39;ar&#39;,mux,muy,z[u],psx[u],psy[u],&#39;=&#39;,ln_P[index]</span>
        <span class="k">else</span><span class="p">:</span> <span class="c">#only Pol</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="c"># print &#39;p&#39;,x,sigma[u],&#39;=&#39;,ln_P[index]</span>
        <span class="c"># print &#39;P&#39;,ln_P[index]</span>
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_combined_polarity_probability_ar_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">positive_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">negative_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">uarmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>    
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmin</span><span class="o">=</span><span class="n">umax</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmax</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="k">if</span> <span class="n">umax</span><span class="o">&gt;</span><span class="n">uarmax</span><span class="p">:</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">umax</span>
        <span class="n">utmin</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">utmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">&lt;</span><span class="n">utmin</span><span class="p">:</span><span class="c">#both</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">umax</span><span class="p">:</span><span class="c">#Only AR</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0.</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>   
        <span class="k">else</span><span class="p">:</span> <span class="c">#only Polprob</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>   
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_combined_all_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ay</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">z</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">positive_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">negative_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">psy</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">uarmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">uprobmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x1</span><span class="o">=</span><span class="mf">0.0</span>     
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmin</span><span class="o">=</span><span class="n">umax</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmax</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="k">if</span> <span class="n">umax</span><span class="o">&gt;</span><span class="n">uarmax</span><span class="p">:</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">umax</span>
        <span class="n">utmin</span><span class="o">=</span><span class="n">uarmax</span>
    <span class="k">if</span> <span class="n">uprobmax</span><span class="o">&lt;</span><span class="n">utmin</span><span class="p">:</span>
        <span class="n">utmin</span><span class="o">=</span><span class="n">uprobmax</span>
    <span class="k">if</span> <span class="n">uprobmax</span><span class="o">&gt;</span><span class="n">utmax</span><span class="p">:</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">uprobmax</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">utmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">&lt;</span><span class="n">utmin</span><span class="p">:</span><span class="c">#all</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">x1</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">x1</span><span class="o">+=</span><span class="n">a_prob</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">umax</span><span class="p">:</span><span class="c">#AR +pol?</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">uprobmax</span><span class="p">:</span><span class="c">#AR Only</span>
                <span class="n">mux</span><span class="o">=</span><span class="mf">0.</span>
                <span class="n">muy</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>   
            <span class="k">else</span><span class="p">:</span><span class="c">#AR +pol prob</span>
                <span class="n">x1</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">x1</span><span class="o">+=</span><span class="n">a_prob</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">uprobmax</span><span class="p">:</span><span class="c">#AR +pol?</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">umax</span><span class="p">:</span><span class="c">#AR Only</span>
                <span class="n">mux</span><span class="o">=</span><span class="mf">0.</span>
                <span class="n">muy</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>   
            <span class="k">else</span><span class="p">:</span><span class="c">#AR +pol prob</span>
                <span class="n">x1</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">mux</span><span class="o">+=</span><span class="n">ax</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="o">+=</span><span class="n">ay</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">,</span><span class="n">muy</span><span class="p">,</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span><span class="c">#Pol prob +pol?</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">uprobmax</span><span class="p">:</span><span class="c">#Pol Only</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>  
            <span class="k">else</span><span class="p">:</span><span class="c">#Pol +pol prob</span>
                <span class="n">x1</span><span class="o">=</span><span class="mf">0.</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">x1</span><span class="o">+=</span><span class="n">a_prob</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
                <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">station_combined_pol_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">a_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">positive_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">negative_probability</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">sigma</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">ipmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">v</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">umax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">uprobmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">vmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">kmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">w</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x1</span><span class="o">=</span><span class="mf">0.0</span>     
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmin</span><span class="o">=</span><span class="n">umax</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">utmax</span><span class="o">=</span><span class="n">uprobmax</span>
    <span class="k">if</span> <span class="n">umax</span><span class="o">&gt;</span><span class="n">uprobmax</span><span class="p">:</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">umax</span>
        <span class="n">utmin</span><span class="o">=</span><span class="n">uprobmax</span>
        <span class="n">utmax</span><span class="o">=</span><span class="n">uprobmax</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">utmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">&lt;</span><span class="n">utmin</span><span class="p">:</span><span class="c">#all</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">x1</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">mux</span><span class="o">=</span><span class="mf">0</span>
            <span class="n">muy</span><span class="o">=</span><span class="mf">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
                <span class="n">x1</span><span class="o">+=</span><span class="n">a_prob</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span><span class="o">+</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">&gt;=</span><span class="n">umax</span><span class="p">:</span><span class="c">#Pol prob</span>
            <span class="n">x1</span><span class="o">=</span><span class="mf">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x1</span><span class="o">+=</span><span class="n">a_prob</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_prob_pdf</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">negative_probability</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span><span class="c">#Pol </span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                <span class="n">x</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="o">*</span><span class="n">vmax</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">kmax</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ipmax</span><span class="o">==</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">pol_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">sigma</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>  
        <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">==-</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">return</span> 

<span class="c">#</span>
<span class="c"># Cython ln PDF loops</span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculates probability of a positive polarity</span>

<span class="sd">    Calculates the probability of a positive polarity observation given a theoretical amplitude X and a fractional uncertainty sigma. Handles zero uncertainty.</span>
<span class="sd">    The derivation of this pdf for the polarity observation can be seen in ###########. </span>

<span class="sd">    Cython handling for heavy lifting.</span>
<span class="sd">    Returns product across stations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">00</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_probability_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculates probability of a given amplitude giving an observed polarity probability</span>

<span class="sd">    Calculates the probability of a given polarity probability observation given a theoretical amplitude X and a fractional uncertainty sigma. Handles zero uncertainty.</span>
<span class="sd">    The derivation of this pdf for the polarity observation can be seen in ###########. </span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="c">## log(location_samples_multiplier) is  ln_P_loc_samples initialisation</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Calculates Amplitude Ratio Probability</span>

<span class="sd">    Calculates the Ratio pdf (D. Hinkley, On the ratio of two correlated normal random variables, 1969, Biometrika vol 56 pp 635-639).</span>
<span class="sd">    Given Z=X/Y and means mux, muy and standard deviation sigmax and sigmay. The pdf is normalised.</span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs    </span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>  <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Cython Combined ln PDF loops </span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_prob_combined_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_probability_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_probability_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_ar_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span>  <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="c"># print umax,uarmax</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="c"># if vmax==1:</span>
        <span class="c">#     ln_P[0*wmax+w]=location_samples_multiplier[0]</span>
        <span class="c">#     station_combined_polarity_ar_ln_pdf(&amp;a[0,0,0],&amp;ax[0,0,0],&amp;ay[0,0,0],&amp;mt[0,0],&amp;ln_P[0],&amp;z[0],&amp;sigma[0],&amp;incorrect_polarity_prob[0],&amp;psx[0],&amp;psy[0], ipmax, v, umax,uarmax,vmax,kmax,wmax, w, v*wmax+w)</span>
        <span class="c"># el</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="c"># print max_ln_p_loc</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_all_combined_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uprobmax</span><span class="o">=</span><span class="n">a_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample Pol Prob</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a_prob</span><span class="o">=</span><span class="n">a_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_all_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_all_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_combined_pol_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uprobmax</span><span class="o">=</span><span class="n">a_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample Pol Prob</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a_prob</span><span class="o">=</span><span class="n">a_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_pol_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_pol_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 

<span class="c">#</span>
<span class="c"># Cython ln PDF generating loops </span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span> <span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates probability of a positive polarity</span>

<span class="sd">    Calculates the probability of a positive polarity observation given a theoretical amplitude X and a fractional uncertainty sigma. Handles zero uncertainty.</span>
<span class="sd">    The derivation of this pdf for the polarity observation can be seen in ###########. </span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="c"># cdef Py_ssize_t wmax=mt.shape[1]#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span><span class="p">,</span><span class="nf">t</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">ok</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">test_mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_probability_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates probability of a given amplitude giving an observed polarity probability</span>

<span class="sd">    Calculates the probability of a given polarity probability observation given a theoretical amplitude X and a fractional uncertainty sigma. Handles zero uncertainty.</span>
<span class="sd">    The derivation of this pdf for the polarity observation can be seen in ###########. </span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span><span class="p">,</span><span class="nf">t</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">ok</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">test_mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>  
                <span class="n">station_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">ipmax</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_amplitude_ratio_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates Amplitude Ratio Probability</span>

<span class="sd">    Calculates the Ratio pdf (D. Hinkley, On the ratio of two correlated normal random variables, 1969, Biometrika vol 56 pp 635-639).</span>
<span class="sd">    Given Z=X/Y and means mux, muy and standard deviation sigmax and sigmay. The pdf is normalised.</span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs    </span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="c"># cdef Py_ssize_t wmax=mt.shape[1]#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span><span class="p">,</span><span class="nf">t</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">ok</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">test_mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">v</span><span class="p">,</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>            
                <span class="n">station_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span>  <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>   
                <span class="k">if</span>  <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="c">#</span>
<span class="c"># Cython Combined ln PDF generating loops </span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_prob_combined_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="c"># cdef Py_ssize_t wmax=mt.shape[1]#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span><span class="p">,</span><span class="nf">t</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">ok</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">test_mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_probability_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_probability_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_polarity_ar_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span> <span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="c"># cdef Py_ssize_t wmax=mt.shape[1]#MT samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span><span class="p">,</span><span class="nf">t</span>
    <span class="c"># cdef DTYPE_t[:,:,::1]  ln_P=np.zeros((umax,vmax,wmax)) </span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mux</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">muy</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">bool</span> <span class="nf">ok</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">test_mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">tmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>

    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_polarity_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">tmax</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_all_combined_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">z_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ax_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ay_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uprobmax</span><span class="o">=</span><span class="n">a_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample Pol Prob</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uarmax</span><span class="o">=</span><span class="n">ax_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample AR</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ax</span><span class="o">=</span><span class="n">ax_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">ay</span><span class="o">=</span><span class="n">ay_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a_prob</span><span class="o">=</span><span class="n">a_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">z</span><span class="o">=</span><span class="n">z_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psx</span><span class="o">=</span><span class="n">psx_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">psy</span><span class="o">=</span><span class="n">psy_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_all_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_all_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ax</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ay</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">z</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psx</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">psy</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uarmax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_combined_pol_ln_pdf_gen</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span> <span class="n">ln_P</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_arr</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mt</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">wmax</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">sigma_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_prob_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">positive_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">negative_probability_arr</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">incorrect_polarity_prob_arr</span><span class="p">,</span><span class="n">LONG</span><span class="o">*</span> <span class="n">n_tried</span><span class="p">,</span><span class="n">LONG</span> <span class="n">cutoff</span><span class="p">,</span> <span class="n">LONG</span><span class="o">*</span><span class="n">cut_ind</span><span class="p">,</span><span class="nb">bool</span> <span class="n">dc</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_P_loc_samples</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">location_samples_multiplier</span><span class="p">):</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">uprobmax</span><span class="o">=</span><span class="n">a_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample Pol Prob</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">tmax</span><span class="o">=</span><span class="n">wmax</span><span class="o">*</span><span class="mf">4</span><span class="c">#MT test samples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">ipmax</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a</span><span class="o">=</span><span class="n">a_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span><span class="n">a_prob</span><span class="o">=</span><span class="n">a_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">positive_probability</span><span class="o">=</span><span class="n">positive_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">negative_probability</span><span class="o">=</span><span class="n">negative_probability_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
    <span class="n">w</span><span class="o">=</span><span class="mf">0</span>
    <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">while</span> <span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span> <span class="ow">and</span> <span class="n">w</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">cutoff</span><span class="p">:</span>
            <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">w</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">&gt;=</span><span class="n">tmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">test_mt</span><span class="o">=</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">tmax</span><span class="p">)</span>
            <span class="n">t</span><span class="o">=</span><span class="mf">0</span>
        <span class="n">ok</span><span class="o">=</span><span class="bp">False</span>
        <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">max_ln_p_loc</span><span class="o">=-</span><span class="n">inf</span>
            <span class="c">#loc_samples_multiplier</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_pol_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> 
                <span class="n">max_ln_p_loc</span><span class="o">=</span><span class="n">fmax</span><span class="p">(</span><span class="n">max_ln_p_loc</span><span class="p">,</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">max_ln_p_loc</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p_loc</span><span class="p">)</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">])</span><span class="o">+</span><span class="n">max_ln_p_loc</span>
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">station_combined_pol_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">a_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">test_mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">positive_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">negative_probability</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">sigma</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span> <span class="n">ipmax</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">umax</span><span class="p">,</span><span class="n">uprobmax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">)</span> 
                <span class="k">if</span> <span class="n">ln_P</span><span class="p">[</span><span class="n">v</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">ok</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span>
                <span class="n">mt</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">wmax</span><span class="o">+</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">test_mt</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="n">w</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">t</span><span class="o">+=</span><span class="mf">1</span>
        <span class="n">n_tried</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">+=</span><span class="mf">1</span>
    <span class="n">cut_ind</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">wmax</span>

<span class="c">#</span>
<span class="c"># Python PDF calls (Polarity, Polarity Probability and Amplitude Ratios)</span>
<span class="c">#</span>

<span class="k">def</span> <span class="nf">polarity_ln_pdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">mt_arr</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span><span class="n">generate_samples</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">1000000000</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">mt_arr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="n">generate_samples</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>    
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">n_tried</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">cut_ind</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">if</span> <span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">!=</span><span class="n">vmax</span><span class="p">:</span>
        <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vmax</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mf">1</span>
    <span class="n">marginalised</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">marginalised</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">location_samples_multiplier</span><span class="o">=</span><span class="n">location_samples_multipliers</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P_loc_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">c_polarity_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cut_ind</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="c"># no non_zero samples</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],[],[],[],[],[]]),</span><span class="n">n_tried</span>
        <span class="k">elif</span> <span class="n">cut_ind</span><span class="o">!=</span><span class="n">wmax</span><span class="p">:</span>
            <span class="c">#ended prematurely</span>
            <span class="n">ln_P</span><span class="o">=</span><span class="n">ln_P</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
            <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mt</span><span class="p">),</span><span class="n">n_tried</span>  
    <span class="n">c_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">polarity_probability_ln_pdf</span><span class="p">(</span>  <span class="n">a</span><span class="p">,</span> <span class="n">mt_arr</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">,</span><span class="n">negative_probability</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]),</span><span class="n">generate_samples</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">1000000000</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">mt_arr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="n">generate_samples</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>  
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">if</span> <span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">!=</span><span class="n">vmax</span><span class="p">:</span>
        <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">location_samples_multiplier</span><span class="o">=</span><span class="n">location_samples_multipliers</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P_loc_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">n_tried</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">cut_ind</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span>  
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">c_polarity_probability_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">positive_probability</span><span class="p">,</span> <span class="n">negative_probability</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cut_ind</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="c"># no non_zero samples</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],[],[],[],[],[]]),</span><span class="n">n_tried</span>
        <span class="k">elif</span> <span class="n">cut_ind</span><span class="o">!=</span><span class="n">wmax</span><span class="p">:</span>
            <span class="c">#ended prematurely</span>
            <span class="n">ln_P</span><span class="o">=</span><span class="n">ln_P</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
            <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mt</span><span class="p">),</span><span class="n">n_tried</span>  
    <span class="n">c_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">positive_probability</span><span class="p">,</span> <span class="n">negative_probability</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">amplitude_ratio_ln_pdf</span><span class="p">(</span> <span class="n">z</span><span class="p">,</span> <span class="n">mt_arr</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ay</span><span class="p">,</span> <span class="n">psx</span><span class="p">,</span> <span class="n">psy</span><span class="p">,</span><span class="n">generate_samples</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">1000000000</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="nb">int</span> <span class="n">marginalised</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])):</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">mt_arr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">],</span><span class="n">generate_samples</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt_arr</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>    
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">if</span> <span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">!=</span><span class="n">vmax</span><span class="p">:</span>
        <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vmax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">location_samples_multiplier</span><span class="o">=</span><span class="n">location_samples_multipliers</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P_loc_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">n_tried</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">cut_ind</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span>  
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">c_amplitude_ratio_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">z</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ay</span><span class="p">,</span><span class="n">psx</span><span class="p">,</span><span class="n">psy</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cut_ind</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="c"># no non_zero samples</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],[],[],[],[],[]]),</span><span class="n">n_tried</span>
        <span class="k">elif</span> <span class="n">cut_ind</span><span class="o">!=</span><span class="n">wmax</span><span class="p">:</span>
            <span class="c">#ended prematurely</span>
            <span class="n">ln_P</span><span class="o">=</span><span class="n">ln_P</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
            <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mt</span><span class="p">),</span><span class="n">n_tried</span>  
    <span class="n">c_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">z</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ay</span><span class="p">,</span><span class="n">psx</span><span class="p">,</span><span class="n">psy</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log0test</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">log</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="o">==-</span><span class="n">inf</span>

<span class="k">def</span> <span class="nf">combined_ln_pdf</span><span class="p">(</span><span class="n">mt_arr</span><span class="p">,</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">generate_samples</span><span class="o">=</span><span class="mf">0</span><span class="p">,</span><span class="n">cutoff</span><span class="o">=</span><span class="mf">1000000000</span><span class="p">,</span><span class="n">dc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">marginalised</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">incorrect_polarity_prob</span> <span class="o">==</span> <span class="mf">0</span><span class="p">:</span>
        <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">])</span>
    <span class="n">generate_mts</span><span class="o">=</span><span class="bp">False</span>  
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="mf">0</span><span class="c">#Station Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="mf">0</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">kmax</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">umax</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">kmax</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">umax</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">kmax</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">umax</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">!=</span><span class="n">vmax</span><span class="p">:</span>
        <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">vmax</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">marginalised</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="n">vmax</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="n">generate_mts</span><span class="o">=</span><span class="bp">True</span>
        <span class="n">mt_arr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">kmax</span><span class="p">,</span><span class="n">generate_samples</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="o">=</span><span class="n">mt_arr</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">location_samples_multiplier</span><span class="o">=</span><span class="n">location_samples_multipliers</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P_loc_samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">location_samples_multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">n_tried</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">LONG</span> <span class="nf">cut_ind</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span>  
    <span class="c"># data preparation</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">a_polarity</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mt</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">error_polarity</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">error_polarity</span><span class="o">=</span><span class="n">error_polarity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">amplitude_ratio</span><span class="o">=</span><span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">percentage_error1_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">percentage_error2_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">a_polarity_prob</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">polarity_prob</span><span class="o">.</span><span class="n">dtype</span><span class="o">!=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
        <span class="n">polarity_prob</span><span class="o">=</span><span class="n">polarity_prob</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#</span>
    <span class="c">#Bounds checking</span>
    <span class="c">#</span>
    <span class="c">#Polarities</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for incorrect_polarity_prob.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of observations:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">error_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for polarity uncertainty.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">error_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of observations:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="c"># Amplitude ratios</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">!=</span><span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for a2_amplitude_ratio.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of observations and location samples:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for Amplitude ratio observations.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for Amplitude ratio uncertainty.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span>  <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for Amplitude ratio uncertainty.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="c">#Polarity Probabilities</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for incorrect_polarity_prob.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for polarity probability observations.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;Bounds Exception for polarity probability observations.</span><span class="se">\n</span><span class="s">Shape: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">incompatible with number of receivers:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span>
    <span class="c">#</span>
    <span class="c"># Call loop functions</span>
    <span class="c">#</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_all_combined_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_all_combined_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_combined_pol_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_combined_pol_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_polarity_ar_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_polarity_ar_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_polarity_prob_combined_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_polarity_prob_combined_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_polarity_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_polarity_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">error_polarity</span><span class="p">,</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_polarity_probability_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_polarity_probability_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mf">1</span><span class="p">],</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">generate_mts</span><span class="p">:</span>
            <span class="n">c_amplitude_ratio_ln_pdf_gen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">wmax</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="o">&amp;</span><span class="n">n_tried</span><span class="p">,</span><span class="n">cutoff</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cut_ind</span><span class="p">,</span><span class="n">dc</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_P</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="n">amplitude_ratio</span><span class="p">,</span><span class="n">mt</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span><span class="n">marginalised</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ln_P_loc_samples</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">location_samples_multiplier</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">generate_samples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cut_ind</span><span class="o">&lt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="c"># no non_zero samples</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[],[],[],[],[],[]]),</span><span class="n">n_tried</span>
        <span class="k">if</span> <span class="n">cut_ind</span><span class="o">!=</span><span class="n">wmax</span><span class="p">:</span>
            <span class="c">#ended prematurely</span>
            <span class="n">ln_P</span><span class="o">=</span><span class="n">ln_P</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
            <span class="n">mt</span><span class="o">=</span><span class="n">mt</span><span class="p">[:,:</span><span class="n">cut_ind</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mt</span><span class="p">),</span><span class="n">n_tried</span>  
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># Other functions </span>
<span class="c">#</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">combine_mu</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">mu1</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">mu2</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">s1</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">s2</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu1</span><span class="o">*</span><span class="n">s2</span><span class="o">*</span><span class="n">s2</span><span class="o">+</span><span class="n">mu2</span><span class="o">*</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">*</span><span class="n">s2</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">combine_s</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="n">s1</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">s2</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">s1</span><span class="o">*</span><span class="n">s2</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span><span class="o">+</span><span class="n">s2</span><span class="o">*</span><span class="n">s2</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">estimate_scale_mu_s</span><span class="p">(</span><span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">mu</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">y</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">mux</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">muy</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">psy</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">double</span> <span class="nf">sqrtpi</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">N</span><span class="p">,</span><span class="nf">sx</span><span class="p">,</span><span class="nf">sy</span><span class="p">,</span><span class="nf">z</span><span class="p">,</span><span class="nf">mu1</span><span class="p">,</span><span class="nf">mux3</span><span class="p">,</span><span class="nf">mux2</span><span class="p">,</span><span class="nf">sy_2</span><span class="p">,</span><span class="nf">sx_2</span><span class="p">,</span><span class="nf">s1_2</span><span class="p">,</span><span class="nf">mu1_2</span><span class="p">,</span><span class="nf">s1</span><span class="p">,</span><span class="nf">A</span><span class="p">,</span><span class="nf">B</span><span class="p">,</span><span class="nf">C</span>

    <span class="n">z</span><span class="o">=</span><span class="n">fabs</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">y</span><span class="p">)</span>
    <span class="n">mux</span><span class="o">=</span><span class="n">fabs</span><span class="p">(</span><span class="n">mux</span><span class="p">)</span>
    <span class="n">muy</span><span class="o">=</span><span class="n">fabs</span><span class="p">(</span><span class="n">muy</span><span class="p">)</span>
    <span class="n">sx</span><span class="o">=</span><span class="n">psx</span><span class="o">*</span><span class="n">mux</span>
    <span class="n">sy</span><span class="o">=</span><span class="n">psy</span><span class="o">*</span><span class="n">muy</span>
    <span class="n">sy_2</span><span class="o">=</span><span class="n">sy</span><span class="o">*</span><span class="n">sy</span>
    <span class="n">sx_2</span><span class="o">=</span><span class="n">sx</span><span class="o">*</span><span class="n">sx</span>
    <span class="n">mux2</span><span class="o">=</span><span class="n">mux</span><span class="o">*</span><span class="n">mux</span>
    <span class="n">mux3</span><span class="o">=</span><span class="n">mux</span><span class="o">*</span><span class="n">mux2</span>
    <span class="n">exp_muy</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">muy</span><span class="o">*</span><span class="n">muy</span><span class="o">/</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">sy_2</span><span class="p">))</span>
    <span class="n">s1</span><span class="o">=</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sy_2</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="n">sx_2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mux2</span><span class="p">))</span>
    <span class="n">s1_2</span><span class="o">=</span><span class="n">s1</span><span class="o">*</span><span class="n">s1</span>
    <span class="n">mu1</span><span class="o">=</span><span class="n">muy</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="n">mux</span>
    <span class="n">mu1_2</span><span class="o">=</span><span class="n">mu1</span><span class="o">*</span><span class="n">mu1</span>
    <span class="n">N</span><span class="o">=</span><span class="p">((</span><span class="n">sy_2</span><span class="o">*</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">mu1</span><span class="o">+</span><span class="n">sx_2</span><span class="o">*</span><span class="n">muy</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mux3</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sx_2</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">exp_muy</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sqrtpi</span><span class="o">*</span><span class="n">mux3</span><span class="o">*</span><span class="n">s1_2</span><span class="p">))</span>
    <span class="n">A</span><span class="o">=</span><span class="p">(</span><span class="n">sy_2</span><span class="o">*</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">mu1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mux3</span><span class="p">)</span>
    <span class="n">B</span><span class="o">=</span><span class="n">sx_2</span><span class="o">*</span><span class="n">muy</span><span class="o">/</span><span class="n">mux3</span>
    <span class="n">C</span><span class="o">=</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sx_2</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">exp_muy</span><span class="o">/</span><span class="p">(</span><span class="n">sqrtpi</span><span class="o">*</span><span class="n">mux3</span><span class="o">*</span><span class="n">s1_2</span><span class="p">)</span>
    <span class="c">#CYTHON POINTER ASSIGNMENT</span>
    <span class="n">mu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">sy_2</span><span class="o">*</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">s1_2</span><span class="o">+</span><span class="n">mu1_2</span><span class="p">)</span><span class="o">+</span><span class="n">sx_2</span><span class="o">*</span><span class="n">mu1</span><span class="o">*</span><span class="n">muy</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mux3</span><span class="o">*</span><span class="n">N</span><span class="p">)</span>
    <span class="n">s</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sy_2</span><span class="o">*</span><span class="p">(</span><span class="n">mu1_2</span><span class="o">*</span><span class="n">mu1</span><span class="o">+</span><span class="mf">3</span><span class="o">*</span><span class="n">mu1</span><span class="o">*</span><span class="n">s1_2</span><span class="p">)</span><span class="o">*</span><span class="n">mux</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="n">sx_2</span><span class="o">*</span><span class="p">(</span><span class="n">s1_2</span><span class="o">+</span><span class="n">mu1_2</span><span class="p">)</span><span class="o">*</span><span class="n">muy</span><span class="p">)</span><span class="o">/</span><span class="n">mux3</span><span class="o">+</span><span class="n">sqrt2</span><span class="o">*</span><span class="n">sx_2</span><span class="o">*</span><span class="n">sx_2</span><span class="o">*</span><span class="n">sy</span><span class="o">*</span><span class="n">exp_muy</span><span class="o">/</span><span class="p">(</span><span class="n">sqrtpi</span><span class="o">*</span><span class="n">mux3</span><span class="o">*</span><span class="n">mux2</span><span class="o">*</span><span class="n">s1_2</span><span class="p">))</span><span class="o">/</span><span class="n">N</span><span class="o">-</span><span class="n">mu</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">*</span><span class="n">mu</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">scale_estimator</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">y</span><span class="p">,</span>   <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mt2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mu1</span><span class="p">,</span><span class="nf">s1</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">muy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
                <span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+=</span><span class="n">a</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                <span class="n">estimate_scale_mu_s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mu1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">mu1</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">s1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">mu1</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">s1</span><span class="p">)</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">s1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">relative_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">x</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">y</span><span class="p">,</span>  <span class="n">DTYPE_t</span> <span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mt2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psx</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">psy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Amplitude Ratio Probability</span>

<span class="sd">    Calculates the Ratio pdf (D. Hinkley, On the ratio of two correlated normal random variables, 1969, Biometrika vol 56 pp 635-639).</span>
<span class="sd">    Given Z=X/Y and means mux, muy and standard deviation sigmax and sigmay. The pdf is normalised.</span>

<span class="sd">    Cython handling for heavy lifting.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#cdefs    </span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">mt1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">,</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mu1</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">s1</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">mux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> [<span class="p">::</span><span class="mf">1</span><span class="p">]</span><span class="n">muy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">))</span>
    <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
    <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
                <span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
                <span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+=</span><span class="n">a1</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+=</span><span class="n">a2</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">mt2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                <span class="n">estimate_scale_mu_s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mu1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s1</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">])</span>
                <span class="c"># print &#39;s&#39;,s1</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">mu1</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">s1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">mu1</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">s1</span><span class="p">)</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">s1</span><span class="p">)</span>
                <span class="c"># print mu[v,w],s[v,w]</span>
            <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]):</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=-</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">/</span><span class="n">y</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">mu</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">*</span><span class="n">mux</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">muy</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psx</span><span class="p">[</span><span class="n">u</span><span class="p">],</span><span class="n">psy</span><span class="p">[</span><span class="n">u</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">ln_prod</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">p</span><span class="p">):</span>
    <span class="c">#cdefs</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">Ln_P</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span>
    <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">Ln_P</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
            <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
                <span class="n">Ln_P</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Ln_P</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">ln_combine</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p_1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p_2</span><span class="p">):</span>
    <span class="k">assert</span>  <span class="n">ln_p_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">==</span>  <span class="n">ln_p_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ln_p_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ln_p_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ln_p_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">v</span><span class="p">,</span><span class="nf">w</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
            <span class="n">ln_p_1</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">ln_p_2</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_p_1</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">ln_multipliers</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">multipliers</span><span class="p">):</span>
    <span class="k">assert</span>  <span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span> <span class="o">==</span>  <span class="n">multipliers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">v</span><span class="p">,</span><span class="nf">w</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
            <span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">log</span><span class="p">(</span><span class="n">multipliers</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">ln_non_zero</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:]</span> <span class="n">ln_p</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">v</span>
    <span class="k">cdef</span> <span class="kt">int</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">non_zero</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">vmax</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ln_p</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="n">non_zero</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="mf">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">non_zero</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">ln_exp</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">DTYPE_t</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">ln_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">w</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">p</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">wmax</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
        <span class="n">p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">void</span> <span class="nf">c_ln_normalise</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_probability_p</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">dV</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">norm</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">max_ln_p</span><span class="o">=-</span><span class="n">inf</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">max_ln_p</span><span class="p">:</span> 
            <span class="n">max_ln_p</span><span class="o">=</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="n">norm</span><span class="o">+=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">max_ln_p</span><span class="p">)</span>
    <span class="n">norm</span><span class="o">*=</span><span class="n">dV</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-=</span><span class="n">log</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span><span class="o">+</span><span class="n">max_ln_p</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">c_dkl</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_probability_p</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_probability_q</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">dV</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">dkl</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">p</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span><span class="c">#Check no zeros in p </span>
            <span class="n">p</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">dkl</span><span class="o">+=</span><span class="n">p</span><span class="o">*</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="n">ln_probability_q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dkl</span><span class="o">*</span><span class="n">dV</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">dkl</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_probability_p</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_probability_q</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">n</span><span class="o">=</span><span class="n">ln_probability_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ln_probability_q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">!=</span><span class="n">ln_probability_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Input array sizes must be the same shape&#39;</span><span class="p">)</span>
    <span class="n">c_ln_normalise</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dV</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="n">c_ln_normalise</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_probability_q</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dV</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c_dkl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">ln_probability_q</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dV</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c">#Tested against MATLAB code</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">c_dkl_uniform</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="o">*</span><span class="n">ln_probability_p</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">V</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">dV</span><span class="p">,</span><span class="n">Py_ssize_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">dkl</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">p</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">ln_V</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;-</span><span class="n">inf</span><span class="p">:</span><span class="c">#Check no zeros in p </span>
            <span class="n">p</span><span class="o">=</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">dkl</span><span class="o">+=</span><span class="n">p</span><span class="o">*</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">p</span><span class="o">*</span><span class="n">ln_V</span>
    <span class="k">return</span> <span class="n">dkl</span><span class="o">*</span><span class="n">dV</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">dkl_uniform</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_probability_p</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">V</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">dV</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">n</span><span class="o">=</span><span class="n">ln_probability_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
    <span class="n">c_ln_normalise</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">dV</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c_dkl_uniform</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ln_probability_p</span><span class="p">[</span><span class="mf">0</span><span class="p">],</span><span class="n">V</span><span class="p">,</span><span class="n">dV</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c">#Tested against MATLAB code</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kr">inline</span> <span class="kt">DTYPE_t</span> <span class="nf">ranf</span><span class="p">()</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="n">DTYPE_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">/</span><span class="n">RAND_MAX_D</span><span class="p">)</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">randn</span><span class="p">()</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">erf_inv</span><span class="p">(</span><span class="n">ranf</span><span class="p">())</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">randomn</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span><span class="nb">int</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span><span class="p">,</span><span class="nf">j</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">x</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">j</span><span class="o">&lt;</span><span class="n">y</span><span class="p">:</span>
            <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">randn</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">R</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">rand_mt</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">R</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mf">6</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span><span class="p">,</span><span class="nf">j</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">N</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">j</span><span class="o">&lt;</span><span class="n">x</span><span class="p">:</span>
        <span class="n">N</span><span class="o">=</span><span class="mf">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="mf">6</span><span class="p">:</span>
            <span class="n">N</span><span class="o">+=</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="n">N</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="mf">6</span><span class="p">:</span>
            <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/=</span><span class="n">N</span>
    <span class="k">return</span> <span class="n">R</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">rand_dc</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">mt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">6</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">sj</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">ck</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">cs</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">sk</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">s2k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">ss</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">sh</span>
    <span class="k">for</span> <span class="n">j</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">j</span><span class="o">&lt;</span><span class="n">x</span><span class="p">:</span>
        <span class="c"># h=ranf()</span>
        <span class="c"># kappa=2*pi*ranf()</span>
        <span class="c"># sigma=pi*(ranf()-0.5)</span>
        <span class="n">h</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="n">kappa</span><span class="o">=</span><span class="mf">2</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ck</span><span class="o">=</span><span class="n">cos</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">=</span><span class="n">cos</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">sk</span><span class="o">=</span><span class="n">sin</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span>
        <span class="n">s2k</span><span class="o">=</span><span class="n">sin</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">kappa</span><span class="p">)</span>
        <span class="n">ss</span><span class="o">=</span><span class="n">sin</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">=</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1</span><span class="o">-</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="p">)</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=-</span><span class="n">sh</span><span class="o">*</span><span class="n">cs</span><span class="o">*</span><span class="n">s2k</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">sh</span><span class="o">*</span><span class="n">ss</span><span class="o">*</span><span class="n">sk</span><span class="o">*</span><span class="n">sk</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sh</span><span class="o">*</span><span class="n">cs</span><span class="o">*</span><span class="mf">2</span><span class="o">*</span><span class="n">sk</span><span class="o">*</span><span class="n">ck</span><span class="o">-</span><span class="mf">2</span><span class="o">*</span><span class="n">sh</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">ss</span><span class="o">*</span><span class="n">ck</span><span class="o">*</span><span class="n">ck</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">2</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mf">2</span><span class="o">*</span><span class="n">sh</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">ss</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt2</span><span class="o">*</span><span class="p">(</span><span class="n">sh</span><span class="o">*</span><span class="n">cs</span><span class="o">*</span><span class="p">(</span><span class="n">ck</span><span class="o">*</span><span class="n">ck</span><span class="o">-</span><span class="n">sk</span><span class="o">*</span><span class="n">sk</span><span class="p">)</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">sh</span><span class="o">*</span><span class="n">ss</span><span class="o">*</span><span class="n">s2k</span><span class="p">)</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">4</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">*</span><span class="n">cs</span><span class="o">*</span><span class="n">ck</span><span class="o">-</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">*</span><span class="n">ss</span><span class="o">*</span><span class="n">sk</span><span class="p">)</span>
        <span class="n">mt</span><span class="p">[</span><span class="mf">5</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">sqrt2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">*</span><span class="n">cs</span><span class="o">*</span><span class="n">sk</span><span class="o">+</span><span class="p">(</span><span class="mf">2</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="o">*</span><span class="n">ss</span><span class="o">*</span><span class="n">ck</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mt</span>

<span class="k">cpdef</span> <span class="nf">random_mt</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rand_mt</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">cpdef</span> <span class="nf">random_dc</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rand_dc</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">get_angle_coeff_multipliers</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_polarity</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">multipliers</span><span class="p">,</span><span class="n">DTYPE_t</span> <span class="n">epsilon</span><span class="p">)</span> <span class="k">nogil</span><span class="p">:</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">nsamples</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">nsta</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">polarity</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">amplitude_ratio</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">polarity_prob</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">if</span> <span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="n">nsta</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
        <span class="n">nsamples</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
        <span class="n">kmax</span><span class="o">=</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">pol</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">if</span> <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">nsta</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
            <span class="n">nsamples</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
            <span class="n">kmax</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">amplitude_ratio</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">if</span> <span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">amplitude_ratio</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
                <span class="n">nsta</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
                <span class="n">nsamples</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
                <span class="n">kmax</span><span class="o">=</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
        <span class="n">polarity_prob</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">w</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">ok</span><span class="o">=</span><span class="mf">1</span>
    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsamples</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">multipliers</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">==-</span><span class="mf">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>  
            <span class="k">if</span> <span class="n">multipliers</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">&gt;-</span><span class="mf">1</span><span class="p">:</span>
                <span class="n">ok</span><span class="o">=</span><span class="mf">1</span>
                <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsta</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">pol</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
                            <span class="n">ok</span><span class="o">*=</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">a_polarity</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">polarity_prob</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
                            <span class="n">ok</span><span class="o">*=</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">a_polarity_prob</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">amplitude_ratio</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
                            <span class="n">ok</span><span class="o">*=</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">a1_amplitude_ratio</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">a2_amplitude_ratio</span><span class="p">[</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">&lt;</span><span class="n">epsilon</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">w</span><span class="o">==</span><span class="n">nsta</span><span class="o">-</span><span class="mf">1</span> <span class="ow">and</span> <span class="n">ok</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
                    <span class="n">multipliers</span><span class="p">[</span><span class="n">u</span><span class="p">]</span><span class="o">+=</span><span class="n">multipliers</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">u</span><span class="p">:</span>
                        <span class="n">multipliers</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=-</span><span class="mf">1</span>
    <span class="k">return</span> <span class="n">multipliers</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">bin_angle_coefficient_samples</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">location_sample_multipliers</span><span class="p">,</span><span class="n">ext_data</span><span class="p">,</span><span class="n">epsilon</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">::</span><span class="mf">1</span><span class="p">]</span> <span class="n">multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">)</span>
    <span class="n">new_records</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">new_multipliers</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">polarity</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">amplitude_ratio</span><span class="o">=</span><span class="bp">False</span>
    <span class="n">polarity_prob</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">polarity</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_polarity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">amplitude_ratio</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">))</span>
        <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">polarity_prob</span><span class="o">=</span><span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_polarity_prob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">))</span>
    <span class="c"># print multipliers,bin_size,angles</span>
    <span class="n">multipliers</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">get_angle_coeff_multipliers</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">longlong</span><span class="p">),</span><span class="n">epsilon</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multipliers</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">multipliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">:</span>
            <span class="n">new_multipliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multipliers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">polarity</span><span class="p">:</span>
        <span class="n">a_polarity</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">,:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_polarity</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">if</span> <span class="n">amplitude_ratio</span><span class="p">:</span>
        <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">,:])</span>
        <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">,:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">if</span>  <span class="n">polarity_prob</span><span class="p">:</span>
        <span class="n">a_polarity_prob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">,:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a_polarity_prob</span><span class="o">=</span><span class="bp">False</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ext_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ext_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mf">2</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;a_&#39;</span> <span class="ow">or</span> <span class="n">k</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;a&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">ext_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ext_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0</span><span class="p">,:])</span>
    <span class="k">return</span> <span class="n">a_polarity</span><span class="p">,</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span><span class="n">a_polarity_prob</span><span class="p">,</span><span class="n">ext_data</span><span class="p">,</span><span class="n">new_multipliers</span>

<span class="nd">@cython</span><span class="o">.</span><span class="n">boundscheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">wraparound</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">nonecheck</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
<span class="nd">@cython</span><span class="o">.</span><span class="n">cdivision</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="k">cpdef</span> <span class="nf">relative_amplitude_loop</span><span class="p">(</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">MT1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">MT2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[:,:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">a2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mu1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mu2</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ps1</span><span class="p">,</span><span class="n">DTYPE_t</span><span class="p">[::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ps2</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">w2max</span><span class="o">=</span><span class="n">MT1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">wmax</span><span class="o">=</span><span class="n">MT2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">i</span><span class="o">=</span><span class="mf">0</span>
    <span class="k">if</span> <span class="n">wmax</span><span class="o">!=</span><span class="n">w2max</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Incorrect sizes&#39;</span><span class="p">)</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">umax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">vmax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="c">#Location Sample</span>
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">kmax</span><span class="o">=</span><span class="n">a1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="c">#MT elementssamples</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span> <span class="n">ln_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">umax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span>  
    <span class="k">cdef</span> <span class="kt">Py_ssize_t</span> <span class="nf">u</span><span class="p">,</span><span class="nf">v</span><span class="p">,</span><span class="nf">w</span><span class="p">,</span><span class="nf">k</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x1</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">x2</span><span class="o">=</span><span class="mf">0.0</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span>[<span class="p">:,::</span><span class="mf">1</span><span class="p">]</span>  <span class="n">s</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">umax</span><span class="p">,</span><span class="n">wmax</span><span class="p">))</span> 
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">mui</span>
    <span class="k">cdef</span> <span class="kt">DTYPE_t</span> <span class="nf">si</span>
    <span class="k">for</span> <span class="n">u</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">u</span><span class="o">&lt;</span><span class="n">umax</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">w</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">w</span><span class="o">&lt;</span><span class="n">wmax</span><span class="p">:</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">v</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">v</span><span class="o">&lt;</span><span class="n">vmax</span><span class="p">:</span>
                <span class="n">x1</span><span class="o">=</span><span class="mf">0.</span>
                <span class="n">x2</span><span class="o">=</span><span class="mf">0.</span>
                <span class="k">for</span> <span class="n">k</span> <span class="k">from</span> <span class="mf">0</span><span class="o">&lt;=</span><span class="n">k</span><span class="o">&lt;</span><span class="n">kmax</span><span class="p">:</span><span class="c"># loop over num mt samples and make x</span>
                    <span class="n">x1</span><span class="o">+=</span><span class="n">a1</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">MT1</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                    <span class="n">x2</span><span class="o">+=</span><span class="n">a2</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">MT2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>
                <span class="n">estimate_scale_mu_s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mui</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="n">mu1</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">mu2</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">ps1</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">ps2</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">==</span><span class="mf">0</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">mui</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">si</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_mu</span><span class="p">(</span><span class="n">mu</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">mui</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">si</span><span class="p">)</span>
                    <span class="n">s</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">combine_s</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">],</span><span class="n">si</span><span class="p">)</span>
                <span class="c">#First index is station, second is locaton sample, last is MT sample</span>
                <span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">+=</span><span class="n">ar_pdf</span><span class="p">(</span><span class="n">mu1</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">/</span><span class="n">mu2</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">mu</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">*</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">ps1</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">ps2</span><span class="p">[</span><span class="n">v</span><span class="p">])</span>
            <span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">]</span><span class="o">=</span><span class="n">log</span><span class="p">(</span><span class="n">ln_P</span><span class="p">[</span><span class="n">u</span><span class="p">,</span><span class="n">w</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ln_P</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-sampling.html" class="btn btn-neutral float-right" title="17.1.4. MTfit.sampling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source-markov_chain_monte_carlo.html" class="btn btn-neutral" title="17.1.2.2.3. MTfit.algorithms.markov_chain_monte_carlo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David Pugh.
      Last updated on Aug 30, 2018 (version 1.0.3a15).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.3a15',
            LANGUAGE:'English',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>