

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="English" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="English" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.1.1. MTfit.inversion &mdash; MTfit documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3.1.2. MTfit.algorithms" href="source-algorithms.html" />
    <link rel="prev" title="3. MTfit Source Code" href="source.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> MTfit
          

          
            
            <img src="_static/MTfitsphinx.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">2. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">3. Running MTfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">4. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="real-tutorial.html">5. Tutorial: Real Data Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">6. Bayesian Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">7. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">8. Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtconvert.html">9. Moment Tensor Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">10. Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplot.html">11. Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_classes.html">1. Plot Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplotcli.html">12. MTplot Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="inversion.html">13. Inversion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">14. Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">2. Glossary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="source.html">3. Source Code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="source.html#contents">3.1. Contents:</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.1.1. MTfit.inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-algorithms.html">3.1.2. MTfit.algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-probability.html">3.1.3. MTfit.probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-sampling.html">3.1.4. MTfit.sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-run.html">3.1.5. MTfit.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-utilities.html">3.1.6. MTfit.utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-extensions.html">3.1.7. MTfit.extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-convert.html">3.1.8. MTfit.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-plot.html">3.1.9. MTfit.plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/djpugh/MTfit">GitHub Repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MTfit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="source.html">3. MTfit Source Code</a> &raquo;</li>
        
      <li>3.1.1. MTfit.inversion</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/source-inversion.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mtfit-inversion">
<h1>3.1.1. MTfit.inversion<a class="headerlink" href="#mtfit-inversion" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">inversion</span>
<span class="sd">=========</span>
<span class="sd">Module containing the main inversion class, MTfit.inversion.Inversion class.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># **Restricted:  For Non-Commercial Use Only**</span>
<span class="c1"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c1"># and non-commercially funded academic research purposes.</span>
<span class="c1">#</span>
<span class="c1"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>


<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">ceil</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.utilities.multiprocessing_helper</span> <span class="k">import</span> <span class="n">JobPool</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">parse_hyp</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">parse_csv</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">full_pdf_output_dicts</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">hyp_output_dicts</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">MATLAB_output</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">pickle_output</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">hyp_output</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">read_binary_output</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">read_sf_output</span>
<span class="kn">from</span> <span class="nn">.sampling</span> <span class="k">import</span> <span class="n">ln_bayesian_evidence</span>
<span class="kn">from</span> <span class="nn">.algorithms</span> <span class="k">import</span> <span class="n">BaseAlgorithm</span>
<span class="kn">from</span> <span class="nn">.algorithms</span> <span class="k">import</span> <span class="n">IterationSample</span>
<span class="kn">from</span> <span class="nn">.algorithms</span> <span class="k">import</span> <span class="n">TimeSample</span>
<span class="kn">from</span> <span class="nn">.algorithms</span> <span class="k">import</span> <span class="n">MarkovChainMonteCarloAlgorithmCreator</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">polarity_ln_pdf</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">LnPDF</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">polarity_probability_ln_pdf</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">amplitude_ratio_ln_pdf</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">relative_amplitude_ratio_ln_pdf</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">ln_marginalise</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">dkl_estimate</span>
<span class="kn">from</span> <span class="nn">.utilities.extensions</span> <span class="k">import</span> <span class="n">get_extensions</span>
<span class="kn">from</span> <span class="nn">.extensions.scatangle</span> <span class="k">import</span> <span class="n">parse_scatangle</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;MTfit.inversion&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">cprobability</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">cprobability</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error importing c extension&#39;</span><span class="p">)</span>
    <span class="n">cprobability</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">_MEMTEST</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_VERBOSITY</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_CYTHON_TESTS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_COMBINED_TESTS</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">memory_profile_test</span><span class="p">(</span><span class="n">memtest</span><span class="o">=</span><span class="n">_MEMTEST</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator for running memory profiler (memory_profiler module) to test memory requirements and bottlenecks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Memory Profile Test Actual Decorator&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">memtest</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">memory_profiler</span> <span class="k">import</span> <span class="n">profile</span>
                <span class="k">return</span> <span class="n">profile</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">function</span>
        <span class="k">return</span> <span class="n">function</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="c1">#</span>
<span class="c1"># Task Objects</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">ForwardTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward modelling task</span>

<span class="sd">    Task which carries out forward modelling and returns results dictionary containing PDF, MTs and Number of forward modelled Samples</span>
<span class="sd">    Callable object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                 <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">polarity_prob</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marginalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">100000000</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ForwardTask initialisation</span>

<span class="sd">        Args</span>
<span class="sd">            mt: numpy matrix object containing moment tensor 6 vectors.</span>
<span class="sd">            a_polarity: Polarity observations station-ray 6 vector.</span>
<span class="sd">            error_polarity: Polarity observations error.</span>
<span class="sd">            a1_amplitude_ratio: Amplitude ratio observations numerator station-ray 6 vector.</span>
<span class="sd">            a2_amplitude_ratio: Amplitude ratio observations denominator station-ray 6 vector.</span>
<span class="sd">            amplitude_ratio: Observed amplitude ratio.</span>
<span class="sd">            percentage_error1_amplitude_ratio: Amplitude ratio observations percentage error for the numerator.</span>
<span class="sd">            percentage_error2_amplitude_ratio: Amplitude ratio observations percentage error for the denominator.</span>
<span class="sd">            a_polarity_prob: Polarity PDF observations station-ray 6 vector.</span>
<span class="sd">            polarity_prob: Polarity PDF probability</span>
<span class="sd">            return_zero:[False] Boolean flag to return zero probability samples.</span>
<span class="sd">            reuse:[False] Boolean flag as to whether task is reused (mt changed and re-run...)</span>
<span class="sd">            marginalise:[True] Boolean flag as to whether pdf is marginalised over location/model uncertainty or not.</span>
<span class="sd">            generate_samples:[100000] Number of samples to generate when generating samples.</span>
<span class="sd">            cutoff:[100000000] Max number of samples to try when generating samples.</span>
<span class="sd">            dc:[False] DC or MT when generating samples.</span>
<span class="sd">            extension_data:[{}] A dictionary of processed data for use by an MTfit.data_types extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span> <span class="o">=</span> <span class="n">error_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span> <span class="o">=</span> <span class="n">polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">incorrect_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span> <span class="o">=</span> <span class="n">return_zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span> <span class="o">=</span> <span class="n">reuse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span> <span class="o">=</span> <span class="n">marginalise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span> <span class="o">=</span> <span class="n">extension_data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cprobability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="o">=</span> <span class="n">generate_samples</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the ForwardTask and returns the result as a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of results as {&#39;moment_tensors&#39;:MTs,&#39;ln_pdf&#39;:prob,&#39;n&#39;:numberOfInitialSamples}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">_VERBOSITY</span>
        <span class="k">global</span> <span class="n">_DEBUG</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_VERBOSITY</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">memory_profiler</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Memory Usage - Initial: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_profiler</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()))</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="n">memory_profiler</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">):</span>
                <span class="n">_return</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># set _return flag to False before starting</span>
                <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_CYTHON_TESTS</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_COMBINED_TESTS</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Get number of samples if not generating them</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">:</span>
                            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># Check if there are location PDF samples.</span>
                        <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">n_location_samples</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">n_location_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">n_location_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">n_location_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># Check location sample probabilities (easier on memory and computation to have 2 samples in the same place have double the probability)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">:</span>
                            <span class="n">ln_location_sample_multipliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ln_location_sample_multipliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_location_samples</span><span class="p">)</span>
                        <span class="c1"># Try to use cprobabilities combined PDF code:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">:</span>
                            <span class="n">ln_p_total</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">combined_ln_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">,</span>
                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span>
                                                                             <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">marginalised</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">),</span> <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">ln_location_sample_multipliers</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">combined_ln_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span>
                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">,</span>
                                                                      <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">,</span>
                                                                      <span class="n">marginalised</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">),</span> <span class="n">location_samples_multipliers</span><span class="o">=</span><span class="n">ln_location_sample_multipliers</span><span class="p">)</span>
                        <span class="c1"># Handle extensions</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">):</span>
                            <span class="n">extension_names</span><span class="p">,</span> <span class="n">extensions</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.data_types&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_names</span> <span class="ow">and</span> <span class="s1">&#39;relative&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                                        <span class="n">ln_p_ext</span> <span class="o">=</span> <span class="n">extensions</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_combine</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="n">ln_p_ext</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Extension </span><span class="si">{}</span><span class="s1"> function not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Exception for extension: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                        <span class="c1"># Set nans to inf</span>
                        <span class="n">ln_p_total</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                        <span class="c1"># Check if  any probabilities are non zero otherwise return</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ln_p_total</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                        <span class="c1"># Otherwise probability evaluation is complete so set return flag to True</span>
                        <span class="n">_return</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># Exception in cprobabilities combined PDF - print error message</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Cython Combined PDFs failed&#39;</span><span class="p">)</span>
                <span class="c1"># Check if the combined PDF has been evaluated, otherwise evaluate individual PDFs</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_return</span><span class="p">:</span>
                    <span class="c1"># Check if generating samples (MT is bool rather than np.array)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">random_dc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">random_mt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">)</span>
                    <span class="n">_return</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Initialise ln_p_total and check location_samples</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="c1"># Set manual polarities flag</span>
                    <span class="n">manual_polarities</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Ignore np.divide errors</span>
                        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                            <span class="c1"># polarity ln_pdf (will try to use cython again, and only fall back to python if necessary)</span>
                            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">polarity_ln_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">)</span>
                        <span class="c1"># Set manual_polarities (don&#39;t use auto-polarities) and return flags (have evaluated a PDF)</span>
                        <span class="n">manual_polarities</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">_return</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Print number of non zero samples (Verbosity&gt;=3)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Polarity non-zero samples = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># Exception - check if data exists and print output, otherwise ignore</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Polarity Exception&#39;</span><span class="p">)</span>
                    <span class="c1"># Force garbage collect to tidy memory</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="c1"># If manual polarity data didn&#39;t work or doesn&#39;t exist, try automated polarities</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">manual_polarities</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Ignore np.divide errors</span>
                            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                                <span class="c1"># Polarity probability ln_pdf (will try to use cython again, and only fall back to python if necessary)</span>
                                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">polarity_probability_ln_pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">)</span>
                            <span class="n">_return</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Print number of non zero samples (Verbosity&gt;=3)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Polarity probability non-zero samples = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># Exception  - check if data exists and print output, otherwise ignore</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Polarity PDF Exception&#39;</span><span class="p">)</span>
                        <span class="c1"># Force garbage collect to tidy memory</span>
                        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="c1"># Check if  any probabilities are non zero otherwise return</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">location_samples</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">:</span>
                            <span class="c1"># Return marginalised zero PDF</span>
                            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Ignore np.divide errors</span>
                        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                            <span class="c1"># amplitude ratio ln_pdf (will try to use cython again, and only fall back to python if necessary)</span>
                            <span class="n">ln_p_amp_rat</span> <span class="o">=</span> <span class="n">amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">_return</span><span class="p">:</span>
                            <span class="c1"># if Cython and polarity data exists, combine using Cython</span>
                            <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_CYTHON_TESTS</span><span class="p">:</span>
                                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_combine</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="n">ln_p_amp_rat</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_p_amp_rat</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_amp_rat</span>
                        <span class="c1"># free ln_p_amp_rat memory</span>
                        <span class="k">del</span> <span class="n">ln_p_amp_rat</span>
                        <span class="n">_return</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># Print number of non zero samples (Verbosity&gt;=3)</span>
                        <span class="k">if</span> <span class="n">_VERBOSITY</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Amplitude Ratio non-zero samples:</span><span class="si">{}</span><span class="s1">. Total Non zero: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ln_p_amp_rat</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Amplitude Ratio Exception&#39;</span><span class="p">)</span>
                    <span class="c1"># Force garbage collection</span>
                    <span class="c1"># Handle extensions</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">):</span>
                        <span class="n">extension_names</span><span class="p">,</span> <span class="n">extensions</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.data_types&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_names</span> <span class="ow">and</span> <span class="s1">&#39;relative&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                                    <span class="n">ln_p_ext</span> <span class="o">=</span> <span class="n">extensions</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_CYTHON_TESTS</span><span class="p">:</span>
                                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_combine</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="n">ln_p_ext</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_p_ext</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Extension </span><span class="si">{}</span><span class="s1"> function not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Exception for extension: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="c1"># Clear the memory</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_return</span><span class="p">:</span>
                        <span class="c1"># No data has been used, so print exceptions</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No data used in polarity, amplitude ratio or polarity PDF&#39;</span><span class="p">)</span>
                    <span class="c1"># If location PDF samples exist and sample PDF multipliers exist (increased Prob) - For Oct -tree sampling  sample density correspond to PDF values (more samples in higher prob). Grid sampling needs location multipliers set (can be done using Scat2Angle with &#39;grid&#39; option in command line)</span>
                    <span class="k">if</span> <span class="n">location_samples</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
                            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span>
                            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_multipliers</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ln_p_total</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Conversion to matrix and transpose to correct for list order to ln_p_total dimensions (0 is sample dimension)</span>
                    <span class="c1"># If there are location samples and the marginalise flag is set, then marginalise, trying to use Cython</span>
                    <span class="k">if</span> <span class="n">location_samples</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">:</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_marginalise</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)</span>
                <span class="c1"># Delete arrays to free memory if not reusing</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span>
                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="c1"># Print end memory usage (Verbosity &gt;=3)</span>
                <span class="k">if</span> <span class="n">_VERBOSITY</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">memory_profiler</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;end usage </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory_profiler</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()))</span>
                <span class="c1"># Check results</span>
                <span class="k">if</span> <span class="n">_return</span><span class="p">:</span>
                    <span class="c1"># Flag for nan errors if _DEBUG is set</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_DEBUG</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;NaN result&#39;</span><span class="p">)</span>
                    <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)</span>
                    <span class="c1"># remove zeros if _return_zero flag not set.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">[:,</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Overall error catch</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Error in forward task:</span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">Returning no result and continuing [no action required].&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">McMCForwardTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Markov chain Monte Carlo Forward modelling task</span>

<span class="sd">    Task which carries out Markov chain Monte Carlo forward modelling and returns results dictionary containing PDF, MTs and Number of forward modelled Samples</span>
<span class="sd">    Runs for whole Markov chain. Callable object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                 <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">polarity_prob</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marginalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        McMCForwardTask initialisation</span>

<span class="sd">        Args</span>
<span class="sd">            algorithm_kwargs: Algorithm Keyword Arguments for running Markov chain Monte Carlo inversion with.</span>
<span class="sd">            a_polarity: Polarity observations station-ray 6 vector.</span>
<span class="sd">            error_polarity: Polarity observations error.</span>
<span class="sd">            a1_amplitude_ratio: Amplitude ratio observations numerator station-ray 6 vector.</span>
<span class="sd">            a2_amplitude_ratio: Amplitude ratio observations denominator station-ray 6 vector.</span>
<span class="sd">            amplitude_ratio: Observed amplitude ratio.</span>
<span class="sd">            percentage_error1_amplitude_ratio: Amplitude ratio observations percentage error for the numerator.</span>
<span class="sd">            percentage_error2_amplitude_ratio: Amplitude ratio observations percentage error for the denominator.</span>
<span class="sd">            a_polarity_prob: Polarity PDF observations station-ray 6 vector.</span>
<span class="sd">            polarity_prob: Polarity PDF probability</span>
<span class="sd">            fid:[False] File name for output.</span>
<span class="sd">            event_data:[False] event_data data for output.</span>
<span class="sd">            location_samples:[False] Station angle scatter samples for output.</span>
<span class="sd">            location_sample_multipliers:[False] Station angle probability samples for output.</span>
<span class="sd">            marginalise:[True] Boolean flag as to whether pdf is marginalised over location/model uncertainty.</span>
<span class="sd">            normalise:[True] Normalise output (doesn&#39;t matter for McMC main output, but will affect probability output)</span>
<span class="sd">            convert:[False] Convert output data to tape, hudson and fault plane coordinates.</span>
<span class="sd">            extension_data:[{}] A dictionary of processed data for use by an MTfit.data_types extension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_kwargs</span> <span class="o">=</span> <span class="n">algorithm_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span> <span class="o">=</span> <span class="n">error_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span> <span class="o">=</span> <span class="n">polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">incorrect_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">event_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="o">=</span> <span class="n">location_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span> <span class="o">=</span> <span class="n">marginalise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="n">normalise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">convert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span> <span class="o">=</span> <span class="n">extension_data</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the McMCForwardTask and returns the result as a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of results as {&#39;algorithm_output_data&#39;:algorithm_data,&#39;event_data&#39;:event_data,&#39;location_samples&#39;:location_samples,&#39;location_sample_multipliers&#39;:location_sample_multipliers}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">MarkovChainMonteCarloAlgorithmCreator</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_kwargs</span><span class="p">)</span>
        <span class="c1"># Initialise algorithm</span>
        <span class="n">mts</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
        <span class="c1"># Run forward tasks for MT samples</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">mts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marginalise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">marginalise</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">forward</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">mts</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">forward</span><span class="p">()</span>
            <span class="n">mts</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c1"># Close logger</span>
        <span class="c1"># Get output data and print results</span>
        <span class="n">output_data</span><span class="p">,</span> <span class="n">output_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">:</span> <span class="n">output_data</span><span class="p">,</span> <span class="s1">&#39;event_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span> <span class="s1">&#39;location_samples&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">,</span>
                <span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">MultipleEventsForwardTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiple Events Forward modelling task</span>

<span class="sd">    Task which carries out forward modelling with relative amplitudes and returns dictionary containing PDF, MTs and Number of forward modelled Samples</span>
<span class="sd">    Callable object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mts</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span>
                 <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">polarity_prob</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minimum_number_intersections</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">marginalise_relative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of MultipleEventsForwardTask</span>

<span class="sd">        Used to calculate forward model parameters for multiple event samples (e.g. using relative amplitudes).</span>

<span class="sd">        Args</span>
<span class="sd">            mts: List of numpy matrix objects containing moment tensor 6 vectors for each event.</span>
<span class="sd">            a_polarity: List of Polarity observations station-ray 6 vector for each event.</span>
<span class="sd">            error_polarity: List of Polarity observations error for each event.</span>
<span class="sd">            a1_amplitude_ratio: List of Amplitude ratio observations numerator station-ray 6 vector for each event.</span>
<span class="sd">            a2_amplitude_ratio: List of Amplitude ratio observations denominator station-ray 6 vector for each event.</span>
<span class="sd">            amplitude_ratio: List of Observed amplitude ratios for each event.</span>
<span class="sd">            percentage_error1_amplitude_ratio: List of Amplitude ratio observations percentage_error for the numerator for each event.</span>
<span class="sd">            percentage_error2_amplitude_ratio: List of Amplitude ratio observations percentage_error for the denominator for each event.</span>
<span class="sd">            a_polarity_prob: List of Polarity PDF observations station-ray 6 vector for each event.</span>
<span class="sd">            polarity_prob: List of Polarity PDF probability for each event.</span>
<span class="sd">            a_relative_amplitude: List of numpy matrix objects for station-ray 6 vector for each event</span>
<span class="sd">            relative_amplitude: List of Observed  amplitude values for relative amplitude calculation for each event</span>
<span class="sd">            percentage_error_relative_amplitude: List of Amplitude ratio observations percentage_error for the relative amplitude calculation for each event</span>
<span class="sd">            relative_amplitude_stations: List of relative amplitude stations allowing for intersections when evaluating the relative amplitudes</span>
<span class="sd">            return_zero:[False] Boolean flag to return zero probability samples.</span>
<span class="sd">            reuse:[False] Boolean flag as to whether task is reused (mt changed and re-run...)</span>
<span class="sd">            relative:[False] Use relative amplitude on multiple</span>
<span class="sd">            location_samples:[1]  Integer number of station samples, (default is 1)</span>
<span class="sd">            marginalise_relative:[False] Boolean flag to marginalise the location uncertainty between absolute and relative data.</span>
<span class="sd">            combine:[False] Boolean flag to combine the probabilities between multiple events.</span>
<span class="sd">            extension_data:[] A list of dictionaries of processed data for use by an MTfit.data_types extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mts</span> <span class="o">=</span> <span class="n">mts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span> <span class="o">=</span> <span class="n">error_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span> <span class="o">=</span> <span class="n">polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">incorrect_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="n">a_relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="n">relative_amplitude_stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude</span> <span class="o">=</span> <span class="n">relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error_relative_amplitude</span> <span class="o">=</span> <span class="n">percentage_error_relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span> <span class="o">=</span> <span class="n">return_zero</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span> <span class="o">=</span> <span class="n">reuse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="o">=</span> <span class="n">relative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span> <span class="o">=</span> <span class="n">minimum_number_intersections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span> <span class="o">=</span> <span class="n">location_sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span> <span class="o">=</span> <span class="n">marginalise_relative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span> <span class="o">=</span> <span class="n">combine</span>
        <span class="c1"># Need to implement marginalisation of scale factor for self._marginalise_relative and location_samples</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Marginalisation of location samples on relative data not implemented yet - we may well expect location uncertainty between the co-located events to be zero&#39;</span><span class="p">)</span>
            <span class="c1"># https://github.com/djpugh/MTfit/issues/11</span>
            <span class="c1"># Scale factor is location/amplitude specific</span>
            <span class="c1"># We would expect amplitude ratio location uncertainty to be minimal between co-located events</span>
            <span class="c1"># So probably need to remove any location uncertainty for the relative amplitude terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span> <span class="o">=</span> <span class="n">extension_data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the MultipleEventsForwardTask and returns the result as a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of results as {&#39;mt1&#39;:mt1,&#39;mt2&#39;:mt2,&#39;PDF&#39;:pdf}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If combining outputs make a single ln_pdf else make a list of them</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">:</span>
            <span class="c1"># Assuming that location uncertainty matches for each event (i.e if samples used, event is still co-located...)</span>
            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Set non-zero array</span>
        <span class="n">non_zeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1"># Set scale factors and scale factor uncertainties</span>
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">))))</span>
        <span class="n">scale_factor_uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">))))</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Loop over MTs</span>
        <span class="n">extension_scale</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">):</span>
            <span class="c1"># Set diagonal scale_factors and scale_factor_uncertainties</span>
            <span class="n">scale_factor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Get station coefficients</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">a_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">extension_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extension_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Update mt with non-zeros if combining</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="n">non_zeros</span><span class="p">])</span>
                <span class="n">mt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># If forward tasks are being re-used and one doesn&#39;t exist or no tasks are re-used</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forward_tasks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span><span class="p">:</span>
                <span class="n">forward_task</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a_polarity_prob</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                           <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">marginalise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">forward_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forward_task</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forward_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mt</span> <span class="o">=</span> <span class="n">mt</span>
                <span class="n">forward_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_tasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Run forward task</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">forward_task</span><span class="p">()</span>
            <span class="c1"># Process results amd combine</span>
            <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="n">LnPDF</span><span class="p">):</span>
                <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_ln_pdf</span>
            <span class="c1"># If not combining add to ln_pdf list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ln_pdf</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">))):</span>
                    <span class="c1"># in relative loop  and all zero prob</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                <span class="n">ln_p_total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># all zero so breaking</span>
            <span class="k">if</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">ln_p_total</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">break</span>
            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_pdf</span>
            <span class="c1"># return if ln_p_total is all zero</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># return zeros</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">}</span>
            <span class="c1"># Update mts</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                <span class="c1"># Update ln_pdfs etc. for non-zeros</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">non_zeros</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
                    <span class="n">non_zeros</span><span class="p">[</span><span class="n">non_zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># update non zeros</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span> <span class="n">flatten</span><span class="p">()])</span>
                    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="n">scale_factor_uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
                    <span class="n">mt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1">#####</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">)))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">:</span>
                <span class="c1"># Do relative amplitude calculations if not combining PDFs - Relative loop over non-zero samples, introduces some bias but not much, and should reduce computation time</span>
                <span class="c1"># Set non zeros</span>
                <span class="n">non_zero</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln_p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">):</span>
                    <span class="n">nonzero_p</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="n">nonzero_p</span><span class="p">]</span>
                    <span class="n">ln_p_total</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p</span><span class="p">)[:,</span> <span class="n">nonzero_p</span><span class="p">]</span>
                    <span class="n">non_zero</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nonzero_p</span><span class="p">))</span>
                <span class="c1"># Get fewest number of mts and set all non-zero mts to that</span>
                <span class="n">min_mts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">min_mts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ln_p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ln_p_t</span> <span class="o">=</span> <span class="n">ln_p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">min_mts</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ln_p_t</span> <span class="o">+=</span> <span class="n">ln_p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">min_mts</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span> <span class="n">min_mts</span><span class="p">])</span>
                <span class="c1"># Set up ln_p_total to run amp ratios through</span>
                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p_t</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                    <span class="n">nonzero_p</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mts</span><span class="p">[:,</span> <span class="n">nonzero_p</span><span class="p">]</span> <span class="k">for</span> <span class="n">mts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">]</span>
                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">_ln_pdf</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">list</span><span class="p">))):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="c1"># Go backwards to ease calculation as there are  fewer events at start when most non-zero mts</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Get amplitude ratio station coefficients</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">):</span>
                            <span class="n">a1_relative_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">a2_relative_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">a1_relative_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span>
                            <span class="n">a2_relative_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span>
                        <span class="c1"># Intersect stations</span>
                        <span class="n">intersected_data</span> <span class="o">=</span> <span class="n">_intersect_stations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude_stations</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude_stations</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">a1_relative_amplitude_ratio</span><span class="p">,</span>
                                                               <span class="n">a2_relative_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error_relative_amplitude</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error_relative_amplitude</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">a1_relative_amplitude_ratio</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">a2_relative_amplitude_ratio</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">relative_amplitude_i</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">relative_amplitude_j</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">percentage_error_relative_amplitude_i</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                        <span class="n">percentage_error_relative_amplitude_j</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                        <span class="n">n_intersections</span> <span class="o">=</span> <span class="n">intersected_data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="c1"># Check number of intersections</span>
                        <span class="k">if</span> <span class="n">n_intersections</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">:</span>
                            <span class="c1"># Evaluate relative amplitude ratio pdf</span>
                            <span class="n">ln_p_amp_rat</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale_uncertainty</span> <span class="o">=</span> <span class="n">relative_amplitude_ratio_ln_pdf</span><span class="p">(</span><span class="n">relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mt</span><span class="p">),</span>
                                                                                                     <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">a1_relative_amplitude_ratio</span><span class="p">,</span>
                                                                                                     <span class="n">a2_relative_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude_i</span><span class="p">,</span>
                                                                                                     <span class="n">percentage_error_relative_amplitude_j</span><span class="p">)</span>
                            <span class="c1"># Set scale_factor and scale_factor_uncertainties</span>
                            <span class="n">scale_factor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
                            <span class="n">scale_factor</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
                            <span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_uncertainty</span>
                            <span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_uncertainty</span>
                            <span class="c1"># Handle location samples PDFs</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
                                    <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span>
                                    <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                    <span class="n">ln_p_amp_rat</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_multipliers</span><span class="p">(</span><span class="n">ln_p_amp_rat</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">ln_p_amp_rat</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                            <span class="c1"># Marginalise if marginalise_relative flag is True</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">:</span>
                                <span class="n">ln_p_amp_rat</span> <span class="o">=</span> <span class="n">ln_marginalise</span><span class="p">(</span><span class="n">ln_p_amp_rat</span><span class="p">,</span> <span class="n">_cython</span><span class="o">=</span><span class="n">cprobability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span>
                            <span class="c1"># Combine ln_p_total and amp rat</span>
                            <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_CYTHON_TESTS</span><span class="p">:</span>
                                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_combine</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">),</span> <span class="n">ln_p_amp_rat</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_p_amp_rat</span>
                            <span class="c1"># return zeros</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                            <span class="c1"># Update mts for non-zeros</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                                <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">non_zeros</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">):</span>
                                    <span class="n">non_zeros</span><span class="p">[</span><span class="n">non_zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_zero_indices</span>
                                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="n">non_zero_indices</span><span class="p">])</span>
                                    <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">non_zero_indices</span><span class="p">])</span>
                                    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">[:,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                                    <span class="n">scale_factor_uncertainty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Relative Amplitude Ratio Exception </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                        <span class="c1"># Exception in cprobabilities combined PDF - print error message</span>
                        <span class="k">if</span> <span class="n">_VERBOSITY</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="c1"># Handle relative inversion extensions</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">):</span>
                <span class="n">extension_names</span><span class="p">,</span> <span class="n">extensions</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.data_types&#39;</span><span class="p">)</span>
                <span class="n">extension_scale</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">extension_scale_uncertainty</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">))))</span>
                    <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">))))</span>
                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_names</span> <span class="ow">and</span> <span class="s1">&#39;relative&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                                    <span class="n">extension_data_1</span><span class="p">,</span> <span class="n">extension_data_2</span><span class="p">,</span> <span class="n">n_intersections</span> <span class="o">=</span> <span class="n">_intersect_stations_extension_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                                                                                                                             <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">n_intersections</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="n">ln_p_ext</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale_uncertainty</span> <span class="o">=</span> <span class="n">extensions</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="o">.</span><span class="n">mt</span><span class="p">,</span> <span class="n">extension_data_1</span><span class="p">,</span> <span class="n">extension_data_2</span><span class="p">)</span>
                                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
                                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
                                    <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_uncertainty</span>
                                    <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale_uncertainty</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
                                            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span>
                                            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                            <span class="n">ln_p_extensions</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_multipliers</span><span class="p">(</span><span class="n">ln_p_ext</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">ln_p_extensions</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                                    <span class="c1"># Marginalise if marginalise_relative flag is True</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">:</span>
                                        <span class="n">ln_p_extensions</span> <span class="o">=</span> <span class="n">ln_marginalise</span><span class="p">(</span><span class="n">ln_p_extensions</span><span class="p">,</span> <span class="n">_cython</span><span class="o">=</span><span class="n">cprobability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">cprobability</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_CYTHON_TESTS</span><span class="p">:</span>
                                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">ln_combine</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="n">ln_p_extensions</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_p_extensions</span>

                                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ln_p_total</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                                            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([]),</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([])),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                                        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">}</span>
                                    <span class="c1"># Update mts for non-zeros</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
                                        <span class="n">non_zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                                        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">non_zeros</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">non_zero_indices</span><span class="p">):</span>
                                            <span class="n">non_zeros</span><span class="p">[</span><span class="n">non_zeros</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_zero_indices</span>
                                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">[</span><span class="n">j</span><span class="p">][:,</span> <span class="n">non_zero_indices</span><span class="p">])</span>
                                            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">non_zero_indices</span><span class="p">])</span>
                                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_scale</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                                <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                                                <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">non_zero_indices</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Extension </span><span class="si">{}</span><span class="s1"> function not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exception for relative extension: </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="c1"># Delete attributes if not reusing and force garbage collection</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reuse</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="c1"># Take non-zeros here?</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">and</span> <span class="n">_DEBUG</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;NaN result&#39;</span><span class="p">)</span>
        <span class="c1"># Set up results dict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">:</span>
            <span class="c1"># Relative not marginalised already</span>
            <span class="n">ln_scale</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="o">-</span><span class="n">ln_p_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">ln_scale</span> <span class="o">=</span> <span class="o">-</span><span class="n">ln_p_total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([{</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;ln_p&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">scale_factor_uncertainty</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_scale</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([{</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;ln_p&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">extension_scale</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_p_total</span><span class="o">+</span><span class="n">ln_scale</span><span class="p">)</span>
            <span class="c1"># Marginalise</span>
            <span class="n">p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p_total</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p_total</span><span class="p">)</span><span class="o">-</span><span class="n">ln_scale</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">:</span>  <span class="c1"># marginalise_relative is true</span>
            <span class="k">if</span> <span class="n">scale_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">scale_factor_uncertainty</span> <span class="o">=</span> <span class="n">scale_factor_uncertainty</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">scale_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">scale_factor_uncertainty</span> <span class="o">=</span> <span class="n">scale_factor_uncertainty</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([{</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">scale_factor_uncertainty</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">scale_factor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_scale</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([{</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span> <span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="s1">&#39;ln_p&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">extension_scale_uncertainty</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">extension_scale</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">extension_scale</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_p_total</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_zero</span><span class="p">:</span>
            <span class="n">nonzero_p</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mts</span> <span class="o">=</span> <span class="p">[</span><span class="n">mts</span><span class="p">[:,</span> <span class="n">nonzero_p</span><span class="p">]</span> <span class="k">for</span> <span class="n">mts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">]</span>
            <span class="n">ln_p_total</span> <span class="o">=</span> <span class="n">ln_p_total</span><span class="p">[:,</span> <span class="n">nonzero_p</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">[</span><span class="n">nonzero_p</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mts</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">ln_p_total</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">:</span> <span class="n">scale_factor</span><span class="p">,</span> <span class="s1">&#39;extensions_scale_factor&#39;</span><span class="p">:</span> <span class="n">extension_scale</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">MultipleEventsMcMCForwardTask</span><span class="p">(</span><span class="n">McMCForwardTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multiple Events McMC Forward modelling task</span>

<span class="sd">    Task which carries out Markov chain Monte Carlo forward modelling which carries out forward modelling for multiple events and returns dictionary containing PDF, MTs and Number of forward modelled Samples</span>
<span class="sd">    Callable object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Carry out McMC on multiple events using relative amplitudes to link them together.</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span>
                 <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">polarity_prob</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">minimum_number_intersections</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">event_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marginalise_relative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of MultipleEventsMcMCForwardTask</span>

<span class="sd">        Args</span>
<span class="sd">            algorithm_kwargs: Algorithm Keyword Arguments for running Markov chain Monte Carlo inversion with.</span>
<span class="sd">            a_polarity: List or numpy matrix of polarity observations station-ray 6 vector.</span>
<span class="sd">            error_polarity: List of numpy matrices of polarity observations error.</span>
<span class="sd">            a1_amplitude_ratio: List or numpy matrix of amplitude ratio observations numerator station-ray 6 vector.</span>
<span class="sd">            a2_amplitude_ratio: List or numpy matrix of amplitude ratio observations denominator station-ray 6 vector.</span>
<span class="sd">            amplitude_ratio:  List of numpy matrices of observed amplitude ratio.</span>
<span class="sd">            percentage_error1_amplitude_ratio: List of numpy matrices amplitude ratio observations percentage error for the numerator.</span>
<span class="sd">            percentage_error2_amplitude_ratio: List of numpy matrices amplitude ratio observations percentage error for the denominator.</span>
<span class="sd">            a_polarity_prob: List or numpy matrix of polarity PDF observations station-ray 6 vector.</span>
<span class="sd">            polarity_prob: List of numpy matrices of polarity PDF probability.</span>
<span class="sd">            a_relative_amplitude: List of numpy matrix objects for station-ray 6 vector for each event</span>
<span class="sd">            relative_amplitude: List of Observed  amplitude values for relative amplitude calculation for each event</span>
<span class="sd">            percentage_error_relative_amplitude: List of Amplitude ratio observations percentage_error for the relative amplitude calculation for each event</span>
<span class="sd">            relative_amplitude_stations: List of relative amplitude stations allowing for intersections when evaluating the relative amplitudes</span>
<span class="sd">            relative:[True] Carry out relative amplitude step in inversion.</span>
<span class="sd">            minimum_number_intersections:[2] Integer - minimum number of station intersections required to include the relative amplitude information.</span>
<span class="sd">            fid:[False] File name for output.</span>
<span class="sd">            event_data:[False] event_data data for output.</span>
<span class="sd">            location_samples:[False] Station angle scatter samples for output.</span>
<span class="sd">            location_sample_multipliers:[False] Station angle probability samples for output.</span>
<span class="sd">            marginalise_relative:[False] Boolean flag as to whether pdf is marginalised over location/model uncertainty - IGNORED.</span>
<span class="sd">            normalise:[True] Normalise output (doesn&#39;t matter for McMC main output, but will affect probability output)</span>
<span class="sd">            convert:[False] Convert output data to tape, hudson and fault plane coordinates.</span>
<span class="sd">            extension_data:[] A list of dictionaries of processed data for use by an MTfit.data_types extension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_kwargs</span> <span class="o">=</span> <span class="n">algorithm_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span> <span class="o">=</span> <span class="n">error_polarity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error1_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">percentage_error2_amplitude_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span> <span class="o">=</span> <span class="n">polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">incorrect_polarity_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="n">a_relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude</span> <span class="o">=</span> <span class="n">relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error_relative_amplitude</span> <span class="o">=</span> <span class="n">percentage_error_relative_amplitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="n">relative_amplitude_stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="o">=</span> <span class="n">relative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span> <span class="o">=</span> <span class="n">event_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="o">=</span> <span class="n">location_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span> <span class="o">=</span> <span class="n">minimum_number_intersections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Setting this to False causes issues at the moment marginalise_relative</span>
        <span class="c1"># TODO fix thie marginalise relative handling in the McMC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="n">normalise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">convert</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span> <span class="o">=</span> <span class="n">extension_data</span>
        <span class="c1"># Set logger</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the multiple events McMC forward task</span>

<span class="sd">        Runs the MultipleEventsMcMCForwardTask and returns the result as a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of results as {&#39;algorithm_output_data&#39;:algorithm_data,&#39;event_data&#39;:event_data,&#39;location_samples&#39;:location_samples,&#39;location_sample_multipliers&#39;:location_sample_multipliers}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">location_sample_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">)</span>
        <span class="c1"># Set algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">MarkovChainMonteCarloAlgorithmCreator</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_kwargs</span><span class="p">)</span>
        <span class="c1"># Initialise algorithm</span>
        <span class="n">mts</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Initialise algorithms separately (no relative data)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">_initialising</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">_initialiser</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Sort station angle coefficients (list or array)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mts</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">a_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">error_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error_polarity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">extension_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extension_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">):</span>
                    <span class="n">polarity_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">polarity_prob</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span>
                <span class="c1"># Run forward task</span>
                <span class="n">forward_task</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span>
                                           <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                           <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span>
                                           <span class="n">polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span><span class="p">,</span>
                                           <span class="n">return_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">forward_task</span><span class="p">())</span>
            <span class="n">mts</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Run Relative amplitude data multiple events</span>
        <span class="n">multiple_events_forward_task</span> <span class="o">=</span> <span class="n">MultipleEventsForwardTask</span><span class="p">(</span><span class="n">mts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_polarity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">polarity_prob</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_amplitude_stations</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                 <span class="n">relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="o">=</span><span class="n">location_sample_size</span><span class="p">,</span>
                                                                 <span class="n">marginalise_relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span>
                                                                 <span class="n">extension_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extension_data</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">multiple_events_forward_task</span><span class="o">.</span><span class="n">mts</span> <span class="o">=</span> <span class="n">mts</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">multiple_events_forward_task</span><span class="p">()</span>
            <span class="n">mts</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c1"># Close logger</span>
        <span class="c1"># Output data</span>
        <span class="n">output_data</span><span class="p">,</span> <span class="n">output_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Print output string</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">:</span> <span class="n">output_data</span><span class="p">,</span> <span class="s1">&#39;event_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_data</span><span class="p">,</span> <span class="s1">&#39;location_samples&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">,</span>
                <span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">CombineMpiOutputTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task for combining MPI output</span>

<span class="sd">    Combines and  saves mpi (hyp) output (including scale factors from relative inversion)</span>

<span class="sd">    Initialisation</span>

<span class="sd">        Args</span>
<span class="sd">            uid: UID for combining.</span>
<span class="sd">            format: [&#39;matlab&#39;] Output format</span>
<span class="sd">            results_format: [&#39;full_pdf&#39;] Set result format</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="n">results_format</span><span class="o">=</span><span class="s1">&#39;full_pdf&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of CombineMpiOutputTask</span>

<span class="sd">        Args</span>
<span class="sd">            uid: UID for combining.</span>
<span class="sd">            format: Output format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">results_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary_file_version</span> <span class="o">=</span> <span class="n">binary_file_version</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the mpi output combining task</span>

<span class="sd">        Runs the CombineMpiOutputTask and returns a result code.</span>

<span class="sd">        Returns</span>
<span class="sd">            resultCode: 10 if successful.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Combining </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
        <span class="c1"># Get hyp, mt and sf files</span>
        <span class="n">hypfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">+</span><span class="s1">&#39;.*.hyp&#39;</span><span class="p">)</span>
        <span class="n">fids</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">+</span><span class="s1">&#39;.*.mt&#39;</span><span class="p">)</span>
        <span class="n">scale_factor_fids</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">+</span><span class="s1">&#39;.*.sf&#39;</span><span class="p">)</span>
        <span class="n">inv_fid</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;DC&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.inv&#39;</span><span class="p">)</span>
        <span class="c1"># Try to use the pkl file as input</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">+</span><span class="s1">&#39;.0.pkl&#39;</span><span class="p">))</span>
            <span class="c1"># Check fids exist (haven&#39;t moved the files)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fids&#39;</span><span class="p">]]):</span>
                <span class="n">fids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fids&#39;</span><span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inv_fid</span><span class="p">):</span>
                <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">data_file</span><span class="o">=</span><span class="n">inv_fid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
        <span class="c1"># Otherwise use the datafile or hypfile</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inv_fid</span><span class="p">):</span>
                <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">data_file</span><span class="o">=</span><span class="n">inv_fid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">hypfiles</span><span class="p">):</span>
                <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">data_file</span><span class="o">=</span><span class="n">hypfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parallel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
        <span class="c1"># Combine MPI output</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inversion</span><span class="o">.</span><span class="n">_combine_mpi_output</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fids</span><span class="p">,</span> <span class="n">scale_factor_fids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">results_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results_format</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binary_file_version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="mi">10</span>


<span class="c1">#</span>
<span class="c1"># Inversion object</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">Inversion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main Inversion object</span>

<span class="sd">    Runs the MT inversion, follwing a parameterisation set on initialisation. Parameters can be set for the algorithm to use in the kwargs.</span>

<span class="sd">    Algorithm options are:</span>

<span class="sd">        * Time - Monte Carlo random sampling - runs until time limit reached.</span>
<span class="sd">        * Iterate - Monte Carlo random sampling - runs until sample limit reached.</span>
<span class="sd">        * McMC - Markov chain Monte Carlo sampling.</span>
<span class="sd">        * TransDMcMC - Markov chain Monte Carlo sampling.</span>

<span class="sd">    These are discussed in more detail in the MTfit.algorithms documentation.</span>

<span class="sd">    The inversion is run by calling the forward function (MTfit.inversion.Inversion.forward)</span>

<span class="sd">    **Data Format**</span>

<span class="sd">    The inversion expects a python dictionary of the data in the format::</span>

<span class="sd">        &gt;&gt;data={&#39;PPolarity&#39;:{&#39;Measured&#39;:numpy.matrix([[-1],[-1]...]),</span>
<span class="sd">                             &#39;Error&#39;:numpy.matrix([[0.01],[0.02],...]),</span>
<span class="sd">                             &#39;Stations&#39;:{&#39;Name&#39;:[Station1,Station2,...]</span>
<span class="sd">                                         &#39;Azimuth&#39;:numpy.matrix([[248.0],[122.3]...]),</span>
<span class="sd">                                         &#39;TakeOffAngle&#39;:numpy.matrix([[24.5],[2.8]...])</span>
<span class="sd">                                        }</span>
<span class="sd">                         },</span>
<span class="sd">                &#39;PSHAmplitudeRatio&#39;:{...},</span>
<span class="sd">                ...</span>
<span class="sd">                &#39;UID&#39;:&#39;Event1&#39;</span>
<span class="sd">                }</span>

<span class="sd">    The initial key arguments correspond to the data types that can be used in the inversion. The inversion uses polarity observations and amplitude ratios, and can also use relative amplitudes.</span>
<span class="sd">    This means that the useable data types are:</span>

<span class="sd">        **Polarity**</span>

<span class="sd">            * PPolarity</span>
<span class="sd">            * SHPolarity</span>
<span class="sd">            * SVPolarity</span>

<span class="sd">            Polarity observations made manually or automatically. The corresponding data dictionary for polarities needs the following keys:</span>

<span class="sd">                * *Measured*: numpy matrix of polarity observations</span>
<span class="sd">                * *Error*: numpy matrix of fractional uncertainty in the polarity observations.</span>
<span class="sd">                * *Stations*: dictionary of station information with keys:</span>

<span class="sd">                    * *Name*: list of station names</span>
<span class="sd">                    * *Azimuth*: numpy matrix of azimuth values in degrees</span>
<span class="sd">                    * *TakeOffAngle*: numpy matrix of take off angle values in degrees - 0 down (NED coordinate system).</span>

<span class="sd">            As with all of these dictionaries, the indexes of the observations and errors must correspond to the stations, i.e. `data[&#39;Measured&#39;][0,0]` -&gt; from `data[&#39;Stations&#39;][&#39;Name&#39;][0]` with `error data[&#39;Error&#39;][0,:]` etc.</span>

<span class="sd">            If polarity probabilities are being used, the keys are:</span>

<span class="sd">                * PPolarityProbability</span>
<span class="sd">                * SHPolarityProbability</span>
<span class="sd">                * SVPolarityProbability</span>

<span class="sd">            With a similar structure to the Polarity data, except the measured matrix has an additional dimension, i.e. `data[&#39;Measured&#39;][0,0]` is the positive polarity probability and `data[&#39;Measured&#39;][0,1]` is the negative polarity probability.</span>

<span class="sd">        **Amplitude ratios**</span>

<span class="sd">            * P/SHRMSAmplitudeRatio</span>
<span class="sd">            * P/SVRMSAmplitudeRatio</span>
<span class="sd">            * SH/SVRMSAmplitudeRatio</span>
<span class="sd">            * P/SHQRMSAmplitudeRatio</span>
<span class="sd">            * P/SVQRMSAmplitudeRatio</span>
<span class="sd">            * SH/SVQRMSAmplitudeRatio</span>
<span class="sd">            * P/SHAmplitudeRatio</span>
<span class="sd">            * P/SVAmplitudeRatio</span>
<span class="sd">            * SH/SVAmplitudeRatio</span>
<span class="sd">            * P/SHQAmplitudeRatio</span>
<span class="sd">            * P/SVQAmplitudeRatio</span>
<span class="sd">            * SH/SVQAmplitudeRatio</span>

<span class="sd">            Amplitude ratio observations made manually or automatically. The Q is not necessary but is useful to label the amplitudes with a Q correction.</span>
<span class="sd">            The corresponding data dictionary for amplitude ratios needs the following keys:</span>

<span class="sd">                * *Measured*: numpy matrix of corrected numerator and denominator amplitude ratio observations, needs to have two columns, one for the numerator and one for the denominator.</span>
<span class="sd">                * *Error*: numpy matrix of uncertainty (standard deviation) in the amplitude ratio observations, needs to have two columns, one for the numerator and one for the denominator.</span>
<span class="sd">                * *Stations*: dictionary of station information with keys:</span>

<span class="sd">                    * *Name*: list of station names</span>
<span class="sd">                    * *Azimuth*: numpy matrix of azimuth values in degrees</span>
<span class="sd">                    * *TakeOffAngle*: numpy matrix of take off angle values in degrees - 0 down (NED coordinate system).</span>

<span class="sd">            As with all of these dictionaries, the indexes of the observations and errors must correspond to the stations, i.e. `data[&#39;Measured&#39;][0,0]` -&gt; from `data[&#39;Stations&#39;][&#39;Name&#39;][0]` with `error data[&#39;Error&#39;][0,:]` etc.</span>

<span class="sd">        **Relative Amplitude Ratios**</span>

<span class="sd">            * PAmplitude</span>
<span class="sd">            * SHAmplitude</span>
<span class="sd">            * SVAmplitude</span>
<span class="sd">            * PQAmplitude</span>
<span class="sd">            * SHQAmplitude</span>
<span class="sd">            * SVQAmplitude</span>
<span class="sd">            * PRMSAmplitude</span>
<span class="sd">            * SHRMSAmplitude</span>
<span class="sd">            * SVRMSAmplitude</span>
<span class="sd">            * PQRMSAmplitude</span>
<span class="sd">            * SHQRMSAmplitude</span>
<span class="sd">            * SVQRMSAmplitude</span>

<span class="sd">            Relative Amplitude ratios use amplitude observations for different events made manually or automatically. The Q is not necessary but is useful to label the amplitudes with a Q correction.</span>
<span class="sd">            The corresponding data dictionary for amplitude ratios needs the following keys:</span>

<span class="sd">                * *Measured*: numpy matrix of amplitude observations for the event.</span>
<span class="sd">                * *Error*: numpy matrix of uncertainty (standard deviation) in the amplitude observations.</span>
<span class="sd">                * *Stations*: dictionary of station information with keys:</span>

<span class="sd">                    * *Name*: list of station names</span>
<span class="sd">                    * *Azimuth*: numpy matrix of azimuth values in degrees</span>
<span class="sd">                    * *TakeOffAngle*: numpy matrix of take off angle values in degrees - 0 down (NED coordinate system).</span>

<span class="sd">            As with all of these dictionaries, the indexes of the observations and errors must correspond to the stations, i.e. `data[&#39;Measured&#39;][0,0]` -&gt; from `data[&#39;Stations&#39;][&#39;Name&#39;][0]` with `error data[&#39;Error&#39;][0,:]` etc.</span>



<span class="sd">    **Angle Scatter Format**</span>
<span class="sd">    The angle scatter files can be generated using a utility Scat2Angle based on the NonLinLoc angle code. The angle scatter file is a text file with samples separated by blank lines.</span>
<span class="sd">    The expected format is for samples from the location PDF that have been converted into take off and azimuth angles (in degrees) for the stations, along with a probability value. It is important that the samples are drawn</span>
<span class="sd">    from the location PDF as a Monte Carlo based integration approach is used for marginalising over the uncertainty.</span>

<span class="sd">    It is possible to use XYZ2Angle to samples drawn from a location PDF using the NonLinLoc angle approach.</span>

<span class="sd">    Expected format is::</span>

<span class="sd">        Probability</span>
<span class="sd">        StationName Azimuth TakeOffAngle</span>
<span class="sd">        StationName Azimuth TakeOffAngle</span>

<span class="sd">        Probability</span>
<span class="sd">        .</span>
<span class="sd">        .</span>
<span class="sd">        .</span>

<span class="sd">    With TakeOffAngle as 0 down (NED coordinate system).</span>
<span class="sd">    e.g.::</span>
<span class="sd">        504.7</span>
<span class="sd">        S0271   231.1   154.7</span>
<span class="sd">        S0649   42.9    109.7</span>
<span class="sd">        S0484   21.2    145.4</span>
<span class="sd">        S0263   256.4   122.7</span>
<span class="sd">        S0142   197.4   137.6</span>
<span class="sd">        S0244   229.7   148.1</span>
<span class="sd">        S0415   75.6    122.8</span>
<span class="sd">        S0065   187.5   126.1</span>
<span class="sd">        S0362   85.3    128.2</span>
<span class="sd">        S0450   307.5   137.7</span>
<span class="sd">        S0534   355.8   138.2</span>
<span class="sd">        S0641   14.7    120.2</span>
<span class="sd">        S0155   123.5   117</span>
<span class="sd">        S0162   231.8   127.5</span>
<span class="sd">        S0650   45.9    108.2</span>
<span class="sd">        S0195   193.8   147.3</span>
<span class="sd">        S0517   53.7    124.2</span>
<span class="sd">        S0004   218.4   109.8</span>
<span class="sd">        S0588   12.9    128.6</span>
<span class="sd">        S0377   325.5   165.3</span>
<span class="sd">        S0618   29.4    120.5</span>
<span class="sd">        S0347   278.9   149.5</span>
<span class="sd">        S0529   326.1   131.7</span>
<span class="sd">        S0083   223.7   118.2</span>
<span class="sd">        S0595   42.6    117.8</span>
<span class="sd">        S0236   253.6   118.6</span>

<span class="sd">        502.7</span>
<span class="sd">        S0271   233.1   152.7</span>
<span class="sd">        S0649   45.9    101.7</span>
<span class="sd">        S0484   25.2    141.4</span>
<span class="sd">        S0263   258.4   120.7</span>
<span class="sd">        .</span>
<span class="sd">        .</span>
<span class="sd">        .</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;iterate&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phy_mem</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of inversion object</span>

<span class="sd">        Args:</span>

<span class="sd">            data (dict/list): Dictionary or list of dictionaries containing data for inversion. Can be ignored if a data_file is passed as an argument (for data format, see below).</span>
<span class="sd">            data_file (str): Path or list of file paths containing (binary) pickled data dictionaries.</span>
<span class="sd">            location_pdf_file_path (str): Path or list of file paths to angle scatter files (for file format, see above - other format extensions can be added using setuptools entry points).</span>
<span class="sd">            algorithm (str):[&#39;iterate&#39;] algorithm selector</span>
<span class="sd">            parallel (bool):[True] Run the inversion in parallel using multiprocessing</span>
<span class="sd">            n (int):[0] Number of workers, default is to use as many as returned by multiprocessing.cpu_count</span>
<span class="sd">            phy_mem (int):[8] Estimated physical memory to use (used for determining array sizes, it is likely that more memory will be used, and if so no errors are forced).</span>
<span class="sd">                 *On python versions &lt;2.7.4 there is a bug (http://bugs.python.org/issue13555) with pickle that limits the total number of samples when running in parallel, so large (&gt;20GB) phy_mem allocations per process are ignored.*</span>
<span class="sd">            dc (bool):[False] Boolean flag as to run inversion constrained to double-couple or allowed to explore the full moment tensor space.</span>

<span class="sd">        Keyword Arguments:</span>

<span class="sd">            number_stations (int):[0] Used for estimating sample sizes in the Monte Carlo random sampling algorithms (Time,Iterate) if set.</span>
<span class="sd">            number_location_samples (int):[0] Used for estimating sample sizes in the Monte Carlo random sampling algorithms (Time,Iterate) if set.</span>
<span class="sd">            path (str): File path for output. Default is current working dir (interactive) or PBS workdir.</span>
<span class="sd">            fid (str): File name root for output, default is to use MTfitOutput or the event UID if set in the data dictionary.</span>
<span class="sd">            inversion_options (list): List of data types to be used in the iversion, if not set, the inversion uses all the data types in the data dictionary, irrespective of independence.</span>
<span class="sd">            diagnostic_output (bool): [False] Boolean flag to output diagnostic information in MATLAB save file.</span>
<span class="sd">            marginalise_relative (bool): [False] Boolean flag to marginalise over location/model uncertainty during relative amplitude inversion.</span>
<span class="sd">            mpi (bool): [False] Boolean flag to run using MPI from mpi4py (useful on cluster).</span>
<span class="sd">            multiple_events (bool): [False] Boolean flag to run all the events in the inversion in one single joint inversion.</span>
<span class="sd">            relative_amplitude (bool): [False] Boolean flag to run multiple_events including relative amplitude inversion.</span>
<span class="sd">            output_format (str): [&#39;matlab&#39;] str format style.</span>
<span class="sd">            minimum_number_intersections (int): [2] Integer minimum number of station intersections between events in relative amplitude inversion.</span>
<span class="sd">            quality_check (bool): [False] Boolean flag/Float value for maximum non-zero percentage check (stops inversion if event quality is poor)</span>
<span class="sd">            recover (bool): [False] Tries to recover pre-existing inversions, and does not re-run if an output file exists and is readable.</span>
<span class="sd">            file_sample (bool): [False] Saves samples to a mat file (allowing for easier recovery and reduced memory requirements but can slow the inversion down as requires disk writing every non-zero iteration. Only works well for recovery with random sampling methods)</span>
<span class="sd">            results_format (str): [&#39;full_pdf&#39;] Data format for the output</span>
<span class="sd">            marginalise_relative (bool): [False] Boolean flag to marginalise the location uncertainty between absolute and relative data.</span>
<span class="sd">            file_sample (bool): [False] save samples to file rather than keeping in memory (not necessary in normal use).</span>
<span class="sd">            normalise (bool): [True] normalise output Probability (doesn&#39;t affect ln_pdf output).</span>
<span class="sd">            convert (bool):  Convert output moment tensors to Tape parameters, Hudson u&amp;v coordinates and strike-dip-rake triples.</span>
<span class="sd">            discard (bool): [False] Probability cut-off for discarding samples Discarding samples - samples less than 1/(discard*n_samples) of the maximum likelihood value are discarded as negligeable. False means no samples are discarded.</span>
<span class="sd">            c_generate (bool): [False] Generate samples in the probability calculation when using Cython.</span>
<span class="sd">            generate_cutoff (int): Set number of samples to cut-off at when using c_generate (Default is the value of max_samples)</span>
<span class="sd">            relative_loop (bool): [False] Loop over non-zero samples when using relative amplitudes.</span>
<span class="sd">            bin_angle_coefficient_samples (int): [0] Bin size in degrees when binning angle coefficients (All station angle differences must be within this range for samples to fall in the same bin)</span>
<span class="sd">            no_station_distribution (bool): [True] Boolean flag to output station distribution or not.</span>
<span class="sd">            max_samples (int): [6000000] Max number of samples when using the iterate algorithm.</span>
<span class="sd">            max_time (int): [600] Max time when using the time algorithm.</span>
<span class="sd">            verbosity (int): [0] Set verbosity level (0-4) high numbers mean more logging output and verbosity==4 means the debugger will be called on errors.</span>
<span class="sd">            debug (bool): [False] Sets debug on or off (True means verbosity set to 4).</span>

<span class="sd">        Other kwargs are passed to the algorithm - see MTfit.algorithms documentation for help on those.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;marginalise_relative&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_sample&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># If data and data_file doesn&#39;t exist, try to read sys.argv</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># Set MPI parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mpi&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Running MTfit using MPI&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Set DC parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Double Couple Constrained Inversion</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Full Moment Tensor Inversion</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Parse data_files to data_dict</span>
        <span class="k">if</span> <span class="n">data_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*********</span><span class="se">\n</span><span class="s1">data files: &#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_file</span><span class="p">))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">data_file</span><span class="p">:</span>
                    <span class="n">file_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*********</span><span class="se">\n</span><span class="s1">data file: &#39;</span><span class="o">+</span><span class="n">data_file</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
        <span class="c1"># Raise error if no data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Inversion requires an input data_file or data dictionary&#39;</span><span class="p">)</span>
        <span class="c1"># Set data parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">number_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
            <span class="n">number_events</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Check multiple events flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Check number of events vs. multiple events</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span> <span class="ow">and</span> <span class="n">number_events</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">:</span>
            <span class="n">number_events</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Set more parameters from kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_events</span> <span class="o">=</span> <span class="n">number_events</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;normalise&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;convert&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discard&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_generate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c_generate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relative_loop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_angle_coefficient_samples</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_angle_coefficient_samples&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">number_stations</span> <span class="o">=</span> <span class="mi">40</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_location_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Get Debug and verbositu arguments</span>
        <span class="k">global</span> <span class="n">_DEBUG</span>
        <span class="k">global</span> <span class="n">_VERBOSITY</span>
        <span class="n">_VERBOSITY</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbosity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">_DEBUG</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_DEBUG</span><span class="p">:</span>
            <span class="n">_VERBOSITY</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># Handle location PDFs</span>
        <span class="k">if</span> <span class="n">location_pdf_file_path</span><span class="p">:</span>
            <span class="c1"># Get number of location samples</span>
            <span class="n">number_location_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_location_samples&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number_location_samples</span> <span class="o">=</span> <span class="n">number_location_samples</span>
            <span class="c1"># Get number of stations</span>
            <span class="n">number_stations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_stations&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">location_pdf_file_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="o">=</span> <span class="n">location_pdf_file_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Search in location_pdf_file_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">location_pdf_file_path</span><span class="p">)</span>
            <span class="c1"># Get number of stations and number of location samples</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">number_stations</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">number_location_samples</span><span class="p">:</span>
                <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_location</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">number_location_samples</span><span class="p">:</span>
                    <span class="n">number_location_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">)</span>
                <span class="n">number_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Clear results and garbage collect</span>
                <span class="k">del</span> <span class="n">location_samples</span>
                <span class="k">del</span> <span class="n">location_sample_multipliers</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No location PDFs</span>
            <span class="n">number_location_samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_stations</span> <span class="o">=</span> <span class="n">number_stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_events</span> <span class="o">=</span> <span class="n">number_events</span>
        <span class="c1"># Print out location PDF files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Angle Scatter files: &#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span><span class="p">))</span>
        <span class="c1"># Set run parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*********</span><span class="se">\n\n</span><span class="s1">Run parameters</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_format</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_format&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results_format&#39;</span><span class="p">,</span> <span class="s1">&#39;full_pdf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_station_distribution</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_station_distribution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_samples&#39;</span><span class="p">,</span> <span class="mi">6000000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_time</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_time&#39;</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
        <span class="c1"># Set worker parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_params</span><span class="p">(</span><span class="n">parallel</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">phy_mem</span><span class="p">)</span>
        <span class="c1"># Check parallel parameters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="n">number_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;MPI: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_workers</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; workers&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Multi-threaded: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_workers</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; workers&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Single-threaded&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minimum_number_intersections&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_quality_check</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quality_check&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;generate_cutoff&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_sample&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fid&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_recover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recover&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;file_sample&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">data_file_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Check if the shell is interactive and get local path,otherwise get workdir path</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;PBS_ENVIRONMENT&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;interactive&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_ENVIRONMENT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">([</span><span class="n">env</span> <span class="k">for</span> <span class="n">env</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;PBS&#39;</span> <span class="ow">in</span> <span class="n">env</span> <span class="ow">and</span> <span class="n">env</span> <span class="o">!=</span> <span class="s1">&#39;PBS_DEFAULT&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">default_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PBS_O_WORKDIR&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="c1"># If path set in kwargs, get that path instead</span>
        <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="n">default_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">data_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">data_file_path</span>
        <span class="k">elif</span> <span class="n">data_file_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_file_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">default_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;diagnostic_output&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mpi_output&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Algorithm: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Algorithm Options: </span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*********</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MPI safe print (rank 0 only unless forced)&quot;&quot;&quot;</span>
        <span class="c1"># If MPI, only print if rank 0</span>
        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to load data</span>

<span class="sd">        Args</span>
<span class="sd">            filename: filename of binary pickled dictionary or csv file to load</span>

<span class="sd">        Returns</span>
<span class="sd">            data: Loaded data from filename or False if exception thrown.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Parser plug-in extensions.</span>
                <span class="n">parser_names</span><span class="p">,</span> <span class="n">parsers</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.parsers&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;.csv&#39;</span><span class="p">:</span> <span class="n">parse_csv</span><span class="p">,</span> <span class="s1">&#39;.hyp&#39;</span><span class="p">:</span> <span class="n">parse_hyp</span><span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">parsers</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">filename</span><span class="p">)</span>
                    <span class="c1"># Else try all the parsers</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="n">parsers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># If errors then try to parse csv and then parse hyp</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">parse_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">parse_hyp</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parsers available are: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">parsers</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data available using available parsers:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parser_names</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_read_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the location PDF file</span>

<span class="sd">        Function allows for extension to other location format types (default is scatangle using parse_scatangle)</span>

<span class="sd">        Expected plugin type is to match a file extension and return the sample_records,sample_probability where sample records is a list of the sample records::</span>

<span class="sd">        sample_records=[{&#39;Name&#39;:[&#39;S001&#39;,&#39;S002&#39;,...],&#39;Azimuth&#39;:np.matrix([[121.],[37.],...]),&#39;TakeOffAngle&#39;:np.matrix([[88.],[12.],...])},</span>
<span class="sd">         {&#39;Name&#39;:[&#39;S001&#39;,&#39;S002&#39;,...],&#39;Azimuth&#39;:np.matrix([[120.],[36.],...]),&#39;TakeOffAngle&#39;:np.matrix([[87.],[11.],...])}]</span>
<span class="sd">        sample_probability=[0.8,1.2,...]</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parser_names</span><span class="p">,</span> <span class="n">parsers</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.location_pdf_parsers&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;.scatangle&#39;</span><span class="p">:</span> <span class="n">parse_scatangle</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to call the plugin for the correct extension</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">parsers</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># Else try with all the parsers</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">parser</span> <span class="ow">in</span> <span class="n">parsers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">parser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parser_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># If not built correctly, can load scatangle file</span>
                <span class="k">return</span> <span class="n">parse_scatangle</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_set_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets file loggers up&quot;&quot;&quot;</span>
        <span class="c1"># now = datetime.datetime.now()</span>
        <span class="c1"># If mpi, only set loggers if rank 0</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_logger</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_logger</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_close_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes file loggers&quot;&quot;&quot;</span>
        <span class="c1"># If mpi, only close loggers if rank 0 (no other loggers opened])</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_logger</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up algorithm for inversion</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">            keyword arguments for algorithm configuration</span>

<span class="sd">        For information on the kwargs, see the MTfit.Algorithm docstrings.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">McMC</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># If no algorithm is set - use BaseAlgorithm (Will not behave as expected, but used for testing)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">BaseAlgorithm</span><span class="p">(</span><span class="n">number_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">quality_check</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quality_check</span><span class="p">,</span>
                                           <span class="n">number_events</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">,</span> <span class="n">file_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span><span class="p">,</span>
                                           <span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fid&#39;</span><span class="p">,</span> <span class="s1">&#39;MTfit_run&#39;</span><span class="p">),</span> <span class="n">file_safe</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_file_safe&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                           <span class="n">sampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">sampling_prior</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                           <span class="n">sample_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="c1"># Iterate algorithm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;iterate&#39;</span><span class="p">]:</span>
            <span class="n">max_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span>
            <span class="n">number_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="n">single</span><span class="p">:</span>
                <span class="c1"># set max samples divided by n_workers</span>
                <span class="n">max_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span>
                <span class="n">number_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">,</span> <span class="n">max_samples</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Iterate algorithm chosen, maximum samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; across &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; processes - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_samples</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; per process&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Iterate algorithm chosen, maximum samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">IterationSample</span><span class="p">(</span><span class="n">number_samples</span><span class="o">=</span><span class="n">number_samples</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">max_samples</span><span class="o">=</span><span class="n">max_samples</span><span class="p">,</span>
                                             <span class="n">quality_check</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quality_check</span><span class="p">,</span> <span class="n">number_events</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">,</span>
                                             <span class="n">file_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fid&#39;</span><span class="p">,</span> <span class="s1">&#39;MTfit_run&#39;</span><span class="p">),</span>
                                             <span class="n">file_safe</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_file_safe&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                             <span class="n">generate</span><span class="o">=</span><span class="n">single</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_generate</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                             <span class="n">sampling_prior</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                             <span class="n">sample_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">single</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_generate</span><span class="p">:</span>
                <span class="c1"># Set generate cutoff size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="o">/</span><span class="mi">5</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span> <span class="o">=</span> <span class="n">max_samples</span>
        <span class="c1"># Time algorithm</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Time algorithm chosen, maximum time: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">TimeSample</span><span class="p">(</span><span class="n">number_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">max_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_time</span><span class="p">,</span>
                                        <span class="n">quality_check</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quality_check</span><span class="p">,</span> <span class="n">number_events</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">,</span>
                                        <span class="n">file_sample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fid&#39;</span><span class="p">,</span> <span class="s1">&#39;MTfit_run&#39;</span><span class="p">),</span>
                                        <span class="n">file_safe</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_file_safe&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                        <span class="n">generate</span><span class="o">=</span><span class="n">single</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_generate</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                        <span class="n">sampling_prior</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                        <span class="n">sample_distribution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">single</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_generate</span><span class="p">:</span>
                <span class="c1"># Set generate sample size, cutoff is default or set in initialisation</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span><span class="o">/</span><span class="mi">5</span>
        <span class="c1"># Algorithm extensions</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.parallel_algorithms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">extension_algorithms</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.parallel_algorithms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">extension_algorithms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># McMC algorithm</span>
        <span class="k">elif</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.directed_algorithms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;transd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;trans_dimensional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;trans_dimensional&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.directed_algorithms&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">McMC</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">MarkovChainMonteCarloAlgorithmCreator</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_cython</span><span class="o">=</span><span class="n">cprobability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update number of samples based on available memory etc.</span>

<span class="sd">        Args</span>
<span class="sd">            show:[True] Print result to stdout</span>
<span class="sd">            _cython: If cython code is being used - default is set by the parameter cprobability which is &quot;&quot;&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cprobability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># Get number of floats from available memory</span>
        <span class="n">nfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_floatmem</span><span class="o">/</span><span class="mf">8.</span>
        <span class="c1"># Get number of location PDF samples</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">number_location_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">number_location_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_location_samples</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">number_location_samples</span><span class="p">:</span>
            <span class="n">number_location_samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">number_location_samples</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span>
        <span class="n">D</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span>
        <span class="c1"># Calculation allows for a bit of overflow...</span>
        <span class="c1"># Calculation depends on Cython or not.</span>
        <span class="k">if</span> <span class="n">_cython</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">:</span>
                <span class="n">number_samples</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="p">(</span><span class="n">nfloats</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">D</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_samples</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="p">(</span><span class="n">nfloats</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">D</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">:</span>
                <span class="n">number_samples</span> <span class="o">=</span> <span class="mf">0.01</span><span class="o">*</span><span class="p">(</span><span class="n">nfloats</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">D</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span><span class="o">*</span><span class="n">number_location_samples</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">number_location_samples</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_samples</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="p">(</span><span class="n">nfloats</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">A</span><span class="o">+</span><span class="mi">6</span><span class="o">*</span><span class="n">D</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span><span class="o">*</span><span class="n">number_location_samples</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="n">number_samples</span> <span class="o">/=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">number_samples</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">):</span>
            <span class="c1"># Check for pickle bug #13555 http://bugs.python.org/issue13555 which seems linked to multiprocessing issue #17560 http://bugs.python.org/issue17560</span>
            <span class="c1"># cannot pickle files longer than 2**31 (32 bit encoding used for pickle length)</span>
            <span class="c1"># Possible fix https://stackoverflow.com/questions/15118344/system-error-while-running-subprocesses-using-multiprocessing</span>
            <span class="n">number_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([((</span><span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)),</span> <span class="n">number_samples</span><span class="p">])</span>
        <span class="c1"># Bodge to prevent memory usage above limit</span>
        <span class="n">number_samples</span> <span class="o">/=</span> <span class="mi">20</span>
        <span class="c1"># If estiamted total number of samples &lt;1 raise an error.</span>
        <span class="k">if</span> <span class="n">number_samples</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Warning - possible memory error, number of samples less than 1&#39;</span><span class="p">)</span>
            <span class="n">number_samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># If iterate, check against max samples set (don&#39;t want to evaluate more than that in one sample).</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_algorithm_name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_algorithm_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;iterate&#39;</span><span class="p">]:</span>
            <span class="n">number_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">number_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Number of Random Samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">number_samples</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; with &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">number_location_samples</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; location samples and &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; stations&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number_samples</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;number_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_samples</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_worker_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phy_mem</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines worker parameters for inversion</span>

<span class="sd">        Determines the sample sizes and worker parameters for the inversion.</span>

<span class="sd">        Args</span>
<span class="sd">            parallel:[True] Boolean flag for running in parallel</span>
<span class="sd">            n:[0] Number of workers to generate, if 0 uses the number returned by multiprocessing.cpu_count()</span>
<span class="sd">            phy_mem:[0] Estimated physical memory to use (used for determining array sizes, it is likely that more memory will be used, and if so no errors are forced).</span>
<span class="sd">            number_location_samples:[1] Number of station samples (angle scatter samples) used in the inversion - again used for determing array sizes.</span>
<span class="sd">            number_events:[1] Number of events - used for determing sample sizes</span>
<span class="sd">            number_stations:[40] Number of stations - used for determing sample sizes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if on cluster or otherwise.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;PBS_&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PBS</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">PBS</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Check for pool</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_pool</span><span class="p">()</span>
        <span class="c1"># Get number of processors available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBS</span><span class="p">:</span>
            <span class="c1"># If PBS get number of nodes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NUM_PPN&#39;</span><span class="p">])</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PBS_NUM_NODES&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Check parallel - close pool if MPI or only on processor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parallel</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_pool</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">n</span><span class="p">:</span>
            <span class="c1"># Set pool for bumber of workers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">JobPool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">ForwardTask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get number of workers from multiprocessing</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="ow">or</span> <span class="mi">1</span>  <span class="c1"># Check CPU count if errors use 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">JobPool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">ForwardTask</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_number_workers</span> <span class="o">=</span> <span class="n">n</span>
        <span class="c1"># Amount of memory available for calculations (Can cause problems for very large non-zero percentages)</span>
        <span class="n">mem_scale</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="c1"># Set available float memory</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phy_mem</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">psutil</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_floatmem</span> <span class="o">=</span> <span class="n">mem_scale</span><span class="o">*</span><span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">available</span><span class="o">/</span><span class="n">n</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">phy_mem</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_floatmem</span> <span class="o">=</span> <span class="n">mem_scale</span><span class="o">*</span><span class="n">phy_mem</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mf">1024.</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_floatmem</span> <span class="o">=</span> <span class="n">mem_scale</span><span class="o">*</span><span class="n">phy_mem</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mf">1024.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="c1"># calculate data size</span>
        <span class="n">max_data</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_data_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">,</span> <span class="s1">&#39;hyp_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                        <span class="n">max_data_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">max_data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_data_size</span> <span class="o">=</span> <span class="n">max_data_size</span>
        <span class="c1"># Calculate Sample Size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_samples</span><span class="p">(</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes pool and exits, allowing object to be deleted.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_close_pool</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_close_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Closes and removes JobPool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_combine_mpi_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">,</span> <span class="n">fids</span><span class="p">,</span> <span class="n">scale_factor_fids</span><span class="o">=</span><span class="p">[],</span> <span class="n">fid</span><span class="o">=</span><span class="s1">&#39;MTfitOutput.mat&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combine mpi output binary files - Rank 0 only</span>

<span class="sd">        Args:</span>
<span class="sd">        event_data: Event data dictionary</span>
<span class="sd">        fids: storage fids</span>
<span class="sd">        scale_factor_fids:[[]] Scale_factor fids if relative amplitudes are used.</span>
<span class="sd">        fid=[MTfitOutput.mat] Output filename.</span>
<span class="sd">        output_data:[False] Output data (Stations etc.)</span>
<span class="sd">        location_samples:[False] Location PDF samples</span>
<span class="sd">        location_sample_multipliers:[False] Location PDF sample probabilities (should be one for Oct-tree samples)</span>
<span class="sd">        format=[matlab] Output format.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get old results format</span>
        <span class="n">old_results_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span>
        <span class="c1"># Check kwargs for update format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results_format&#39;</span><span class="p">,</span> <span class="n">old_results_format</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------Combining MPI Output-----------&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Loop over fids</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mpi_fid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fids</span><span class="p">):</span>
            <span class="c1"># Get mt files</span>
            <span class="n">mt_fid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mpi_fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mt&#39;</span>
            <span class="c1"># Read mt output in.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="c1"># No files read</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">read_binary_output</span><span class="p">(</span><span class="n">mt_fid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">binary_file_version</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">binary_output</span> <span class="o">=</span> <span class="n">read_binary_output</span><span class="p">(</span><span class="n">mt_fid</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">binary_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">binary_output</span> <span class="o">=</span> <span class="n">binary_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">binary_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">binary_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event_output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">binary_output</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">event_output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event_output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;dkl&#39;</span><span class="p">]:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Updated later</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">event_output</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">binary_output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span>
                                <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">binary_output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;dkl&#39;</span><span class="p">]:</span>
                                <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Updated later</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">binary_output</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Handle Scale factors if they exist.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_factor_fids</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scale_factor_fids</span><span class="p">):</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.sf&#39;</span>
                <span class="c1"># Read scale_factors</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">read_sf_output</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">scale_factors_output</span> <span class="o">=</span> <span class="n">read_sf_output</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factors_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_factors_output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">scale_factors_output</span> <span class="o">=</span> <span class="n">scale_factors_output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factors_output</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale_factors_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event_scale_factors</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scale_factors_output</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">event_scale_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span>
                                        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event_scale_factors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;dkl&#39;</span><span class="p">]:</span>
                                        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Updated later</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">event_scale_factors</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scale_factors_output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">scale_factors_output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;dkl&#39;</span><span class="p">]:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Updated later</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">scale_factors_output</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Output - handle special cases</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln_bayesian_evidence</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;g&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;g&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;g&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;d&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
                            <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;dkl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dkl_estimate</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="n">V</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;dV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;dV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln_bayesian_evidence</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;dkl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dkl_estimate</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="n">V</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># format specifics - output for MATLAB only is first</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event_output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="n">fid_i</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">fid_i</span><span class="p">,</span> <span class="n">event_output</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Reset output format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">old_results_format</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="s1">&#39;MTfitOutput.mat&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs event_data results to fid</span>

<span class="sd">        Default output format is matlab.</span>

<span class="sd">        Args</span>
<span class="sd">            event_data: data dictionary for the event_data.</span>
<span class="sd">            fid:[&#39;MTfitOutput.mat&#39;] Filename for output.</span>
<span class="sd">            Algorithm:[False] Algorith for output - only needed if multiple event_datas/algorithms used</span>
<span class="sd">            location_samples:[False] Station angle scatter samples.</span>
<span class="sd">            location_sample_multipliers:[False] Station angle scatter probabilities.</span>
<span class="sd">            output_format:[&#39;matlab&#39;] output format.</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">            station_only:[False] Only output station data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Saving&#39;</span><span class="p">)</span>
        <span class="c1"># Check location samples</span>
        <span class="k">if</span> <span class="n">location_samples</span> <span class="ow">and</span> <span class="n">location_sample_multipliers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_station_distribution</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;location_samples&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">):</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers_original</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_station_distribution</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span>
            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers_original</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_station_distribution</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Check if output data exists (or just outputting data)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">output_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;station_only&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">output_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span> <span class="ow">or</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">())))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                    <span class="n">output_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-MTfit Forward Model Output-&#39;</span><span class="p">,</span> <span class="s1">&#39;-MTfit Forward Model Output Process &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;station_only&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># get results format</span>
        <span class="n">output_data_names</span><span class="p">,</span> <span class="n">output_data_formats</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.output_data_formats&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;full_pdf&#39;</span><span class="p">:</span> <span class="n">full_pdf_output_dicts</span><span class="p">,</span> <span class="s1">&#39;hyp&#39;</span><span class="p">:</span> <span class="n">hyp_output_dicts</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try to call the plugin for the correct extension&#39;</span>
            <span class="k">if</span> <span class="n">output_format</span> <span class="ow">and</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hyp&#39;</span><span class="p">:</span>
                <span class="n">out_data</span> <span class="o">=</span> <span class="n">output_data_formats</span><span class="p">[</span><span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()](</span><span class="n">event_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_data</span> <span class="o">=</span> <span class="n">output_data_formats</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results_format</span><span class="p">](</span><span class="n">event_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Else try with full pdf output</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="n">out_data</span> <span class="o">=</span> <span class="n">full_pdf_output_dicts</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diagnostic_output</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_format</span> <span class="ow">and</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">==</span> <span class="s1">&#39;full_pdf&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">out_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">out_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">20000000</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">out_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># output data</span>
        <span class="n">output_data_names</span><span class="p">,</span> <span class="n">output_data_formats</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.output_formats&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;matlab&#39;</span><span class="p">:</span> <span class="n">MATLAB_output</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span> <span class="n">pickle_output</span><span class="p">,</span> <span class="s1">&#39;hyp&#39;</span><span class="p">:</span> <span class="n">hyp_output</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to call the plugin for the correct extension</span>
                <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">output_data_formats</span><span class="p">[</span><span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()](</span><span class="n">out_data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Else try with full pdf output</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">output_format</span> <span class="ow">and</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;7.3&#39;</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">version</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
                    <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">MATLAB_output</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_format</span> <span class="ow">and</span> <span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pickle&#39;</span><span class="p">]:</span>
                    <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">pickle_output</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">output_format</span><span class="o">+</span><span class="s1">&#39; output&#39;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_station_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert event station angles to GF six vector</span>

<span class="sd">        Converts the station azimuth and take-off angle to the six vector corresponding to the homogeneous greens functions, as presented in ######################</span>

<span class="sd">        Args</span>
<span class="sd">            event: Event data dictionary.</span>
<span class="sd">            i: Event index for scatter files.</span>

<span class="sd">        Returns</span>
<span class="sd">            a_polarity,error_polarity,a1_amplitude_ratio,a2_amplitude_ratio,amplitude_ratio,percentage_error1_amplitude_ratio,percentage_error2_amplitude_ratio,a_polarity_prob,polarity_prob</span>

<span class="sd">            a_polarity: Polarity station angles matrix.</span>
<span class="sd">            error_polarity: Polarity error matrix.</span>
<span class="sd">            a1_amplitude_ratio: Amplitude ratio numerator station angles matrix.</span>
<span class="sd">            a2_amplitude_ratio: Amplitude ratio denominator station angles matrix.</span>
<span class="sd">            amplitude_ratio: Amplitude Ratio.</span>
<span class="sd">            percentage_error1_amplitude_ratio: Amplitude ratio numerator percentage uncertainty matrix.</span>
<span class="sd">            percentage_error2_amplitude_ratio: Amplitude ratio denominator percentage uncertainty matrix.</span>
<span class="sd">            a_polarity_prob: Polarity PDF station angles matrix.</span>
<span class="sd">            polarity_prob: Polarity PDF probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Check location PDF samples and set if they exist</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_location</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="o">=</span> <span class="n">location_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">[:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">:</span>
            <span class="n">location_pdf_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">location_pdf_file</span> <span class="k">for</span> <span class="n">location_pdf_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_pdf_files</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_pdf_file</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">location_samples</span><span class="p">,</span> <span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_location</span><span class="p">(</span><span class="n">location_pdf_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="o">=</span> <span class="n">location_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers_original</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers_original</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Get station angles and measurements from data</span>
        <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">polarity_matrix</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">)</span>
        <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">amplitude_ratio_matrix</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">)</span>
        <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability_2</span> <span class="o">=</span> <span class="n">polarity_probability_matrix</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">location_samples</span><span class="p">)</span>
        <span class="c1"># Extensions:</span>
        <span class="n">extension_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">extension_names</span><span class="p">,</span> <span class="n">extensions</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.process_data_types&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extension_names</span><span class="p">:</span>
            <span class="n">extension_data</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="o">=</span> <span class="n">extensions</span><span class="p">[</span><span class="n">ext</span><span class="p">](</span><span class="n">event</span><span class="p">)</span>
        <span class="c1"># Bin station location PDF samples</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_angle_coefficient_samples</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">location_samples</span><span class="p">:</span>
            <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">)</span> <span class="o">=</span> <span class="n">bin_angle_coefficient_samples</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                                                               <span class="bp">self</span><span class="o">.</span><span class="n">bin_angle_coefficient_samples</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="n">incorrect_polarity_probability_2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span>
                <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates event fid</span>

<span class="sd">        Args</span>
<span class="sd">            event: event data dictionary</span>
<span class="sd">            i: event index</span>
<span class="sd">            source: &#39;MT&#39; or &#39;dc&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">            fid string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Try to make fid from attribute</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">source</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span>
        <span class="c1"># Otherwise try to use UID or fall back to MTfitOutput as default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">source</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;MTfitOutput&#39;</span><span class="o">+</span><span class="n">source</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span>
        <span class="c1"># Add rank to MPI file output (so they don&#39;t overwrite)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="n">single</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">())</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fid</span>

    <span class="k">def</span> <span class="nf">_recover_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests if the output file exists in the correct format</span>

<span class="sd">        Args:</span>
<span class="sd">            fid: Filename to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">            Boolean: True if exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recover</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># If recover option set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover</span><span class="p">:</span>
            <span class="c1"># Check MPI and rank</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Either Rank 0 or no MPI</span>
                <span class="c1"># Check MPI output</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.0.pkl&#39;</span><span class="p">)):</span>
                        <span class="n">recover</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Check if MATLAB format</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">recover</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;matlab&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span> <span class="nn">h5py</span>
                            <span class="k">if</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">):</span>
                                <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">loadmat</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">loadmat</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                            <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">loadmat</span>
                        <span class="n">loadmat</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">)</span>
                        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Recover option enabled and output file exists: &#39;</span><span class="o">+</span><span class="n">fid</span><span class="p">)</span>
                        <span class="n">recover</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Recover option enabled and output file does not exist or is corrupted&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">recover</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Broadcast recover if MPI</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
            <span class="n">recover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">recover</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recover</span>

    <span class="k">def</span> <span class="nf">_file_sample_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recover test if file sample option enabled</span>

<span class="sd">        Args:</span>
<span class="sd">            fid: Filename to check for.</span>

<span class="sd">        Returns</span>
<span class="sd">            Boolean: True if exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_sample</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">loadmat</span>
                <span class="n">loadmat</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_in_progress.mat&#39;</span><span class="p">)</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Recover option enabled and in progress file exists, returning to this point&#39;</span><span class="p">)</span>  <span class="c1"># How to handle mcmc?</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_in_progress.mat&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_mcmc_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Markov chain Monte Carlo event forward function</span>

<span class="sd">        Runs event forward model using Markov chain Monte Carlo approach. Runs multiple events in parallel.</span>

<span class="sd">        Args</span>
<span class="sd">            source_type:[&#39;MT&#39;] &#39;MT&#39; or &#39;dc&#39; for fid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Loop over events in self.data list</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Set output fid</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">source_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Event &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;UID: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No UID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Do recovery test</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fid</span>
                <span class="c1"># Get station angle coefficients and data</span>
                <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                 <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># Update sample numbers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_samples</span><span class="p">()</span>
                <span class="c1"># Set algorithms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="c1"># Check parallel etc. and run McMCForwardTask</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed,  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples evaluated: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]))</span> <span class="o">+</span>
                                    <span class="s1">&#39; accepted samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_samples&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">],</span> <span class="n">output_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">McMCForwardTask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                          <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">McMCForwardTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                             <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span>
                                             <span class="n">convert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">accepted</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">accepted</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed,  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples evaluated: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]))</span> <span class="o">+</span>
                                <span class="s1">&#39; accepted samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">accepted</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">],</span> <span class="n">a_polarity</span><span class="o">=</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="o">=</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span>
                                    <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="o">=</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                    <span class="n">percentage_error2_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="c1"># Get pool results</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">all_results</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">accepted</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">accepted</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed,  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples evaluated: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]))</span> <span class="o">+</span>
                            <span class="s1">&#39; accepted samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">accepted</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_samples&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">],</span> <span class="n">output_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_mcmc_multiple_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Markov chain Monte Carlo event forward function for multiple event joint pdf</span>

<span class="sd">        Runs event forward model using Markov chain Monte Carlo approach for multiple events.</span>

<span class="sd">        Args</span>
<span class="sd">            source_type:[&#39;MT&#39;] &#39;MT&#39; or &#39;dc&#39; for fid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get fid</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">({},</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_joint_inversion&#39;</span><span class="o">+</span><span class="n">source_type</span><span class="p">)</span>
        <span class="c1"># Recover test</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Sort station angles and data for multiple event</span>
        <span class="n">a_polarity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">error_polarity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error_relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extension_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check event data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Get event station angles and data etc.  for event and add to list</span>
                <span class="p">(</span><span class="n">a_polarity_i</span><span class="p">,</span> <span class="n">error_polarity_i</span><span class="p">,</span> <span class="n">a1_amplitude_ratio_i</span><span class="p">,</span> <span class="n">a2_amplitude_ratio_i</span><span class="p">,</span> <span class="n">amplitude_ratio_i</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio_i</span><span class="p">,</span>
                 <span class="n">percentage_error2_amplitude_ratio_i</span><span class="p">,</span> <span class="n">a_polarity_probability_i</span><span class="p">,</span> <span class="n">polarity_probability_i</span><span class="p">,</span> <span class="n">incorrect_polarity_probability_i</span><span class="p">,</span> <span class="n">extension_data_i</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">a_polarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_polarity_i</span><span class="p">)</span>
                <span class="n">error_polarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_polarity_i</span><span class="p">)</span>
                <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error1_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error2_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">a_polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_polarity_probability_i</span><span class="p">)</span>
                <span class="n">polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polarity_probability_i</span><span class="p">)</span>
                <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incorrect_polarity_probability_i</span><span class="p">)</span>
                <span class="n">extension_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extension_data_i</span><span class="p">)</span>
                <span class="c1"># If running relative get relative data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">:</span>
                    <span class="n">a_relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_i</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_stations_i</span> <span class="o">=</span> <span class="n">relative_amplitude_ratio_matrix</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">)</span>
                    <span class="n">a_relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">percentage_error_relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error_relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">relative_amplitude_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_amplitude_stations_i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Joint Inversion: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Events</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set algorithm</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_samples</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Run forward model using MultipleEventsMcMCForwardTask</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">MultipleEventsMcMCForwardTask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span>
                                      <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                                      <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span>
                                      <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span>
                                      <span class="n">fid</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>

                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">accepted</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="n">accepted</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples evaluated: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]))</span> <span class="o">+</span>
                            <span class="s1">&#39; accepted samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">accepted</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;event_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_samples&#39;</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;location_sample_multipliers&#39;</span><span class="p">],</span>
                                <span class="n">output_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">MultipleEventsMcMCForwardTask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span>
                                                       <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span>
                                                       <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span>
                                                       <span class="n">relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">minimum_number_intersections</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="n">fid</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">,</span>
                                                       <span class="n">marginalise_relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalise</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples evaluated: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]))</span> <span class="o">+</span>
                            <span class="s1">&#39; accepted samples: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">][</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">]))</span><span class="o">*</span><span class="mi">100</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;algorithm_output_data&#39;</span><span class="p">],</span> <span class="n">a_polarity</span><span class="o">=</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="o">=</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span>
                                <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="o">=</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                <span class="n">percentage_error2_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_format</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_random_sampling_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="n">return_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monte Carlo random sampling event forward function</span>

<span class="sd">        Runs event forward model using Monte Carlo random sampling approach - ie parallel for multiple samples,  single event.</span>

<span class="sd">        Args</span>
<span class="sd">            source_type:[&#39;MT&#39;] &#39;MT&#39; or &#39;DC&#39; for fid</span>
<span class="sd">            return_zero:[True] Return zero probability samples in task result.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Loop over events</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># Get fid</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">source_type</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Set logger</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_logger</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Event &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;UID: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No UID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Recover test</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># File sample recover test</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_sample_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Continuing from previous sampling&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fid</span>
            <span class="c1"># Check event data</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Get station angle coefficients and data etc.</span>
                <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                 <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="c1"># Update sample size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_samples</span><span class="p">()</span>
                <span class="c1"># Set algorithm</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initialisation Complete</span><span class="se">\n\n</span><span class="s1">Beginning Inversion</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># Run ForwardTasks</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                    <span class="c1"># initialise all tasks</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">number_workers</span><span class="p">):</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                       <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                       <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">return_zero</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Carried out in each worker</span>
                    <span class="n">MTs</span><span class="p">,</span> <span class="n">ignored_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                         <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                         <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">return_zero</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span><span class="p">,</span>
                                         <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                    <span class="c1"># Return to initiator algorithm</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># Continue until max samples/time reached (end =  = True)</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                       <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                       <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">return_zero</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                            <span class="c1"># Handle result split and together using gather</span>
                            <span class="n">mts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">Ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">end</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mts</span><span class="p">):</span>
                                    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moment_tensors&#39;</span><span class="p">:</span> <span class="n">mts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">Ps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">Ns</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
                                    <span class="n">ignoredMTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
                                    <span class="n">end</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Process all results before ending</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Broadcast end to all mpis</span>
                            <span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iteration</span>
                            <span class="n">_start_time</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="n">MTs</span><span class="p">,</span> <span class="n">ignored_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Get new random MTs</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">_iteration</span>
                            <span class="k">if</span> <span class="n">_start_time</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">_start_time</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Just run in parallel</span>
                            <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                             <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                             <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">return_zero</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span>
                                             <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">ForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                             <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span>
                                             <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="n">return_zero</span><span class="p">,</span> <span class="n">generate_samples</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_cutoff</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">,</span>
                                             <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="c1"># Get left over pool results</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">all_results</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                            <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Elapsed time: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; seconds</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; samples evaluated</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span> <span class="o">+</span>
                                <span class="s1">&#39; non-zero samples</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Elapsed time: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; seconds</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; samples evaluated</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span><span class="o">+</span><span class="s1">&#39; non-zero samples</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Algorithm max value: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">max_value</span><span class="p">())</span>
                <span class="n">output_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_format</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                    <span class="c1"># MPI output (hyp format)</span>
                    <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
                    <span class="n">results_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
                    <span class="n">normalise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Output results</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">a_polarity</span><span class="o">=</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="o">=</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span>
                                    <span class="n">amplitude_ratio</span><span class="o">=</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                    <span class="n">percentage_error2_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                    <span class="c1"># Output pkl file with data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="n">normalise</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">results_format</span>
                    <span class="n">fids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;All moment tensor samples outputted: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; files&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Error with fids &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; type:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fids</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;fids&#39;</span><span class="p">:</span> <span class="n">fids</span><span class="p">,</span> <span class="s1">&#39;event_data&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="nd">@memory_profile_test</span><span class="p">(</span><span class="n">_MEMTEST</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_random_sampling_multiple_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_type</span><span class="o">=</span><span class="s1">&#39;MT&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monte Carlo event forward function for multiple event joint pdf</span>

<span class="sd">        Runs event forward model using Markov chain Monte Carlo approach for multiple events.</span>

<span class="sd">        Args</span>
<span class="sd">            source_type:[&#39;MT&#39;] &#39;MT&#39; or &#39;dc&#39; for fid</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Set fid</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fid</span><span class="p">({},</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_joint_inversion&#39;</span><span class="o">+</span><span class="n">source_type</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Set logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_logger</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="c1"># Recovery test</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recover_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># File sample recovery test</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_sample_test</span><span class="p">(</span><span class="n">fid</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Continuing from previous sampling&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="c1"># Get station angle coefficients, data etc. for multiple events</span>
        <span class="n">a_polarity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">error_polarity</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">percentage_error_relative_amplitude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">incorrect_polarity_probability</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">extension_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check event data</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># Get event station angles and data etc.  for event and add to list</span>
                <span class="p">(</span><span class="n">a_polarity_i</span><span class="p">,</span> <span class="n">error_polarity_i</span><span class="p">,</span> <span class="n">a1_amplitude_ratio_i</span><span class="p">,</span> <span class="n">a2_amplitude_ratio_i</span><span class="p">,</span> <span class="n">amplitude_ratio_i</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio_i</span><span class="p">,</span>
                 <span class="n">percentage_error2_amplitude_ratio_i</span><span class="p">,</span> <span class="n">a_polarity_probability_i</span><span class="p">,</span> <span class="n">polarity_probability_i</span><span class="p">,</span> <span class="n">incorrect_polarity_probability_i</span><span class="p">,</span> <span class="n">extension_data_i</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">a_polarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_polarity_i</span><span class="p">)</span>
                <span class="n">error_polarity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_polarity_i</span><span class="p">)</span>
                <span class="n">a1_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">a2_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">percentage_error1_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error1_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">percentage_error2_amplitude_ratio</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error2_amplitude_ratio_i</span><span class="p">)</span>
                <span class="n">a_polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_polarity_probability_i</span><span class="p">)</span>
                <span class="n">polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polarity_probability_i</span><span class="p">)</span>
                <span class="n">incorrect_polarity_probability</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incorrect_polarity_probability_i</span><span class="p">)</span>
                <span class="n">extension_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extension_data_i</span><span class="p">)</span>
                <span class="c1"># If running relative get relative data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">:</span>
                    <span class="n">a_relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_i</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_stations_i</span> <span class="o">=</span> <span class="n">relative_amplitude_ratio_matrix</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">)</span>
                    <span class="n">a_relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">percentage_error_relative_amplitude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error_relative_amplitude_i</span><span class="p">)</span>
                    <span class="n">relative_amplitude_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_amplitude_stations_i</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Joint Inversion: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; Events</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_samples</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">location_sample_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">location_samples</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Run forward model using MultipleEventsForwardTask</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="c1"># initialise all tasks</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">number_workers</span><span class="p">):</span>
                    <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">MultipleEventsForwardTask</span><span class="p">,</span> <span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                          <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span>
                                          <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span>
                                          <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Carried out in each worker</span>
                <span class="n">MTs</span><span class="p">,</span> <span class="n">ignored_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">MultipleEventsForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                   <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span>
                                                   <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="o">=</span><span class="n">location_sample_size</span><span class="p">,</span>
                                                   <span class="n">marginalise_relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">MultipleEventsForwardTask</span><span class="p">,</span> <span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                          <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span>
                                          <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Gather</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                                <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
                                    <span class="n">end</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># Broadcast end to all mpis</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iteration</span>
                        <span class="n">_start_time</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="c1"># Get new random MTs</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">ignored_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">_iteration</span>
                        <span class="k">if</span> <span class="n">_start_time</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">_start_time</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">MultipleEventsForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                       <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span>
                                                       <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="o">=</span><span class="n">location_sample_size</span><span class="p">,</span>
                                                       <span class="n">marginalise_relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">MultipleEventsForwardTask</span><span class="p">(</span><span class="n">MTs</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
                                                       <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span>
                                                       <span class="n">percentage_error_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">minimum_number_intersections</span><span class="p">,</span> <span class="n">relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_relative</span><span class="p">,</span> <span class="n">location_sample_size</span><span class="o">=</span><span class="n">location_sample_size</span><span class="p">,</span>
                                                       <span class="n">marginalise_relative</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_marginalise_relative</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relative_loop</span><span class="p">,</span> <span class="n">extension_data</span><span class="o">=</span><span class="n">extension_data</span><span class="p">)()</span>
                    <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="c1"># Get all pool results</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">all_results</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">MTs</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_job_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Elapsed time: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; seconds</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; samples evaluated</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span><span class="o">+</span><span class="s1">&#39; non-zero samples</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Inversion completed</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;Elapsed time: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; seconds</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; samples evaluated</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">pdf_sample</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()))</span><span class="o">+</span><span class="s1">&#39; non-zero samples</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Algorithm max value: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">max_value</span><span class="p">())</span>
            <span class="c1"># Handle mpi output</span>
            <span class="n">output_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_format</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                <span class="n">output_format</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
                <span class="n">results_format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
                <span class="n">normalise</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Output results</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">a_polarity</span><span class="o">=</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="o">=</span><span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="o">=</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="o">=</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="o">=</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="o">=</span><span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="n">output_format</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Output Error&#39;</span><span class="p">)</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

            <span class="c1"># Output mpi output pkl if self.mpi_output</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MPI</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_output</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">normalise</span> <span class="o">=</span> <span class="n">normalise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results_format</span> <span class="o">=</span> <span class="n">results_format</span>
                <span class="n">fids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;All moment tensor samples outputted: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; files&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;Error with fids &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fids</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; type:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">fids</span><span class="p">)))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span><span class="s1">&#39;fids&#39;</span><span class="p">:</span> <span class="n">fids</span><span class="p">,</span> <span class="s1">&#39;event_data&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">},</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs event forward model using the arguments when the Inversion object was initialised.</span>

<span class="sd">        Depending on the algorithm selection uses either random sampling or Markov chain Monte Carlo sampling - for more information on the different algorithms see MTfit.algorithms documentation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_type</span> <span class="o">=</span> <span class="s1">&#39;MT&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dc</span><span class="p">:</span>
            <span class="n">source_type</span> <span class="o">=</span> <span class="s1">&#39;DC&#39;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># Choose type of forward model to run (McMC or Random sampling, single event or joint events)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">McMC</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_multiple_forward</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_forward</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_events</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_random_sampling_multiple_forward</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_random_sampling_forward</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>
        <span class="c1"># Print run time</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">--------</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> inversion complete, elapsed time: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_type</span><span class="p">,</span> <span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_pool</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_job_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_result</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse job results</span>

<span class="sd">        Checks and parses the job results and either iterates or re-initialises.</span>

<span class="sd">        Args</span>
<span class="sd">            job_result:[False] result from foward task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check job result with algorithm</span>
        <span class="k">if</span> <span class="n">job_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">job_result</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
            <span class="c1"># in loop so process and return new results</span>
            <span class="c1"># Process result</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">iterate</span><span class="p">(</span><span class="n">job_result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_trim_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove unrequired data</span>

<span class="sd">        Checks and removes un-required data (not in inversion_options if set) from the event data dictionary.</span>

<span class="sd">        Args</span>
<span class="sd">            data: Event data dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">            data: Trimmed event data dictionary.</span>

<span class="sd">        Raises</span>
<span class="sd">            ValueError: No remaining data for selected inversion options.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inverion options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="c1"># Remove data_type not in inversion options</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No data remaining for the selected inversion options:</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inversion_options</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use all options</span>
            <span class="k">return</span> <span class="n">data</span>


<span class="c1">#</span>
<span class="c1"># Station angle coefficient functions and helpers</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">polarity_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the polarity observation matrices from the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Event data dictionary</span>
<span class="sd">        location_samples:[False] Station angle scatter samples.</span>

<span class="sd">    Returns</span>
<span class="sd">        a,error</span>
<span class="sd">        a: numpy matrix of station angle MT coefficients multiplied by the polarity.</span>
<span class="sd">        error: numpy matrix of fractional error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Check location samples</span>
    <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
        <span class="n">original_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">location_samples</span><span class="p">]</span>
    <span class="c1"># Get polarity data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;polarity&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;prob&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()]):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">original_samples</span><span class="p">]</span>
            <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])))</span>
            <span class="n">n_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stations</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">location_samples</span><span class="p">):</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">angles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
            <span class="c1"># Fix for station order change with location samples</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="c1"># Get measured and errors from location sample indices</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1"># Try to get incorrect polarity probability</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">):</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise get angles and measured directly</span>
            <span class="n">n_stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_stations</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span>
            <span class="n">_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">):</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># If angles have multiple dimensions (location samples),  expand the measurements</span>
        <span class="k">if</span> <span class="n">angles</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measured</span><span class="p">)</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Set or append to outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_a</span><span class="p">:</span>
            <span class="n">_a</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">measured</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">_error</span>
            <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">_incorrect_polarity_prob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">measured</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">_error</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_incorrect_polarity_prob</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_stations</span><span class="p">:</span>
                <span class="c1"># Make sure this is the same length as the data as we are appending it</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">_incorrect_polarity_prob</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_stations</span><span class="p">))</span>
            <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">_incorrect_polarity_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Set incorrect polarity prob if default</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">incorrect_polarity_prob</span>


<span class="k">def</span> <span class="nf">polarity_probability_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the polarity PDF observation matrices from the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Event data dictionary</span>
<span class="sd">        location_samples:[False] Station angle scatter samples.</span>

<span class="sd">    Returns</span>
<span class="sd">        a,probability,error</span>
<span class="sd">        a: numpy matrix of station angle MT coefficients.</span>
<span class="sd">        probability: numpy matrix of polarity probabilities.</span>
<span class="sd">        error: numpy matrix of fractional error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">positive_probability</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">negative_probability</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Check location samples and get sample</span>
    <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
        <span class="n">original_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">location_samples</span><span class="p">]</span>
    <span class="c1"># Loop over polarity prob data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;polarity&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;prob&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()]):</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># If location samples, then select stations appropriately</span>
        <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">original_samples</span><span class="p">]</span>
            <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">location_samples</span><span class="p">):</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">angles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">):</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Otherwise get angles and measeured</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">):</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;IncorrectPolarityProbability&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Set or append to outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_a</span><span class="p">:</span>
            <span class="n">_a</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">angles</span>
            <span class="n">positive_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">negative_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">_incorrect_polarity_prob</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">positive_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">negative_probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">,</span> <span class="n">_incorrect_polarity_prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Set incorrect polarity prob if default</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">incorrect_polarity_prob</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">incorrect_polarity_prob</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">positive_probability</span><span class="p">,</span> <span class="n">negative_probability</span><span class="p">),</span> <span class="n">incorrect_polarity_prob</span>


<span class="k">def</span> <span class="nf">amplitude_ratio_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the amplitude ratio observation matrices from the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Event data dictionary</span>
<span class="sd">        location_samples:[False] Station angle scatter samples.</span>

<span class="sd">    Returns</span>
<span class="sd">        a1,a2,amplitude_ratio,percentage_error1,percentage_error2</span>
<span class="sd">        a1: numpy matrix of station angle MT coefficients for ratio numerator.</span>
<span class="sd">        a2: numpy matrix of station angle MT coefficients for ratio denominator.</span>
<span class="sd">        amplitude_ratio: numpy matrix of observed ratios.</span>
<span class="sd">        percentage_error1: numpy matrix of ratio numerator percentage error.</span>
<span class="sd">        percentage_error2: numpy matrix of ratio denominator percentage error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">percentage_error1</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">percentage_error2</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
        <span class="n">original_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">location_samples</span><span class="p">]</span>
    <span class="c1"># Loop over data and get amplitude ratio data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;amplituderatio&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;amplitude_ratio&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()]):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;amplituderatio&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;rms&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
        <span class="n">phase</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># If location samples, get intersection stations and data</span>
        <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">original_samples</span><span class="p">]</span>
            <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">angles1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">location_samples</span><span class="p">):</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">angles1</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">angles2</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">angles1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles1</span><span class="p">)</span>
            <span class="n">angles2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles2</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles1</span><span class="p">,</span> <span class="n">angles2</span><span class="p">]</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">_measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="c1"># Otherwise get angles and measurements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angles1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">],</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">angles2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">],</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">angles1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles1</span><span class="p">)</span>
            <span class="n">angles2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles2</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="n">angles1</span><span class="p">,</span> <span class="n">angles2</span><span class="p">]</span>
            <span class="n">_measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span>
        <span class="c1"># Set or append to outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">percentage_error1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">percentage_error2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">angles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">angles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">percentage_error1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">percentage_error2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">amplitude_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">_measured</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">_measured</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1</span><span class="p">,</span> <span class="n">percentage_error2</span>


<span class="k">def</span> <span class="nf">relative_amplitude_ratio_matrix</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the relative amplitude ratio observation matrices from the data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: Event data dictionary</span>
<span class="sd">        location_samples:[False] Station angle scatter samples.</span>

<span class="sd">    Returns</span>
<span class="sd">        a_relative_amplitude,relative_amplitude,percentage_error</span>
<span class="sd">        a_relative_amplitude: numpy matrix of station angle MT coefficients for ratio numerator.</span>
<span class="sd">        relative_amplitude: numpy matrix of observations.</span>
<span class="sd">        percentage_error: numpy matrix of relative amplitude percentage error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">a</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">percentage_error</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">relative_amplitude</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
        <span class="n">original_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">location_samples</span><span class="p">]</span>
    <span class="c1"># Loop over data and get amplitude data</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;ratio&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()]):</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;amplitude&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;rms&#39;</span><span class="p">)</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
        <span class="c1"># If location samples, get intersection stations and data</span>
        <span class="k">if</span> <span class="n">location_samples</span><span class="p">:</span>
            <span class="n">location_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">original_samples</span><span class="p">]</span>
            <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">location_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_samples</span><span class="p">),</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">location_samples</span><span class="p">):</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">indices</span><span class="p">)(</span><span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
                <span class="n">angles</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
            <span class="n">relative_amplitude_stations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">selected_stations</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span>
        <span class="c1"># Otherwise get angles and measurements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">angles</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">],</span> <span class="n">phase</span><span class="p">)</span>
            <span class="n">relative_amplitude_stations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
            <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># Set or append to outputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="n">angles</span>
            <span class="n">relative_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">measured</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">percentage_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">measured</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a_relative_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">relative_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">measured</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">percentage_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">percentage_error</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">measured</span><span class="p">),</span> <span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">relative_amplitude_stations</span><span class="p">):</span>
        <span class="n">relative_amplitude_stations</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">a_relative_amplitude</span><span class="p">,</span> <span class="n">relative_amplitude</span><span class="p">,</span> <span class="n">percentage_error</span><span class="p">,</span> <span class="n">relative_amplitude_stations</span>


<span class="k">def</span> <span class="nf">_intersect_stations</span><span class="p">(</span><span class="n">relative_amplitude_stations_i</span><span class="p">,</span> <span class="n">relative_amplitude_stations_j</span><span class="p">,</span> <span class="n">a_relative_amplitude_ratio_i</span><span class="p">,</span> <span class="n">a_relative_amplitude_ratio_j</span><span class="p">,</span>
                        <span class="n">relative_amplitude_i</span><span class="p">,</span> <span class="n">relative_amplitude_j</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude_i</span><span class="p">,</span> <span class="n">percentage_error_relative_amplitude_j</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the intersection of the two lists of stations, and then returns the input angles and amplitudes etc for the intersection.</span>

<span class="sd">    Args</span>
<span class="sd">        relative_amplitude_stations_i: List of stations corresponding to the data from event_i</span>
<span class="sd">        relative_amplitude_stations_j: List of stations corresponding to the data from event_j</span>
<span class="sd">        a_relative_amplitude_ratio_i: numpy matrix of station GFs from event_i</span>
<span class="sd">        a_relative_amplitude_ratio_j: numpy matrix of station GFs from event_j</span>
<span class="sd">        relative_amplitude_i: numpy matrix of amplitude observations from event_i</span>
<span class="sd">        relative_amplitude_j: numpy matrix of amplitude observations from event_j</span>
<span class="sd">        percentage_error_relative_amplitude_i: numpy matrix of percentage errors from event_i</span>
<span class="sd">        percentage_error_relative_amplitude_j: numpy matrix of percentage errors from event_j</span>

<span class="sd">    Returns</span>
<span class="sd">        a_relative_amplitude_ratio_i: numpy matrix of station GFs for event_i and event_j intersection corresponding to event_i</span>
<span class="sd">        a_relative_amplitude_ratio_j: numpy matrix of station GFs for event_i and event_j intersection corresponding to event_j</span>
<span class="sd">        relative_amplitude_i: numpy matrix of amplitude observations for event_i and event_j intersection corresponding to event_i</span>
<span class="sd">        relative_amplitude_j: numpy matrix of amplitude observations for event_i and event_j intersection corresponding to event_j</span>
<span class="sd">        percentage_error_relative_amplitude_i: numpy matrix of percentage errors for event_i and event_j intersection corresponding to event_i</span>
<span class="sd">        percentage_error_relative_amplitude_j: numpy matrix of percentage errors for event_i and event_j intersection corresponding to event_j</span>
<span class="sd">        number_intersections: integer number of intersections between event_i and event_j.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get intersection of stations between events</span>
    <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">relative_amplitude_stations_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">relative_amplitude_stations_j</span><span class="p">))</span>
    <span class="c1"># Get indices for each event</span>
    <span class="n">indices_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relative_amplitude_stations_i</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
    <span class="n">indices_j</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">relative_amplitude_stations_j</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
    <span class="c1"># Get parameters for event i</span>
    <span class="n">a_relative_amplitude_ratio_i</span> <span class="o">=</span> <span class="n">a_relative_amplitude_ratio_i</span><span class="p">[</span><span class="n">indices_i</span><span class="p">]</span>
    <span class="n">relative_amplitude_i</span> <span class="o">=</span> <span class="n">relative_amplitude_i</span><span class="p">[</span><span class="n">indices_i</span><span class="p">]</span>
    <span class="n">percentage_error_relative_amplitude_i</span> <span class="o">=</span> <span class="n">percentage_error_relative_amplitude_i</span><span class="p">[</span><span class="n">indices_i</span><span class="p">]</span>
    <span class="c1"># Get parameters for event j</span>
    <span class="n">a_relative_amplitude_ratio_j</span> <span class="o">=</span> <span class="n">a_relative_amplitude_ratio_j</span><span class="p">[</span><span class="n">indices_j</span><span class="p">]</span>
    <span class="n">relative_amplitude_j</span> <span class="o">=</span> <span class="n">relative_amplitude_j</span><span class="p">[</span><span class="n">indices_j</span><span class="p">]</span>
    <span class="n">percentage_error_relative_amplitude_j</span> <span class="o">=</span> <span class="n">percentage_error_relative_amplitude_j</span><span class="p">[</span><span class="n">indices_j</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_relative_amplitude_ratio_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a_relative_amplitude_ratio_j</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">relative_amplitude_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">relative_amplitude_j</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">percentage_error_relative_amplitude_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">percentage_error_relative_amplitude_j</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">indices_i</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_intersect_stations_extension_data</span><span class="p">(</span><span class="n">extension_data_i</span><span class="p">,</span> <span class="n">extension_data_j</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determines the intersection of the two lists of stations, and then returns the input angles and amplitudes etc for the intersection.</span>

<span class="sd">    Args</span>
<span class="sd">        extension_data_i: extension data  from event_i</span>
<span class="sd">        extension_data_j: extension data  from event_j</span>

<span class="sd">    Returns</span>
<span class="sd">        extension_data_i: extension data for event_i and event_j intersection corresponding to event_i</span>
<span class="sd">        extension_data_j: extension data  for event_i and event_j intersection corresponding to event_j</span>
<span class="sd">        number_intersections: integer number of intersections between event_i and event_j.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get intersection of stations between events</span>
    <span class="n">stations_i</span> <span class="o">=</span> <span class="n">extension_data_i</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span>
    <span class="n">stations_j</span> <span class="o">=</span> <span class="n">extension_data_j</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span>
    <span class="n">selected_stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">stations_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">stations_j</span><span class="p">))</span>
    <span class="c1"># Get indices for each event</span>
    <span class="n">indices_i</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations_i</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
    <span class="n">indices_j</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations_j</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">selected_stations</span><span class="p">]</span>
    <span class="c1"># Get parameters for event i</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_data_i</span><span class="p">:</span>
        <span class="n">extension_data_i</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">extension_data_i</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">indices_i</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_data_j</span><span class="p">:</span>
        <span class="n">extension_data_j</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">extension_data_j</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">indices_j</span><span class="p">])</span>
    <span class="c1"># Get parameters for event j</span>
    <span class="k">return</span> <span class="n">extension_data_i</span><span class="p">,</span> <span class="n">extension_data_j</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices_i</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">station_angles</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">radians</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the station MT coefficients from the station angles. ###############</span>
<span class="sd">    TakeOffAngle 0 down (as this is positive z-axis in NED system.</span>

<span class="sd">    Args</span>
<span class="sd">        stations: station dictionary (format is the station component of the data dictionary (MTfit.inversion.Inversion docstrings))</span>
<span class="sd">        phase: &#39;P&#39;,&#39;SH&#39;,&#39;SV&#39; - the component for which to calculate the station angles, can be a ratio separated with a \.</span>
<span class="sd">        radians:[False] Boolean flag to set radians true or false</span>

<span class="sd">    Returns</span>
<span class="sd">        station angles MT coefficients.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get azimuth and takeoff angles</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
        <span class="n">takeoff_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># stations is angle tuple</span>
        <span class="n">takeoff_angle</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Transpose to correct orientation if necessary</span>
    <span class="k">if</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">azimuth</span><span class="o">.</span><span class="n">T</span>
    <span class="k">if</span> <span class="n">takeoff_angle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">takeoff_angle</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">takeoff_angle</span> <span class="o">=</span> <span class="n">takeoff_angle</span><span class="o">.</span><span class="n">T</span>
    <span class="c1"># Radian conversion if not radians</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">radians</span><span class="p">:</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">azimuth</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">radians</span><span class="p">:</span>
        <span class="n">takeoff_angle</span> <span class="o">=</span> <span class="n">takeoff_angle</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span>
    <span class="c1"># Set arrays</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span>
    <span class="n">takeoff_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span>
    <span class="c1"># Get phase</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="c1"># Calculate angles</span>
    <span class="k">if</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sh&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="mi">0</span><span class="o">*</span><span class="n">azimuth</span><span class="p">,</span>
                         <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">phase</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sv&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">takeoff_angle</span><span class="p">),</span>
                         <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azimuth</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">takeoff_angle</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radians</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">radians</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> phase not recognised.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>


<span class="c1">#</span>
<span class="c1"># Solution misfit and probability check functions</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_polarity_misfit_check</span><span class="p">(</span><span class="n">polarity</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="n">takeoffangle</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">mt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check polarity  misfit for a given MT (private function)</span>

<span class="sd">    Args</span>
<span class="sd">        polarity: np.array of polarity observations.</span>
<span class="sd">        azimuth: np.matrix of azimuths.</span>
<span class="sd">        takeoffangle: np.matrix of takeoffangles.</span>
<span class="sd">        phase: Phase of polarity measurements (P, SH, SV).</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz.</span>

<span class="sd">    Returns</span>
<span class="sd">        indices of differing model and observed polarities or boolean false if no polarities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If polarity exists then check model polarities vs observed polarities</span>
    <span class="k">if</span> <span class="n">polarity</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a_station</span> <span class="o">=</span> <span class="n">station_angles</span><span class="p">({</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">azimuth</span><span class="p">],</span> <span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">takeoffangle</span><span class="p">]},</span> <span class="n">phase</span><span class="p">)</span>
        <span class="n">model_polarity</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a_station</span><span class="o">*</span><span class="n">mt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model_polarity</span><span class="o">*</span><span class="n">polarity</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">polarity_misfit_check</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks polarity misfit for a given MT and data dictionary</span>

<span class="sd">    Args</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz.</span>
<span class="sd">        data: data dictionary or list of dictionaries.</span>
<span class="sd">        data_file:  data input file (data dict or data_file must be provided).</span>
<span class="sd">        inversion_options: polarity inversion_options list .</span>

<span class="sd">    Returns</span>
<span class="sd">        list of names of misfitting stations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy data</span>
    <span class="n">copied_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Set up inverson</span>
    <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">copied_data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="n">inversion_options</span><span class="p">)</span>
    <span class="c1"># Loop over events</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="c1"># Check data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Set algorithm</span>
        <span class="n">inversion</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Get observed polarities/inversion_options in data</span>
        <span class="n">observed_polarity</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion_options</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">observed_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">observed_polarity</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">observed_polarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_polarity</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span>
                <span class="n">stations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
        <span class="c1"># Create model polarities</span>
        <span class="n">observed_polarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observed_polarity</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
         <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">model_polarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># Compare with observed polarities</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stations</span><span class="p">)[(</span><span class="n">model_polarity</span><span class="o">*</span><span class="n">observed_polarity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">probability_mt_check</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">,</span> <span class="s1">&#39;P/SHAmplitudeRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;P/SVAmplitudeRatio&#39;</span><span class="p">],</span> <span class="n">RMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate results for a given mt and data</span>

<span class="sd">    Args</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz.</span>
<span class="sd">        data: data dictionary or list of dictionaries.</span>
<span class="sd">        data_file:  data input file (data dict or data_file must be provided).</span>
<span class="sd">        location_pdf_file_path: location PDF file path.</span>
<span class="sd">        inversion_options:[&#39;PPolarity&#39;,&#39;P/SHAmplitudeRatio&#39;,&#39;P/SVAmplitudeRatio&#39;] polarity inversion_options list.</span>
<span class="sd">        RMS:[False] Use RMS amplitudes (if not set in inversion options).</span>
<span class="sd">        Q:[False] Use Q (if not set in inversion options).</span>

<span class="sd">    Returns</span>
<span class="sd">        results list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy data</span>
    <span class="n">copied_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Get amplitude ratio options</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion_options</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;AmplitudeRatio&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">RMS</span> <span class="ow">and</span> <span class="s1">&#39;RMS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">inversion_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;AmplitudeRatio&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;RMSAmplitudeRatio&#39;</span>
            <span class="k">if</span> <span class="n">Q</span> <span class="ow">and</span> <span class="s1">&#39;Q&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">inversion_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;AmplitudeRatio&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;QAmplitudeRatio&#39;</span>
    <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">copied_data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="n">inversion_options</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">inversion</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
         <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                   <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                                   <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">inversion</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="kc">True</span><span class="p">)())</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">polarity_mt_check</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">,</span> <span class="s1">&#39;SHPolarity&#39;</span><span class="p">,</span> <span class="s1">&#39;SVPolarity&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate polarity results for a given mt and data</span>

<span class="sd">    Args</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz</span>
<span class="sd">        data: data dictionary or list of dictionaries</span>
<span class="sd">        data_file:  data input file (data dict or data_file must be provided)</span>
<span class="sd">        location_pdf_file_path: location PDF file path</span>
<span class="sd">        inversion_options:[&#39;PPolarity&#39;,&#39;P/SHAmplitudeRatio&#39;,&#39;P/SVAmplitudeRatio&#39;] inversion_options list</span>

<span class="sd">    Returns</span>
<span class="sd">        results list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy data</span>
    <span class="n">copied_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Get polarity inversion options</span>
    <span class="n">processed_inversion_options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion_options</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;polarity&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;prob&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">processed_inversion_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="c1"># Create inversion object</span>
    <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">copied_data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="n">processed_inversion_options</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Set algorithms</span>
        <span class="n">inversion</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Get angles and data</span>
        <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
         <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># Get results</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                   <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                                   <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">inversion</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="kc">True</span><span class="p">)())</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">polarity_probability_mt_check</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PPolarityProbability&#39;</span><span class="p">,</span> <span class="s1">&#39;SHPolarityProbability&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate Polarity probability results for a given mt and data</span>

<span class="sd">    Args</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz</span>
<span class="sd">        data: data dictionary or list of dictionaries</span>
<span class="sd">        data_file:  data input file (data dict or data_file must be provided)</span>
<span class="sd">        location_pdf_file_path: location PDF file path</span>
<span class="sd">        inversion_options:[&#39;PPolarityProbability&#39;,&#39;SHPolarityProbability&#39;] polarity inversion_options list</span>


<span class="sd">    Returns</span>
<span class="sd">        results list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy data</span>
    <span class="n">copied_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Get polarity inversion options</span>
    <span class="n">processed_inversion_options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion_options</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;polarity&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;prob&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">processed_inversion_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="c1"># Create inversion object</span>
    <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">copied_data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="n">processed_inversion_options</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Set algorithms</span>
        <span class="n">inversion</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Get angles and data</span>
        <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span>
         <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span> <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># Get results</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                   <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                                   <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">inversion</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="kc">True</span><span class="p">)())</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">amplitude_ratio_probability_mt_check</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">data_file</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P/SHAmplitudeRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;P/SVAmplitudeRatio&#39;</span><span class="p">],</span> <span class="n">RMS</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate amplitude ratio results for a given mt and data</span>

<span class="sd">    Args</span>
<span class="sd">        mt: np.matrix moment tensor six vector Mxx Myy Mzz sqrt(2)*Mxy sqrt(2)*Mxz sqrt(2)*Myz.</span>
<span class="sd">        data: data dictionary or list of dictionaries.</span>
<span class="sd">        data_file:  data input file (data dict or data_file must be provided).</span>
<span class="sd">        location_pdf_file_path: location PDF file path.</span>
<span class="sd">        inversion_options:[&#39;P/SHAmplitudeRatio&#39;,&#39;P/SVAmplitudeRatio&#39;] inversion_options list.</span>
<span class="sd">        RMS:[False] Use RMS amplitudes (if not set in inversion options).</span>
<span class="sd">        Q:[False] Use Q (if not set in inversion options).</span>

<span class="sd">    Returns</span>
<span class="sd">        results list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Copy data</span>
    <span class="n">copied_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># Get polarity inversion options</span>
    <span class="n">processed_inversion_options</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion_options</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;amplituderatio&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">RMS</span> <span class="ow">and</span> <span class="s1">&#39;rms&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;AmplitudeRatio&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;RMSAmplitudeRatio&#39;</span>
            <span class="k">if</span> <span class="n">Q</span> <span class="ow">and</span> <span class="s1">&#39;q&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;AmplitudeRatio&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;QAmplitudeRatio&#39;</span>
            <span class="n">processed_inversion_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
    <span class="c1"># Create inversion object</span>
    <span class="n">inversion</span> <span class="o">=</span> <span class="n">Inversion</span><span class="p">(</span><span class="n">copied_data</span><span class="p">,</span> <span class="n">data_file</span><span class="p">,</span> <span class="n">location_pdf_file_path</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="n">processed_inversion_options</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">event</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inversion</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Set algorithms</span>
        <span class="n">inversion</span><span class="o">.</span><span class="n">_set_algorithm</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_trim_data</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Data&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="c1"># Get angles and data</span>
        <span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
         <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
         <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">)</span> <span class="o">=</span> <span class="n">inversion</span><span class="o">.</span><span class="n">_station_angles</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># Get results</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ForwardTask</span><span class="p">(</span><span class="n">mt</span><span class="p">,</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">error_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">amplitude_ratio</span><span class="p">,</span>
                                   <span class="n">percentage_error1_amplitude_ratio</span><span class="p">,</span> <span class="n">percentage_error2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_probability</span><span class="p">,</span>
                                   <span class="n">polarity_probability</span><span class="p">,</span> <span class="n">inversion</span><span class="o">.</span><span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">incorrect_polarity_probability</span><span class="p">,</span> <span class="kc">True</span><span class="p">)())</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">_pop_station</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">station</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove station from data type (key)&quot;&quot;&quot;</span>
    <span class="c1"># Get index</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
    <span class="c1"># Delete indices</span>
    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">],</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="c1">#</span>
<span class="c1"># Combine hyp event output from MPI</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">combine_mpi_output</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">output_format</span><span class="o">=</span><span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mpi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine MPI output into single output</span>

<span class="sd">    MPI output is hyp and mt files for each mpi process, this function combines them into a single output.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath:[.] Input filepath.</span>
<span class="sd">        output_format:[matlab] Output format.</span>
<span class="sd">        parallel:[False] Boolean flag to run in parallel using job pool (Not MPI).</span>
<span class="sd">        mpi:[False] Boolean MPI flag.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check MPI</span>
    <span class="k">if</span> <span class="n">mpi</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
            <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">mpi</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Set filepath to folder</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
    <span class="c1"># Get hyp files</span>
    <span class="n">hypfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filepath</span><span class="o">+</span><span class="s1">&#39;*.hyp&#39;</span><span class="p">)</span>
    <span class="c1"># Get UIDs</span>
    <span class="n">UIDs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">hypfiles</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------Combining Files------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UIDs</span><span class="p">)))</span>
    <span class="c1"># Run combination</span>
    <span class="c1"># Run in parallel</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">job_pool</span> <span class="o">=</span> <span class="n">JobPool</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">CombineMpiOutputTask</span><span class="p">)</span>
        <span class="n">number_workers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_pool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">number_workers</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">job_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">parallel</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Run using MPI</span>
    <span class="k">if</span> <span class="n">mpi</span><span class="p">:</span>
        <span class="c1"># split by workers</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">UIDs</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">())</span>
        <span class="c1"># Get the UIDS for this worker</span>
        <span class="n">UIDs</span> <span class="o">=</span> <span class="n">UIDs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span><span class="o">*</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample</span><span class="p">)):</span><span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">UIDs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="c1"># Loop over UIDs and run combine task</span>
    <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">UIDs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="n">job_pool</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results_format&#39;</span><span class="p">,</span> <span class="s1">&#39;full_pdf&#39;</span><span class="p">),</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="n">binary_file_version</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CombineMpiOutputTask</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">output_format</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results_format&#39;</span><span class="p">,</span> <span class="s1">&#39;full_pdf&#39;</span><span class="p">),</span> <span class="n">binary_file_version</span><span class="o">=</span><span class="n">binary_file_version</span><span class="p">)()</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">job_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="c1">#</span>
<span class="c1"># Location pdf parsing and binning</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">bin_angle_coefficient_samples</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Carry out the binning over the station ray path coefficent samples</span>

<span class="sd">    Unlike the bin_scatangle function, this accounts for variations in angle dependencies.</span>

<span class="sd">    Args</span>
<span class="sd">         a_polarity: np.array of polarity station coefficent data.</span>
<span class="sd">         a1_amplitude_ratio: np.array of amplitude ratio numerator station coefficent data.</span>
<span class="sd">         a2_amplitude_ratio: np.array of amplitude ratio denominator station coefficient data.</span>
<span class="sd">         a_polarity_prob: np.array of polarity prob stationcoefficient data.</span>
<span class="sd">         location_sample_multipliers: location sample probabilities.</span>
<span class="sd">         epsilon:[0] allowed difference for the samples to be binned together.</span>

<span class="sd">    Returns</span>
<span class="sd">        a_polarity,a1_amplitude_ratio,a2_amplitude_ratio,a_polarity_prob,multipliers</span>
<span class="sd">        np.arrays of station coefficents for each data type and the location sample multipliers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">epsilon</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="k">if</span> <span class="n">cprobability</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">,</span> <span class="n">multipliers</span> <span class="o">=</span> <span class="n">cprobability</span><span class="o">.</span><span class="n">bin_angle_coefficient_samples</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span>
                                                                                                                                                          <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span>
                                                                                                                                                          <span class="n">location_sample_multipliers</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">,</span>
                                                                                                                                                          <span class="n">epsilon</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ctime = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Py&#39;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">multipliers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">no_pop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">),),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">)):</span>
                <span class="n">multiplier</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">no_pop</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">diff_polarity</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                            <span class="n">diff_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">a_polarity</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">diff_polarity</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                            <span class="n">diff_a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">a1_amplitude_ratio</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">diff_polarity</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                            <span class="n">diff_a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">a2_amplitude_ratio</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="n">diff_polarity</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                            <span class="n">diff_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">-</span><span class="n">a_polarity_prob</span><span class="p">[:,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_polarity</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_a1_amplitude_ratio</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_a2_amplitude_ratio</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff_polarity_prob</span><span class="p">))])</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                            <span class="n">multiplier</span> <span class="o">+=</span> <span class="n">location_sample_multipliers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                            <span class="n">no_pop</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">multipliers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiplier</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pytime = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">a_polarity</span> <span class="o">=</span> <span class="n">a_polarity</span><span class="p">[:,</span> <span class="n">no_pop</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span><span class="p">[:,</span> <span class="n">no_pop</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span><span class="p">[:,</span> <span class="n">no_pop</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a_polarity_prob</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">a_polarity_prob</span> <span class="o">=</span> <span class="n">a_polarity_prob</span><span class="p">[:,</span> <span class="n">no_pop</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extension_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extension_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">k</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a_&#39;</span> <span class="ow">or</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                        <span class="n">extension_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">extension_data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">k</span><span class="p">][:,</span> <span class="n">no_pop</span><span class="p">,</span> <span class="p">:]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Epsilon = </span><span class="si">{}</span><span class="s1"> reduced </span><span class="si">{}</span><span class="s1"> samples to </span><span class="si">{}</span><span class="s1"> records.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epsilon</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">location_sample_multipliers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">multipliers</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">a_polarity</span><span class="p">,</span> <span class="n">a1_amplitude_ratio</span><span class="p">,</span> <span class="n">a2_amplitude_ratio</span><span class="p">,</span> <span class="n">a_polarity_prob</span><span class="p">,</span> <span class="n">extension_data</span><span class="p">,</span> <span class="n">multipliers</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-algorithms.html" class="btn btn-neutral float-right" title="3.1.2. MTfit.algorithms" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source.html" class="btn btn-neutral" title="3. MTfit Source Code" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David Pugh.
      Last updated on Aug 30, 2018 (version 1.0.5).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.5',
            LANGUAGE:'English',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>