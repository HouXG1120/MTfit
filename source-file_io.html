

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>17.1.6.1.3. mtfit.utilities.file_io &mdash; mtfit documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/style.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="mtfit documentation" href="index.html"/>
        <link rel="up" title="17.1.6. mtfit.utilities" href="source-utilities.html"/>
        <link rel="next" title="17.1.6.1.4. mtfit.utilities.multiprocessing_helper" href="source-multiprocessing_helper.html"/>
        <link rel="prev" title="17.1.6.1.2. mtfit.utilities.extensions" href="source-utilities_extensions.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> mtfit
          

          
            
            <img src="_static/mtfitsphinx.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0+untagged.15.g53a39ba
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">2. Running mtfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="real-tutorial.html">4. Tutorial: Real Data Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">5. Bayesian Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">7. Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtconvert.html">8. Moment Tensor Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">9. Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplot.html">10. Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_classes.html">11. Plot Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplotcli.html">12. MTplot Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="inversion.html">13. Inversion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">14. Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">16. Glossary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="source.html">17. Source Code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="source.html#contents">17.1. Contents:</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="source-inversion.html">17.1.1. mtfit.inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-algorithms.html">17.1.2. mtfit.algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-probability.html">17.1.3. mtfit.probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-sampling.html">17.1.4. mtfit.sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-run.html">17.1.5. mtfit.run</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="source-utilities.html">17.1.6. mtfit.utilities</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="source-utilities.html#contents">17.1.6.1. Contents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="source-extensions.html">17.1.7. mtfit.extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-convert.html">17.1.8. mtfit.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-plot.html">17.1.9. mtfit.plot</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">mtfit</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="source.html">17. mtfit Source Code</a> &raquo;</li>
        
          <li><a href="source-utilities.html">17.1.6. mtfit.utilities</a> &raquo;</li>
        
      <li>17.1.6.1.3. mtfit.utilities.file_io</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/source-file_io.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mtfit-utilities-file-io">
<h1>17.1.6.1.3. mtfit.utilities.file_io<a class="headerlink" href="#mtfit-utilities-file-io" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">file_io</span>
<span class="sd">*******</span>

<span class="sd">Handles file input/output e.g. for the inversion results</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># **Restricted:  For Non-Commercial Use Only**</span>
<span class="c1"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c1"># and non-commercially funded academic research purposes.</span>
<span class="c1">#</span>
<span class="c1"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">..convert.moment_tensor_conversion</span> <span class="k">import</span> <span class="n">MT6_Tape</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">..extensions.scatangle</span> <span class="k">import</span> <span class="n">parse_scatangle</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;MTfit.utilities.file_io&#39;</span><span class="p">)</span>

<span class="n">nlloc_polarity_inv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">},</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;N&#39;</span><span class="p">}}</span>
<span class="n">nlloc_polarity_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>

<span class="c1">#</span>
<span class="c1"># Output Task Classes</span>
<span class="c1">#</span>


<span class="k">class</span> <span class="nc">MATLABOutputTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MATLAB format output task</span>

<span class="sd">    Saves MATLAB output file to disk using hdf5storage or scipy savemat.</span>

<span class="sd">    Initialisation</span>
<span class="sd">        Args</span>
<span class="sd">            fid: Filename for MATLAB output.</span>
<span class="sd">            output: Dictionary of output to be saved to fid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;7.3&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of MATLABOutputTask</span>

<span class="sd">        Args</span>
<span class="sd">            fid: Filename for MATLAB output.</span>
<span class="sd">            output: Dictionary of output to be saved to fid.</span>
<span class="sd">            version: Set MATLAB version (7.3 or 7) for hdf5storage or scipy storage, respectively</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span> <span class="o">=</span> <span class="n">output_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the MATLABOutputTask and returns a result code.</span>

<span class="sd">        Returns</span>
<span class="sd">            resultCode: 10 if successful, 20 if an exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check version and get savemat function</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;7.3&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">savemat</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="s1">&#39;7.3&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">savemat</span>  <span class="c1"># noqa F811</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving to </span><span class="si">{}</span><span class="s1"> in MATLAB version </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
        <span class="c1"># Try to save file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Convert to/from unicode for different functions (hdf5 needs</span>
            <span class="c1"># unicode) scipy needs non-unicode</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;7.3&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span><span class="p">)</span>
            <span class="c1"># Save data</span>
            <span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved to &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;MATLAB Output Error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">20</span>


<span class="k">class</span> <span class="nc">PickleOutputTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pickle format output task</span>

<span class="sd">    Saves output file to disk using pickle.</span>

<span class="sd">    Initialisation</span>
<span class="sd">        Args</span>
<span class="sd">            fid: Filename for output.</span>
<span class="sd">            output: Dictionary of output to be saved to fid.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">output_dict</span><span class="p">,):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of PickleOutputTask</span>

<span class="sd">        Args</span>
<span class="sd">            fid: Filename for MATLAB output.</span>
<span class="sd">            output: Dictionary of output to be saved to fid.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span> <span class="o">=</span> <span class="n">output_dict</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the PickleOutputTask and returns a result code.</span>

<span class="sd">        Returns</span>
<span class="sd">            resultCode: 10 if successful, 20 if an exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saving to &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved to &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Pickle Output Error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">20</span>


<span class="k">class</span> <span class="nc">HypOutputTask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NLLOC hyp format output task</span>

<span class="sd">    Saves output file to disk.</span>

<span class="sd">    Initialisation</span>
<span class="sd">        Args</span>
<span class="sd">            fid: Filename for output.</span>
<span class="sd">            output: Data to be saved to fid.</span>
<span class="sd">            mt: Saving mt format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of HypOutputTask</span>

<span class="sd">        Args</span>
<span class="sd">            fid: Filename for MATLAB output.</span>
<span class="sd">            output: Data to be saved to fid.</span>
<span class="sd">            binary:[False] binary output file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">fid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">binary</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the PickleOutputTask and returns a result code.</span>

<span class="sd">        Returns</span>
<span class="sd">            resultCode: 10 if successful, 20 if an exception is thrown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Write binary as binary file,</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="c1"># Write output as normal text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">10</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Hyp Output Error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">20</span>

<span class="c1">#</span>
<span class="c1"># Input file parsing</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">parse_hyp</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse NonLinLoc hyp file</span>

<span class="sd">    Reads NonLinLoc hyp file for input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename:str hyp filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over file and split into events</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;END_NLLOC&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                    <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c1"># Parse events</span>
    <span class="k">return</span> <span class="n">_parse_hyp_events</span><span class="p">(</span><span class="n">events_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_hyp_events</span><span class="p">(</span><span class="n">events_list</span><span class="p">,</span> <span class="n">polarity_error_multiplier</span><span class="o">=</span><span class="mf">3.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse events from NonLinLoc hyp file</span>

<span class="sd">    Parse the events read from a NonLinLoc hyp file.</span>

<span class="sd">    Args</span>
<span class="sd">        events_list: list of event lines read from NonLinLoc hyp file.</span>
<span class="sd">        polarity_error_multiplier:[3.] Multiplier to convert time error to polarity error estimates.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over events</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_list</span><span class="p">:</span>
        <span class="n">event_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># For each line</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="c1"># Generic key dictionary</span>
            <span class="n">key_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Stations&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s1">&#39;Measured&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="c1"># Get UID from GEOGRAPHIC line</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GEOGRAPHIC&#39;</span><span class="p">:</span>
                <span class="n">sec</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">sec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">sec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="c1"># Phase flag</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">:</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
            <span class="c1"># End of phase flag</span>
            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;END_PHASE&#39;</span><span class="p">:</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># If in phase section, read data</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">:</span>
                <span class="c1"># Get station</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Get phase</span>
                <span class="n">phase_type</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="c1"># Get polarity</span>
                <span class="n">polarity</span> <span class="o">=</span> <span class="n">nlloc_polarity_dict</span><span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="c1"># Get uncertainty</span>
                <span class="n">uncertainty</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                <span class="c1"># Get amplitude (unused)</span>
                <span class="n">amplitude</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>  <span class="c1"># noqa F841</span>
                <span class="k">if</span> <span class="n">polarity</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">event_dict</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">):</span>
                        <span class="n">event_dict</span><span class="p">[</span><span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">event_dict</span><span class="p">[</span>
                        <span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
                    <span class="n">event_dict</span><span class="p">[</span>
                        <span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">polarity</span><span class="p">)</span>
                    <span class="n">event_dict</span><span class="p">[</span>
                        <span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uncertainty</span><span class="o">*</span><span class="n">polarity_error_multiplier</span><span class="p">)</span>
                    <span class="n">event_dict</span><span class="p">[</span>
                        <span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">24</span><span class="p">])])</span>
                    <span class="n">event_dict</span><span class="p">[</span>
                        <span class="n">phase_type</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">23</span><span class="p">])])</span>
        <span class="c1"># End of event, make data into appropriate structures</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">event_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;UID&#39;</span><span class="p">:</span>
                <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
                <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
                <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Error&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="c1"># Sort keys and append event dict to list</span>
        <span class="n">event_dict</span><span class="p">[</span><span class="s1">&#39;hyp_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span>
        <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">event_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;hyp_file&#39;</span><span class="p">,</span> <span class="s1">&#39;UID&#39;</span><span class="p">]:</span>
            <span class="n">event_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_dict</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">event_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">event_dict_list</span>


<span class="k">def</span> <span class="nf">parse_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses CSV file to data dictionary</span>

<span class="sd">    CSV file format is to have events split by blank lines, a header line showing where the information is, UID and data-type information stored in the first column, e.g.</span>

<span class="sd">        UID=123,,,,</span>
<span class="sd">        PPolarity,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S001,120,70,1,0.01</span>
<span class="sd">        S002,160,60,-1,0.02</span>
<span class="sd">        P/SHRMSAmplitudeRatio,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1,0.05 0.04</span>
<span class="sd">        ,,,,</span>
<span class="sd">        PPolarity ,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1,0.05</span>

<span class="sd">    Is a CSV file with 2 events, one event UID of 123, and PPolarity data at S001 and S002 and P/SHRMSAmplitude data at S003,</span>
<span class="sd">    and a second event with no UID (will default to the event number, in this case 2) with PPolarity data at S003.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename:str csv filename</span>

<span class="sd">    Returns:</span>
<span class="sd">        event_dict_list:list of event data dictionaries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Read file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">events_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over lines</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># End OF event</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
    <span class="c1"># If there is event data, append to the event list</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">events_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c1"># Return parsed events</span>
    <span class="k">return</span> <span class="n">_parse_csv_events</span><span class="p">(</span><span class="n">events_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_csv_events</span><span class="p">(</span><span class="n">events_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses CSV event list to data dictionary</span>

<span class="sd">    CSV file format is to have events split by blank lines, a header line showing where the information is, UID and data-type information stored in the first column, e.g.</span>

<span class="sd">        UID=123,,,,</span>
<span class="sd">        PPolarity,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S001,120,70,1,0.01</span>
<span class="sd">        S002,160,60,-1,0.02</span>
<span class="sd">        P/SHRMSAmplitudeRatio,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1 2,0.05 0.04</span>
<span class="sd">        ,,,,</span>
<span class="sd">        PPolarity ,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1,0.05</span>

<span class="sd">    Is a CSV file with 2 events, one event UID of 123, and PPolarity data at S001 and S002 and P/SHRMSAmplitude data at S003,</span>
<span class="sd">    and a second event with no UID (will default to the event number, in this case 2) with PPolarity data at S003.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename:str csv filename</span>

<span class="sd">    Returns:</span>
<span class="sd">        event_dict_list:list of event data dictionaries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Default keys and values</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;PPolarity&#39;</span>
    <span class="n">name_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">measured_index</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">azimuth_index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">take_off_angle_index</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">error_index</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1"># Loop over events</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events_list</span><span class="p">:</span>
        <span class="n">event_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;UID&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">events_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)}</span>
        <span class="c1"># Set up generic dictionary</span>
        <span class="n">key_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Stations&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s1">&#39;Measured&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="c1"># Loop over lines</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]):</span>
                <span class="c1"># Try tp get UID</span>
                <span class="k">if</span> <span class="s1">&#39;UID&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">event_dict</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                        <span class="s1">&#39;UID&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># End of event</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]):</span>
                        <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
                        <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
                        <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span>
                        <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">])</span>
                        <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_dict</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">key_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Stations&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span> <span class="p">[]},</span> <span class="s1">&#39;Measured&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;Error&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">elif</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="c1"># Try to read header file and get key pieces</span>
                <span class="n">l</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">name_index</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                <span class="n">measured_index</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;measured&#39;</span><span class="p">)</span>
                <span class="n">azimuth_index</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;azimuth&#39;</span><span class="p">)</span>
                <span class="n">take_off_angle_index</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;takeoffangle&#39;</span><span class="p">)</span>
                <span class="n">error_index</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Append item to list</span>
                <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">name_index</span><span class="p">])</span>
                <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">take_off_angle_index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())])</span>
                <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">azimuth_index</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())])</span>
                <span class="n">measured</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_measured</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="n">measured_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">measured</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_measured</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measured</span><span class="p">)</span>
                <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">err</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="n">error_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="c1"># Sort output into correct structs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]):</span>
            <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
            <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
            <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span>
            <span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">key_dict</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">])</span>
            <span class="n">event_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_dict</span>
        <span class="n">event_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">event_dict_list</span>

<span class="c1">#</span>
<span class="c1"># Convert csv to inv</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">csv2inv</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts CSV file to inv file</span>

<span class="sd">    CSV file format is to have events split by blank lines, a header line showing where the information is, UID and data-type information stored in the first column, e.g.::</span>

<span class="sd">        UID=123,,,,</span>
<span class="sd">        PPolarity,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S001,120,70,1,0.01</span>
<span class="sd">        S002,160,60,-1,0.02</span>
<span class="sd">        P/SHRMSAmplitudeRatio,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1,0.05 0.04</span>
<span class="sd">        ,,,,</span>
<span class="sd">        PPolarity ,,,,</span>
<span class="sd">        Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="sd">        S003,110,10,1,0.05</span>

<span class="sd">    Is a CSV file with 2 events, one event UID of 123, and PPolarity data at S001 and S002 and P/SHRMSAmplitude data at S003,</span>
<span class="sd">    and a second event with no UID (will default to the event number, in this case 2) with PPolarity data at S003.</span>

<span class="sd">    Args:</span>
<span class="sd">        filename:str csv filename.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_dict_list</span> <span class="o">=</span> <span class="n">parse_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">output_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.inv&#39;</span>
    <span class="n">PickleOutputTask</span><span class="p">(</span><span class="n">output_name</span><span class="p">,</span> <span class="n">event_dict_list</span><span class="p">)()</span>

<span class="c1">#</span>
<span class="c1"># Hyp output handling</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_convert_mt_space_to_struct</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coverts mt space to binary struct</span>

<span class="sd">    Structure is:</span>

<span class="sd">        File version</span>
<span class="sd">        Nsamples(unsigned long int)</span>
<span class="sd">        Nmtspacesamples(unsigned long int)</span>
<span class="sd">        Converted(bool)</span>
<span class="sd">        Ln_BayesianEvidence</span>
<span class="sd">        DKL</span>
<span class="sd">        NSamples as:</span>
<span class="sd">            P(double)</span>
<span class="sd">            Ln_P(double)</span>
<span class="sd">            Mnn(double)</span>
<span class="sd">            Mee(double)</span>
<span class="sd">            Mdd(double)</span>
<span class="sd">            Mne(double)</span>
<span class="sd">            Mnd(double)</span>
<span class="sd">            Med(double)</span>

<span class="sd">            if Converted is true then each sample also contains:</span>
<span class="sd">                gamma(double)</span>
<span class="sd">                delta(double)</span>
<span class="sd">                kappa(double)</span>
<span class="sd">                h(double)</span>
<span class="sd">                sigma(double)</span>
<span class="sd">                u(double)</span>
<span class="sd">                v(double)</span>
<span class="sd">                strike1(double)</span>
<span class="sd">                dip1(double)</span>
<span class="sd">                rake1(double)</span>
<span class="sd">                strike2(double)</span>
<span class="sd">                dip2(double)</span>
<span class="sd">                rake2(double)</span>

<span class="sd">    Args</span>
<span class="sd">        output_data: output data dictionaries</span>
<span class="sd">        i:[False] event number for multiple events.</span>

<span class="sd">    Returns</span>
<span class="sd">        binary MT and scale factor outputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_version</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">sqrt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Check MT is single event</span>
    <span class="k">if</span> <span class="s1">&#39;moment_tensor_space&#39;</span> <span class="ow">in</span> <span class="n">output_data</span><span class="p">:</span>
        <span class="c1"># single</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c1"># Load converted data and set convert flag (for ending)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;S1&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;D1&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;R1&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;S2&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;D2&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;R2&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span>
        <span class="n">converted</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">converted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Add Number of samples and converted flag</span>
    <span class="n">binary_output</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;QQQ?&#39;</span><span class="p">,</span> <span class="n">file_version</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">],</span>
                                <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">converted</span><span class="p">)</span>
    <span class="c1"># Try to add Bayesian evidence</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># No Bayesian evidence</span>
    <span class="c1"># Try to add Dkl</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;dkl&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># No Dkl</span>
    <span class="c1"># Loop over MTs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Add MT data</span>
        <span class="k">if</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ln_p</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;8d&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ln_p</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                                     <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt2</span><span class="p">,</span>
                                     <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt2</span><span class="p">,</span>
                                     <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="o">+</span><span class="n">end</span><span class="p">][</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">converted</span><span class="p">:</span>
            <span class="c1"># Add converted data</span>
            <span class="n">binary_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;13d&#39;</span><span class="p">,</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span>
                                         <span class="n">i</span><span class="p">],</span> <span class="n">s1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="c1"># Handle scale_factors</span>
    <span class="n">sf_output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;scale_factors&#39;</span> <span class="ow">in</span> <span class="n">output_data</span><span class="p">:</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;scale_factors&#39;</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sf_output</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;scale_factors&#39;</span><span class="p">]),</span> <span class="n">n_events</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;scale_factors&#39;</span><span class="p">]):</span>
            <span class="n">sf_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span>
                <span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="c1"># Add data for each event - Loops over off diagonal elements</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_events</span><span class="o">*</span><span class="p">(</span><span class="n">n_events</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span>
                <span class="n">sf_output</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">,</span>
                                         <span class="n">sf</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">],</span> <span class="n">sf</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">])</span>
                <span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">n_events</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
    <span class="c1"># Return output</span>
    <span class="k">return</span> <span class="n">binary_output</span><span class="p">,</span> <span class="n">sf_output</span>


<span class="k">def</span> <span class="nf">_generate_hyp_output_data</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxMT</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the hyp output text data for the .hyp file</span>

<span class="sd">    Appends or creates the hyp output file (if a hyp file is used as input, the text is stored in the event data)</span>

<span class="sd">    Args</span>
<span class="sd">        event_data: Event data dictionary.</span>
<span class="sd">        inversion_options:[False] Inversion options list.</span>
<span class="sd">        output_data:[False] Output data results</span>
<span class="sd">        maxMT:[np.matrix([[0],[0],[0],[0],[0],[0]])] Maximum moment tensor solution.</span>

<span class="sd">    Returns</span>
<span class="sd">        list of event text outputs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to get the maximum moment tensor</span>
    <span class="kn">from</span> <span class="nn">..inversion</span> <span class="k">import</span> <span class="n">_polarity_misfit_check</span>
    <span class="n">maxMT_tape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">maxMT</span> <span class="o">=</span> <span class="n">unique_columns</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">maxMT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">maxMT</span> <span class="o">=</span> <span class="n">maxMT</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">maxMT_tape</span> <span class="o">=</span> <span class="n">MT6_Tape</span><span class="p">(</span><span class="n">maxMT</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span> <span class="n">e</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">maxMT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">maxMT_tape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Check if its a DC</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">maxMT_tape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">5</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">maxMT_tape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">5</span><span class="p">:</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Try to get the input hyp file if it exists</span>
    <span class="k">if</span> <span class="s1">&#39;hyp_file&#39;</span> <span class="ow">in</span> <span class="n">event_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;hyp_file&#39;</span><span class="p">][:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Generate NLLOC type hyp file</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;NLLOC&#39;</span><span class="p">,</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;NLLOC&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;SIGNATURE&#39;</span><span class="p">,</span> <span class="s1">&#39;mtfit&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">,</span> <span class="s1">&#39;mtfit inversion&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;GRID&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;SEARCH&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;HYPOCENTER&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;OT&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;iy&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;iz&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;GEOGRAPHIC&#39;</span><span class="p">,</span> <span class="s1">&#39;OT&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Lat&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Long&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="s1">&#39;Pmax&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;MFmin&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;MFmax&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;RMS&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Nphs&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Gap&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Dist&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Mamp&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Mdur&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;VPVSRATIO&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="s1">&#39;ExpectX&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;CovXX&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;XZ&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;YZ&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;ZZ&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;EllAz1&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Dip1&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Len1&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Az2&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Dip2&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Len2&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Len3&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;TRANS&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Ins&#39;</span><span class="p">,</span> <span class="s1">&#39;Cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;On&#39;</span><span class="p">,</span> <span class="s1">&#39;Pha&#39;</span><span class="p">,</span> <span class="s1">&#39;FM&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;HrMn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sec&#39;</span><span class="p">,</span> <span class="s1">&#39;Err&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrMag&#39;</span><span class="p">,</span> <span class="s1">&#39;Coda&#39;</span><span class="p">,</span> <span class="s1">&#39;Amp&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Per&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;TTpred&#39;</span><span class="p">,</span> <span class="s1">&#39;Res&#39;</span><span class="p">,</span> <span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;StaLoc(X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z)&#39;</span><span class="p">,</span> <span class="s1">&#39;SDist&#39;</span><span class="p">,</span> <span class="s1">&#39;SAzim&#39;</span><span class="p">,</span> <span class="s1">&#39;RAz&#39;</span><span class="p">,</span> <span class="s1">&#39;RDip&#39;</span><span class="p">,</span> <span class="s1">&#39;RQual&#39;</span><span class="p">,</span> <span class="s1">&#39;Tcorr&#39;</span><span class="p">])</span>
        <span class="c1"># Station Data</span>
        <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Polarity&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">event_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;Polarity&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="s1">&#39;PolarityProb&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="n">phase</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]):</span>
                <span class="n">polarity</span> <span class="o">=</span> <span class="n">nlloc_polarity_inv_dict</span><span class="p">[</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span>
                    <span class="n">event_data</span><span class="p">[</span><span class="n">phase</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">station</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">polarity</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;</span><span class="si">{:5.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="n">phase</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(),</span>
                              <span class="s1">&#39;</span><span class="si">{:5.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_data</span><span class="p">[</span><span class="n">phase</span><span class="o">+</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(),</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;END_PHASE&#39;</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;END_NLLOC&#39;</span><span class="p">])</span>
    <span class="n">phase_line_index</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Ins&#39;</span><span class="p">,</span> <span class="s1">&#39;Cmp&#39;</span><span class="p">,</span> <span class="s1">&#39;On&#39;</span><span class="p">,</span> <span class="s1">&#39;Pha&#39;</span><span class="p">,</span> <span class="s1">&#39;FM&#39;</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;HrMn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sec&#39;</span><span class="p">,</span> <span class="s1">&#39;Err&#39;</span><span class="p">,</span> <span class="s1">&#39;ErrMag&#39;</span><span class="p">,</span> <span class="s1">&#39;Coda&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Amp&#39;</span><span class="p">,</span> <span class="s1">&#39;Per&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;TTpred&#39;</span><span class="p">,</span> <span class="s1">&#39;Res&#39;</span><span class="p">,</span> <span class="s1">&#39;Weight&#39;</span><span class="p">,</span> <span class="s1">&#39;StaLoc(X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z)&#39;</span><span class="p">,</span> <span class="s1">&#39;SDist&#39;</span><span class="p">,</span> <span class="s1">&#39;SAzim&#39;</span><span class="p">,</span> <span class="s1">&#39;RAz&#39;</span><span class="p">,</span> <span class="s1">&#39;RDip&#39;</span><span class="p">,</span> <span class="s1">&#39;RQual&#39;</span><span class="p">,</span> <span class="s1">&#39;Tcorr&#39;</span><span class="p">])</span>
    <span class="n">end_phase_line_index</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">([</span><span class="s1">&#39;END_PHASE&#39;</span><span class="p">])</span>
    <span class="n">geog_line</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GEOGRAPHIC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># GET PHASE LINE AND THEN PREPEND MT AND UPDATE misfit_checks</span>
    <span class="c1"># DC  FOCALMECH dlat dlong depth Mech dipDir dipAng rake mf misfit nObs numberObs</span>
    <span class="c1"># MT  MOMENTTENSOR dlat dlong depth MTNN Mnn EE Mee DD Mdd NE Mne ND Mnd</span>
    <span class="c1"># ED Med mf misfit nObs numberObs</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">source_line_index</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
            <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FOCALMECH&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">source_line_index</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># Make source line</span>
    <span class="k">if</span> <span class="n">dc</span><span class="p">:</span>
        <span class="n">source_line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FOCALMECH&quot;</span><span class="p">,</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="s2">&quot;Mech&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT_tape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)),</span>
                       <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">maxMT_tape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)),</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT_tape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)),</span> <span class="s2">&quot;mf&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;nObs&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">source_line</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;MOMENTTENSOR&quot;</span><span class="p">,</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">geog_line</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="s2">&quot;MTNN&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="s2">&quot;EE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                       <span class="s2">&quot;DD&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="s2">&quot;NE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span> <span class="s2">&quot;ND&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span> <span class="s2">&quot;ED&quot;</span><span class="p">,</span>
                       <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxMT</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))),</span> <span class="s2">&quot;mf&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;nObs&quot;</span><span class="p">,</span> <span class="s2">&quot;?&quot;</span><span class="p">]</span>
    <span class="c1"># Insert before phases start</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phase_line_index</span><span class="p">,</span> <span class="n">source_line</span><span class="p">)</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Run polarity misfit checks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">phase_line_index</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">end_phase_line_index</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">_polarity_misfit_check</span><span class="p">(</span><span class="n">nlloc_polarity_dict</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">23</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">24</span><span class="p">]),</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">],</span> <span class="n">maxMT</span><span class="p">):</span>
            <span class="n">mf</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlloc_polarity_inv_dict</span><span class="p">[</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="n">nlloc_polarity_dict</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlloc_polarity_inv_dict</span><span class="p">[</span>
                <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()[</span><span class="mi">0</span><span class="p">]][</span><span class="n">nlloc_polarity_dict</span><span class="p">[</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">nobs</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># Set number of misfits and number of observations</span>
    <span class="n">lines</span><span class="p">[</span><span class="n">phase_line_index</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="n">lines</span><span class="p">[</span><span class="n">phase_line_index</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nobs</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">output</span>

<span class="c1">#</span>
<span class="c1"># Results data format</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">full_pdf_output_dicts</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiple_events</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_diagnostic_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create output dictionaries for full_pdf format</span>

<span class="sd">    This creates the output dictionaries for the full_pdf format from the output data.</span>

<span class="sd">    Args</span>
<span class="sd">        event_data: Event data containing stations and observations (input data for the inversion).</span>
<span class="sd">        inversion_options:[False] List of inversion data type options.</span>
<span class="sd">        output_data:[False] Output data dictionaries (output from algorithm.__output__()).</span>
<span class="sd">        location_samples:[False] List of location PDF samples.</span>
<span class="sd">        location_sample_multipliers:[False] List of location PDF sample probabilities.</span>
<span class="sd">        multiple_events:[False] Boolean flag for multiple events.</span>
<span class="sd">        _diagnostic_output:[False] Output angle coefficents and other data for testing and diagnostics.</span>
<span class="sd">        normalise:[True] Normalise the output probabilities.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">        station_only:[False] Boolean flag to only output station data (no inversion data).</span>

<span class="sd">    Returns</span>
<span class="sd">        [mdict,sdict]: list of results dict and station distribution dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if station only output (in kwargs)</span>
    <span class="n">station_output</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;station_only&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Set up output dicts</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">other</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">station_distribution</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Get number of events:</span>
    <span class="n">n_events</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">multiple_events</span><span class="p">:</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">event_data</span><span class="p">)</span>
    <span class="n">all_stations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over event_data</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_events</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ev_data</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ev_data</span> <span class="o">=</span> <span class="n">event_data</span>
        <span class="c1"># If P Polarity or P Polarity probability data used, then get</span>
        <span class="c1"># polarities from that</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarity&#39;</span> <span class="ow">in</span> <span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarity&#39;</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;PPolarity&#39;</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev_data</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]))</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarityProbability&#39;</span> <span class="ow">in</span> <span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarityProbability&#39;</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarityProbability&#39;</span> <span class="ow">in</span> <span class="n">inversion_options</span> <span class="ow">and</span> <span class="s1">&#39;PPolarityProbability&#39;</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">observations_dict</span> <span class="o">=</span> <span class="n">ev_data</span><span class="p">[</span><span class="s1">&#39;PPolarityProbability&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">positive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">negative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">positive</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">negative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">measured</span> <span class="o">=</span> <span class="n">positive</span>
                <span class="n">measured</span><span class="p">[</span><span class="n">positive</span> <span class="o">&lt;</span> <span class="n">negative</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">negative</span><span class="p">[</span><span class="n">positive</span> <span class="o">&lt;</span> <span class="n">negative</span><span class="p">]</span>
                <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">measured</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observations_dict</span> <span class="o">=</span> <span class="n">ev_data</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Measured&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">number_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
            <span class="c1"># Make stations object</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_stations</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>
            <span class="n">stations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1"># Check orientations of angles and observations</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">stations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">stations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">stations</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">measured</span>
            <span class="c1"># Append to array</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="c1"># Otherwise just get set of stations in data (loop over observations</span>
        <span class="c1"># dictionaries).</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get all observation dicts used in the inversion</span>
            <span class="k">if</span> <span class="n">inversion_options</span> <span class="ow">and</span> <span class="n">inversion_options</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                <span class="n">observations_dicts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ev_data</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">inversion_options</span> <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="c1"># Otherwise get all data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observations_dicts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">ev_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hyp_file&#39;</span><span class="p">,</span> <span class="s1">&#39;UID&#39;</span><span class="p">]]</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">observations_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">observations_dicts</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">number_stations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">_stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_stations</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">object</span><span class="p">))</span>
                <span class="n">_stations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
                <span class="n">_stations</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">])</span>
                <span class="n">_stations</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">])</span>
                <span class="n">_stations</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">observations_dict</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">_stations</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
            <span class="c1"># Remove duplicate stations</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">):</span>
                <span class="n">sta</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stations</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">n_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">all_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_stations</span> <span class="o">=</span> <span class="n">stations</span>
    <span class="c1"># Station distributions</span>
    <span class="k">if</span> <span class="n">location_samples</span> <span class="ow">and</span> <span class="n">location_sample_multipliers</span><span class="p">:</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;Distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">location_samples</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">location_sample_multipliers</span>
    <span class="c1"># Add inversion options</span>
    <span class="n">other</span><span class="p">[</span><span class="s1">&#39;Inversions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inversion_options</span>
    <span class="c1"># Add diagnostic options if possible</span>
    <span class="k">if</span> <span class="n">_diagnostic_output</span><span class="p">:</span>
        <span class="n">a_polarity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a_polarity&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;a_polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_polarity</span>
        <span class="n">error_polarity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error_polarity&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;error_polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_polarity</span>
        <span class="n">a1_amplitude_ratio</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a1_amplitude_ratio&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;a1_amplitude_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1_amplitude_ratio</span>
        <span class="n">percentage_error1_amplitude_ratio</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentage_error1_amplitude_ratio&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;percentage_error1_amplitude_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentage_error1_amplitude_ratio</span>
        <span class="n">a2_amplitude_ratio</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;a2_amplitude_ratio&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;a2_amplitude_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a2_amplitude_ratio</span>
        <span class="n">percentage_error2_amplitude_ratio</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentage_error2_amplitude_ratio&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">other</span><span class="p">[</span><span class="s1">&#39;percentage_error2_amplitude_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentage_error2_amplitude_ratio</span>
    <span class="c1"># Construct event dict</span>
    <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NSamples&#39;</span><span class="p">:</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;total_number_samples&#39;</span><span class="p">),</span> <span class="s1">&#39;dV&#39;</span><span class="p">:</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dV&#39;</span><span class="p">),</span> <span class="s1">&#39;Probability&#39;</span><span class="p">:</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;probability&#39;</span><span class="p">)}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_data</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">output_data_keys</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="c1"># Handle multiple events data types</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">station_output</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_data_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">:</span>
                <span class="n">event</span><span class="p">[</span><span class="s1">&#39;MTSpace&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;moment_tensor_space&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">event</span><span class="p">[</span><span class="s1">&#39;MTSpace&#39;</span><span class="o">+</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">]:</span>
                <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">,</span> <span class="s1">&#39;R1&#39;</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">]:</span>
                <span class="n">event</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NSamples&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">event</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_ln_pdf</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># Create mdict and sdict and return</span>
    <span class="n">mdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Events&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span> <span class="s1">&#39;Stations&#39;</span><span class="p">:</span> <span class="n">all_stations</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">:</span> <span class="n">other</span><span class="p">}</span>
    <span class="n">sdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">:</span> <span class="n">station_distribution</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdict</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">]):</span>
        <span class="n">sdict</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">mdict</span><span class="p">,</span> <span class="n">sdict</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">hyp_output_dicts</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">inversion_options</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_samples</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">location_sample_multipliers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiple_events</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">_diagnostic_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create output dictionaries for hyp format</span>

<span class="sd">    This creates the output dictionaries for the hyp format from the output data.</span>

<span class="sd">    Args</span>
<span class="sd">        event_data: Event data containing stations and observations (input data for the inversion).</span>
<span class="sd">        inversion_options:[False] List of inversion data type options.</span>
<span class="sd">        output_data:[False] Output data dictionaries (output from algorithm.__output__()).</span>
<span class="sd">        location_samples:[False] List of location PDF samples.</span>
<span class="sd">        location_sample_multipliers:[False] List of location PDF sample probabilities.</span>
<span class="sd">        multiple_events:[False] Boolean flag for multiple events.</span>
<span class="sd">        _diagnostic_output:[False] Output angle coefficents and other data for testing and diagnostics.</span>
<span class="sd">        normalise:[True] Normalise the output probabilities.</span>

<span class="sd">    Keyword Arguments</span>
<span class="sd">        station_only:[False] Boolean flag to only output station data (no inversion data).</span>

<span class="sd">    Returns</span>
<span class="sd">        [output_data,output_mt_binary,output_scale_factor_binary]: list of results as text and binary mt and scale_factor structures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check Multiple events</span>
    <span class="k">if</span> <span class="n">multiple_events</span><span class="p">:</span>
        <span class="n">output_contents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_mt</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_sf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Loop over events</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ev_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">event_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;moment_tensor_space&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output_data</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">maxMT</span> <span class="o">=</span> <span class="n">unique_columns</span><span class="p">(</span><span class="n">output_data</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)][:,</span> <span class="n">ind</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">maxMT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">maxMT</span> <span class="o">=</span> <span class="n">maxMT</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">maxMT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="c1"># Get hyp output data</span>
            <span class="n">output_contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_generate_hyp_output_data</span><span class="p">(</span><span class="n">ev_data</span><span class="p">,</span> <span class="n">inversion_options</span><span class="p">,</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">maxMT</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Get mt and scale_factor outputs</span>
            <span class="n">binary</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">_convert_mt_space_to_struct</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">output_mt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
            <span class="n">output_sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get hyp output data</span>
        <span class="n">output_contents</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_generate_hyp_output_data</span><span class="p">(</span><span class="n">event_data</span><span class="p">,</span> <span class="n">inversion_options</span><span class="p">,</span> <span class="n">output_data</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="c1"># Get mt and scale_factor outputs</span>
        <span class="n">binary</span><span class="p">,</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">_convert_mt_space_to_struct</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span>
        <span class="n">output_mt</span> <span class="o">=</span> <span class="p">[</span><span class="n">binary</span><span class="p">]</span>
        <span class="n">output_sf</span> <span class="o">=</span> <span class="p">[</span><span class="n">sf</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_contents</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_mt</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_sf</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># Output file formats</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">MATLAB_output</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="s1">&#39;mtfitOutput.mat&#39;</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;7.3&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outputs event results to fid as .mat</span>

<span class="sd">    HDF5 is used as default (MATLAB -v7.3 file types), but this can be set using the version keyword.</span>
<span class="sd">    If hdf5storage is not installed then it defaults to pre version 7.3 - can lead to filesize problems with large files.</span>

<span class="sd">    Saves MATLAB output dictionary to fid</span>

<span class="sd">    Args</span>
<span class="sd">        output_data: data dictionary for the event_data.</span>
<span class="sd">        fid:[&#39;mtfitOutput.mat&#39;] Filename for output.</span>
<span class="sd">        pool:[False] Use Jobpool for parallel output.</span>
<span class="sd">        version:[7.3] MATLAB file type to use (v 7.3 requires hdf5storage and h5py).</span>

<span class="sd">    Returns</span>
<span class="sd">        output_string, fid: String of information for stdout, filename of output file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check MATLAB file version (7.3 requires hdf5storage and h5py but can</span>
    <span class="c1"># store files &gt;2Gb)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;7.3&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">savemat</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">savemat</span>
            <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">savemat</span>  <span class="c1"># noqa F401</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">savemat</span> <span class="k">as</span> <span class="n">st_savemat</span>
        <span class="n">st_ver</span> <span class="o">=</span> <span class="s1">&#39;7&#39;</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">savemat</span> <span class="k">as</span> <span class="n">st_savemat</span>  <span class="c1"># noqa F401</span>
        <span class="n">st_ver</span> <span class="o">=</span> <span class="s1">&#39;7.3&#39;</span>
    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;Outputting data in MATLAB format --version=</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="c1"># Get sdict and mdict</span>
    <span class="n">sdict</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sdict</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">output_data</span>
    <span class="c1"># Convert dict keys to or from unicode</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s1">&#39;7.3&#39;</span><span class="p">:</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">st_ver</span> <span class="o">==</span> <span class="s1">&#39;7.3&#39;</span> <span class="ow">and</span> <span class="n">sdict</span><span class="p">:</span>
        <span class="n">sdict</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">sdict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sdict</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">sdict</span><span class="p">)</span>
    <span class="c1"># Run output tasks (using pool or otherwise)</span>
    <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)):</span>
        <span class="c1"># Check for cPickle bug #13555 http://bugs.python.org/issue13555 which seems linked to multiprocessing issue #17560 http://bugs.python.org/issue17560</span>
        <span class="c1"># cannot pickle files longer than 2**31 (32 bit encoding used for</span>
        <span class="c1"># cPickle length)</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Using jobPool to save file to </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mdict</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span>
                <span class="n">MATLABOutputTask</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="n">mdict</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sdict</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">MATLABOutputTask</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;StationDistribution.mat&#39;</span><span class="p">,</span> <span class="n">sdict</span><span class="p">,</span> <span class="n">st_ver</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mdict</span><span class="p">:</span>
            <span class="n">MATLABOutputTask</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="n">mdict</span><span class="p">,</span> <span class="n">version</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">sdict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">MATLABOutputTask</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;StationDistribution.mat&#39;</span><span class="p">,</span> <span class="n">sdict</span><span class="p">,</span> <span class="n">st_ver</span><span class="p">)()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Saved to </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span>


<span class="k">def</span> <span class="nf">pickle_output</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="s1">&#39;mtfitOutput.out&#39;</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outputs event results to fid as .out (default)</span>

<span class="sd">    cPickle output of MATLAB format output.</span>

<span class="sd">    Saves output dictionary to fid</span>

<span class="sd">    Args</span>
<span class="sd">        output_data: data dictionary for the event_data.</span>
<span class="sd">        fid:[&#39;mtfitOutput.out&#39;] Filename for output.</span>
<span class="sd">        pool:[False] Use Jobpool for parallel output.</span>

<span class="sd">    Returns</span>
<span class="sd">        output_string,fid: String of information for stdout, filename of output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set file ending</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.out&#39;</span>
    <span class="n">sdict</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">sdict</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mdict</span> <span class="o">=</span> <span class="n">output_data</span>
    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;Outputting data in python format</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1"># Output structure to cPickle.</span>
    <span class="k">if</span> <span class="n">pool</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">])</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">)):</span>
        <span class="c1"># Check for cPickle bug #13555 http://bugs.python.org/issue13555 which seems linked to multiprocessing issue #17560 http://bugs.python.org/issue17560</span>
        <span class="c1"># cannot pickle files longer than 2**31 (32 bit encoding used for</span>
        <span class="c1"># cPickle length)</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Using jobPool to save file to &#39;</span><span class="o">+</span><span class="n">fid</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">PickleOutputTask</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">mdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sdict</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">PickleOutputTask</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;StationDistribution&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PickleOutputTask</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">mdict</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">sdict</span><span class="p">:</span>
            <span class="n">PickleOutputTask</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;StationDistribution&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sdict</span><span class="p">)()</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Saved to &#39;</span><span class="o">+</span><span class="n">fid</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span>


<span class="k">def</span> <span class="nf">hyp_output</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="n">fid</span><span class="o">=</span><span class="s1">&#39;mtfitOutput.hyp&#39;</span><span class="p">,</span> <span class="n">pool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Outputs event results to fid as .hyp (default)</span>

<span class="sd">    hyp format output.</span>

<span class="sd">    Saves output dictionary to fid</span>

<span class="sd">    Args</span>
<span class="sd">        output_data: data dictionary for the event_data.</span>
<span class="sd">        fid:[&#39;mtfitOutput.hyp&#39;] Filename for output.</span>
<span class="sd">        pool:[False] Use Jobpool for parallel output.</span>

<span class="sd">    Returns</span>
<span class="sd">        output_string,fid: String of information for stdout, filename of output file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set file ending</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.hyp&#39;</span>
    <span class="n">mt_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sf_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Get data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mt_data</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">sf_data</span> <span class="o">=</span> <span class="n">output_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output_data</span>
    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;Outputting data in NLLOC hyp format</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="c1"># Output using pool or otherwise</span>
    <span class="k">if</span> <span class="n">pool</span><span class="p">:</span>
        <span class="c1"># Check for cPickle bug #13555 http://bugs.python.org/issue13555 which seems linked to multiprocessing issue #17560 http://bugs.python.org/issue17560</span>
        <span class="c1"># cannot pickle files longer than 2**31 (32 bit encoding used for</span>
        <span class="c1"># cPickle length)</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Using jobPool to save file to &#39;</span><span class="o">+</span><span class="n">fid</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span><span class="n">HypOutputTask</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mt_data</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mt_data</span><span class="p">)</span><span class="o">*</span><span class="mi">128</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">):</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span>
                <span class="n">HypOutputTask</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.hyp&#39;</span><span class="p">,</span> <span class="s1">&#39;.mt&#39;</span><span class="p">),</span> <span class="n">mt_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sf_data</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">sf_data</span><span class="p">)</span><span class="o">*</span><span class="mi">128</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">):</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">custom_task</span><span class="p">(</span>
                <span class="n">HypOutputTask</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.hyp&#39;</span><span class="p">,</span> <span class="s1">&#39;.sf&#39;</span><span class="p">),</span> <span class="n">sf_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">HypOutputTask</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="kc">False</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">mt_data</span><span class="p">:</span>
            <span class="n">HypOutputTask</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.hyp&#39;</span><span class="p">,</span> <span class="s1">&#39;.mt&#39;</span><span class="p">),</span> <span class="n">mt_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">sf_data</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">sf_data</span><span class="p">):</span>
            <span class="n">HypOutputTask</span><span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.hyp&#39;</span><span class="p">,</span> <span class="s1">&#39;.sf&#39;</span><span class="p">),</span> <span class="n">sf_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">)()</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Saved to &#39;</span><span class="o">+</span><span class="n">fid</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">output_string</span><span class="p">,</span> <span class="n">fid</span>

<span class="c1">#</span>
<span class="c1"># Read inversion output</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">read_binary_output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads binary output and converts to data dict.</span>

<span class="sd">    Reads the binary output created using hyp output format (_convert_mt_space_to_struct) and returns an output data dictionary.</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read.</span>

<span class="sd">    Keyword Args</span>
<span class="sd">        version: int version of the file format (Outputs from versions before 1.0.3 did not contain</span>
<span class="sd">                 the DKL estimate or file version, so the version must be set to 1 for these,</span>
<span class="sd">                 otherwise the version is set automatically).</span>

<span class="sd">    Returns</span>
<span class="sd">        output_data: list of dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sqrt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="c1"># Read file version</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Read total number and number of saved samples and converted flag</span>
            <span class="n">total_number_samples</span><span class="p">,</span> <span class="n">number_mt_samples</span><span class="p">,</span> <span class="n">converted</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;QQ?&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span>
            <span class="c1"># Get the Bayesian Evidence estimate</span>
            <span class="n">ln_bayesian_evidence</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Get the DKL estimate</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">dkl</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="c1"># Generate blank arrays</span>
            <span class="n">MTSpace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="n">number_mt_samples</span><span class="p">)))</span>
            <span class="n">Probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_mt_samples</span><span class="p">)))</span>
            <span class="n">Ln_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_mt_samples</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">converted</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">d1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_mt_samples</span><span class="p">,))</span>
            <span class="c1"># Loop over samples</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_mt_samples</span><span class="p">):</span>
                <span class="n">Probability</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Ln_P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Mnn</span><span class="p">,</span> <span class="n">Mee</span><span class="p">,</span> <span class="n">Mdd</span><span class="p">,</span> <span class="n">Mne</span><span class="p">,</span> <span class="n">Mnd</span><span class="p">,</span> <span class="n">Med</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;8d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mnn</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mee</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mdd</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt2</span><span class="o">*</span><span class="n">Mne</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt2</span><span class="o">*</span><span class="n">Mnd</span>
                <span class="n">MTSpace</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqrt2</span><span class="o">*</span><span class="n">Med</span>
                <span class="k">if</span> <span class="n">converted</span><span class="p">:</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r1</span><span class="p">[</span>
                        <span class="n">i</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;13d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">104</span><span class="p">))</span>
            <span class="c1"># create output data dict</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">:</span> <span class="n">MTSpace</span><span class="p">,</span> <span class="s1">&#39;dkl&#39;</span><span class="p">:</span> <span class="n">dkl</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span>
                   <span class="n">Probability</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">Ln_P</span><span class="p">,</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span> <span class="n">total_number_samples</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">converted</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span> <span class="n">u</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;S1&#39;</span><span class="p">:</span> <span class="n">s1</span><span class="p">,</span> <span class="s1">&#39;D1&#39;</span><span class="p">:</span> <span class="n">d1</span><span class="p">,</span>
                            <span class="s1">&#39;R1&#39;</span><span class="p">:</span> <span class="n">r1</span><span class="p">,</span> <span class="s1">&#39;S2&#39;</span><span class="p">:</span> <span class="n">s2</span><span class="p">,</span> <span class="s1">&#39;D2&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="p">,</span> <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span> <span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">:</span> <span class="n">ln_bayesian_evidence</span><span class="p">})</span>
            <span class="c1"># Append to output data list</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_data</span>


<span class="k">def</span> <span class="nf">read_sf_output</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads binary scale factor output and converts to data dict.</span>

<span class="sd">    Reads the binary scalefactor output created using hyp output format (_convert_mt_space_to_struct) and returns an output data dictionary.</span>
<span class="sd">    The scalefactor pairs are stored as an array with the indices corresponding to the pairs 0,1 0,2 0,3 ... 1,2 1,3 .... etc.</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read.</span>

<span class="sd">    Returns</span>
<span class="sd">        output_data: list of dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Open file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="c1"># Read total number and number of saved samples and number of events</span>
            <span class="n">total_number_samples</span><span class="p">,</span> <span class="n">number_samples</span><span class="p">,</span> <span class="n">n_events</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;QQQ&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
            <span class="c1"># Generate blank arrays</span>
            <span class="n">Mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">n_events</span><span class="o">*</span><span class="p">(</span><span class="n">n_events</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="n">number_samples</span><span class="p">)))</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">n_events</span><span class="o">*</span><span class="p">(</span><span class="n">n_events</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="n">number_samples</span><span class="p">)))</span>
            <span class="n">Ln_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_samples</span><span class="p">)))</span>
            <span class="n">Probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_samples</span><span class="p">)))</span>
            <span class="c1"># Loop over samples</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_samples</span><span class="p">):</span>
                <span class="n">Probability</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Ln_P</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
                <span class="c1"># Loop over event pairs (stored as 0,1 0,2 0,3 ... 1,2 1,3 ....)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_events</span><span class="o">*</span><span class="p">(</span><span class="n">n_events</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)):</span>
                    <span class="n">Mu</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
            <span class="c1"># Creat output dict</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale_factors&#39;</span><span class="p">:</span> <span class="n">Mu</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">Probability</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span>
                   <span class="n">Ln_P</span><span class="p">,</span> <span class="s1">&#39;total_number_samples&#39;</span><span class="p">:</span> <span class="n">total_number_samples</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">S</span><span class="p">}</span>
            <span class="c1"># Append to output list</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_data</span>


<span class="k">def</span> <span class="nf">read_matlab_output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">station_distribution</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads matlab output and converts to data dict.</span>

<span class="sd">    Reads the matlab output created using the matlab output format and returns an output data dictionary.</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read.</span>

<span class="sd">    Returns</span>
<span class="sd">        (dict,dict): tuple of (events,data) dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hdf5</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">loadmat</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">loadmat</span>
            <span class="n">hdf5</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">loadmat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hdf5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Input file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; can&#39;t be read as old or new style (hdf5) format&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Input file &#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&quot; can&#39;t be read - it could be a new style (hdf5) format, which requires the hdf5storage module to be installed.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">station_distribution</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_parse_matlab_station_distribution</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_parse_matlab_output</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_matlab_stations</span><span class="p">(</span><span class="n">stations_data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">stations_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="n">stations_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="n">stations_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Polarity&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;polarity&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations_data</span><span class="p">:</span>
                <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;takeoff_angle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;polarity&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations_data</span><span class="p">:</span>
                    <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;takeoff_angle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;polarity&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">stations_data</span><span class="p">:</span>
                        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;takeoff_angle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">stations</span>


<span class="k">def</span> <span class="nf">_parse_matlab_station_distribution</span><span class="p">(</span><span class="n">station_distribution_data</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">station_distribution</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">station_distribution_data</span><span class="p">[</span>
            <span class="s1">&#39;StationDistribution&#39;</span><span class="p">][</span><span class="s1">&#39;Probability&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">station_distribution_data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">][</span><span class="s1">&#39;Distribution&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">st_sample</span> <span class="o">=</span> <span class="n">_parse_matlab_stations</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">st_sample</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;polarity&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">distribution</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st_sample</span><span class="p">)</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distribution</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">station_distribution</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span>
            <span class="n">station_distribution_data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">station_distribution</span>


<span class="k">def</span> <span class="nf">_parse_matlab_output</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the matlab structured data from the matlab file and returns an output data dictionary.</span>

<span class="sd">    Args</span>
<span class="sd">        data: dict matlab data.</span>

<span class="sd">    Returns</span>
<span class="sd">        (dict,dict): tuple of (events,data) dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_events</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
        <span class="n">ev_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MTSpace&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">in</span> <span class="n">u</span><span class="p">]</span>
        <span class="n">n_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev_ind</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Multiple Events</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">ev_ind</span><span class="p">:</span>
            <span class="n">ev_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">key_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">])</span>
            <span class="n">key_map</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ln_pdf&#39;</span>
            <span class="n">key_map</span><span class="p">[</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Probability&#39;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

                <span class="k">if</span> <span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MTSpace&#39;</span><span class="p">]:</span>
                    <span class="n">ev_data</span><span class="p">[</span><span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev_data</span><span class="p">[</span><span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">ev_data</span><span class="p">[</span><span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ev_data</span><span class="p">[</span><span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ev_data</span><span class="p">[</span><span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">_parse_matlab_stations</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev_data</span><span class="p">)</span>
            <span class="n">stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">events</span><span class="p">,</span> <span class="n">stations</span>
    <span class="c1"># Single Event</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">_parse_matlab_stations</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Stations&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MTSpace&#39;</span><span class="p">]:</span>
                <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">events</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Events&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">events</span><span class="p">[</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">events</span><span class="p">[</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">events</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">stations</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_pickle_output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">station_distribution</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads pickle output and returns the data</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read.</span>

<span class="sd">    Returns</span>
<span class="sd">        (dict,dict): tuple of (events,data) dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">station_distribution</span><span class="p">:</span>
        <span class="n">station_distribution</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">]</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_distribution</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
        <span class="n">old_dist</span> <span class="o">=</span> <span class="n">station_distribution</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Distribution&#39;</span><span class="p">)</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">old_dist</span><span class="p">:</span>
            <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">],</span>
                                                         <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">],</span>
                                                         <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">station_distribution</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s1">&#39;Stations&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">_parse_matlab_stations</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Stations&#39;</span><span class="p">))</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">if</span> <span class="s1">&#39;Events&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Events&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">stations</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_hyp_output</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads hyp output and returns the data</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read.</span>

<span class="sd">    Returns</span>
<span class="sd">        (dict,dict): tuple of (events,data) dictionaries of output data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hyp_data</span> <span class="o">=</span> <span class="n">parse_hyp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.hyp&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">hyp_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">read_binary_output</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.mt&#39;</span><span class="p">)</span>
    <span class="n">key_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;takeoffangle&#39;</span><span class="p">:</span> <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="n">hyp_data</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">][</span><span class="s1">&#39;Stations&#39;</span><span class="p">]</span>
        <span class="n">stations</span><span class="p">[</span><span class="s1">&#39;polarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hyp_data</span><span class="p">[</span><span class="s1">&#39;PPolarity&#39;</span><span class="p">][</span><span class="s1">&#39;Measured&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">key_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="n">key_map</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="n">stations</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">stations</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">events</span><span class="p">,</span> <span class="n">stations</span>


<span class="k">def</span> <span class="nf">read_scatangle_output</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">number_location_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads scatangle file for plotting</span>

<span class="sd">    Args</span>
<span class="sd">        filename: str filename to read</span>

<span class="sd">    Keyword Args</span>
<span class="sd">        number_location_samples: int number of location samples to sub-sample to.</span>
<span class="sd">        bin_size: float bin size for binning the angle samples in.</span>

<span class="sd">    Returns</span>
<span class="sd">        dict: station distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">][</span><span class="s1">&#39;Distribution&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">][</span><span class="s1">&#39;Probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_scatangle</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span>
                                                                                                              <span class="n">number_location_samples</span><span class="o">=</span><span class="n">number_location_samples</span><span class="p">,</span>
                                                                                                              <span class="n">bin_size</span><span class="o">=</span><span class="n">bin_size</span><span class="p">)</span>
    <span class="n">station_distribution</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;StationDistribution&#39;</span><span class="p">]</span>
    <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station_distribution</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Probability&#39;</span><span class="p">)</span>
    <span class="n">old_dist</span> <span class="o">=</span> <span class="n">station_distribution</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;Distribution&#39;</span><span class="p">)</span>
    <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">old_dist</span><span class="p">:</span>
        <span class="n">station_distribution</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">],</span> <span class="s1">&#39;takeoff_angle&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;TakeOffAngle&#39;</span><span class="p">],</span> <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">st</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">station_distribution</span>

<span class="c1"># Dictionary conversion functions for file_io</span>


<span class="k">def</span> <span class="nf">convert_keys_to_unicode</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts dictionary keys to unicode</span>

<span class="sd">    Required for MATLAB -v7.3 format output. This recursively changes strings in a dictionary to unicode.</span>

<span class="sd">    Args</span>
<span class="sd">        dictionary: Input dictionary.</span>
<span class="sd">    Returns</span>
<span class="sd">        dictionary: Converted dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">:</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_list</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">new_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">new_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">new_dictionary</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dictionary</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;unicode-escape&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_dictionary</span>
    <span class="k">return</span> <span class="n">dictionary</span>


<span class="k">def</span> <span class="nf">convert_keys_from_unicode</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts dictionary keys from  unicode</span>

<span class="sd">    Required for MATLAB -v7 format output. This recursively changes strings in a dictionary from unicode.</span>

<span class="sd">    Args</span>
<span class="sd">        dictionary: Input dictionary.</span>
<span class="sd">    Returns</span>
<span class="sd">        dictionary: Converted dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">new_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="p">:</span>
            <span class="n">new_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_list</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">new_dictionary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">new_value</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">new_value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">new_value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">new_dictionary</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dictionary</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">convert_keys_from_unicode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_dictionary</span>
    <span class="k">return</span> <span class="n">dictionary</span>


<span class="k">def</span> <span class="nf">unique_columns</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">counts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get unique columns in an array (used for max probability MT)&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">uniq</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="kc">True</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))]]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">uniq</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">counts</span><span class="p">:</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="kc">True</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indx</span><span class="p">[</span><span class="n">u</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">j</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">index</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="kc">True</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">!=</span> <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-multiprocessing_helper.html" class="btn btn-neutral float-right" title="17.1.6.1.4. mtfit.utilities.multiprocessing_helper" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source-utilities_extensions.html" class="btn btn-neutral" title="17.1.6.1.2. mtfit.utilities.extensions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David Pugh.
      Last updated on Oct 26, 2017 (version 0+untagged.15.g53a39ba).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0+untagged.15.g53a39ba',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>