

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="English" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="English" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.1.4. MTfit.sampling &mdash; MTfit documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="3.1.5. MTfit.run" href="source-run.html" />
    <link rel="prev" title="3.1.3. MTfit.probability" href="source-probability.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> MTfit
          

          
            
            <img src="_static/MTfitsphinx.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.3a16
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">2. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">3. Running MTfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">4. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="real-tutorial.html">5. Tutorial: Real Data Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">6. Bayesian Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">7. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">8. Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtconvert.html">9. Moment Tensor Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">10. Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplot.html">11. Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_classes.html">1. Plot Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplotcli.html">12. MTplot Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="inversion.html">13. Inversion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">14. Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">2. Glossary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="source.html">3. Source Code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="source.html#contents">3.1. Contents:</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="source-inversion.html">3.1.1. MTfit.inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-algorithms.html">3.1.2. MTfit.algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-probability.html">3.1.3. MTfit.probability</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.1.4. MTfit.sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-run.html">3.1.5. MTfit.run</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-utilities.html">3.1.6. MTfit.utilities</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-extensions.html">3.1.7. MTfit.extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-convert.html">3.1.8. MTfit.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-plot.html">3.1.9. MTfit.plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/djpugh/MTfit">GitHub Repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MTfit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="source.html">3. MTfit Source Code</a> &raquo;</li>
        
      <li>3.1.4. MTfit.sampling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/source-sampling.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mtfit-sampling">
<h1>3.1.4. MTfit.sampling<a class="headerlink" href="#mtfit-sampling" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sampling.py</span>
<span class="sd">***********</span>
<span class="sd">module containing basic Sample object for storing samples from the source pdf.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># **Restricted:  For Non-Commercial Use Only**</span>
<span class="c1"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c1"># and non-commercially funded academic research purposes.</span>
<span class="c1">#</span>
<span class="c1"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">LnPDF</span>
<span class="kn">from</span> <span class="nn">.probability</span> <span class="k">import</span> <span class="n">dkl_estimate</span>
<span class="kn">from</span> <span class="nn">.probability.probability</span> <span class="k">import</span> <span class="n">_6sphere_prior</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">convert_keys_to_unicode</span>
<span class="kn">from</span> <span class="nn">.utilities.file_io</span> <span class="k">import</span> <span class="n">unique_columns</span>
<span class="kn">from</span> <span class="nn">.convert</span> <span class="k">import</span> <span class="n">output_convert</span>

<span class="c1"># Because long doesn&#39;t exist in python 3 our isinstance tests fail</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Sample&#39;</span><span class="p">,</span> <span class="s1">&#39;FileSample&#39;</span><span class="p">,</span> <span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">,</span> <span class="s1">&#39;_convert&#39;</span><span class="p">,</span> <span class="s1">&#39;_6sphere_prior&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Sample</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample object for storing source pdf samples.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_sample_size</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">number_events</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">_6sphere_prior</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sample initialisation</span>

<span class="sd">        Args</span>
<span class="sd">            initial_sample_size:[100000] Initial size for MT vector</span>
<span class="sd">            number_events:[1] Number of events in sample (allows for sampling multiple event joint PDF)</span>
<span class="sd">            prior:[6sphere]</span>

<span class="sd">        Returns</span>
<span class="sd">            Sample object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">number_events</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">initial_sample_size</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_events</span> <span class="o">=</span> <span class="n">number_events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_sample_size</span> <span class="o">=</span> <span class="n">initial_sample_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span> <span class="o">=</span> <span class="n">prior</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moment_tensors</span><span class="p">,</span> <span class="n">ln_pdf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extensions_scale_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends new samples to the Sample object, extending the MT array if the limit is reached.</span>

<span class="sd">        Args</span>
<span class="sd">            moment_tensors: numpy matrix of moment tensors to append.</span>
<span class="sd">            ln_pdf: numpy matrix/array or PDF object containing ln_pdf samples corresponding to the moment tensors in moment_tensors (must be same length).</span>
<span class="sd">            n: number of tried samples (including zero probability samples).</span>
<span class="sd">            scale_factor:[False] scale_factor estimates for relative amplitude inversion.</span>
<span class="sd">            extensions_scale_factor:[False] scale_factor estimates for extensions carrying out relative inversion.</span>

<span class="sd">        Returns</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If scale_factor is passed as an argument, and no scale_factor data stored, create the array</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;extensions_scale_factor&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extensions_scale_factor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Check if moment tensors are a list (multiple events) and convert to the correct format</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">)</span>
            <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="c1"># Check moment tensor and PDF shape</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="ow">and</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">([</span><span class="n">mt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">mt</span> <span class="ow">in</span> <span class="n">moment_tensors</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape must be 6x1 when using a float ln_pdf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="ow">and</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape[2] and ln_pdf shape[2] must be the same&#39;</span><span class="p">)</span>
        <span class="c1"># Add number of samples (n) to total number of samples (self.n)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="c1"># Convert ln_pdf to ln_pdf form</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)):</span>
            <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
        <span class="c1"># Get non-zero probability samples</span>
        <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
        <span class="c1"># Check scale factor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># single event</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">[</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extensions_scale_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
        <span class="c1"># Check if there are non-zero moment tensor samples</span>
        <span class="k">if</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Has samples</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span> <span class="o">!=</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape[2] and ln_pdf shape[2] must be the same&#39;</span><span class="p">)</span>
            <span class="c1"># Check if moment tensor sampling array has enough spare elements</span>
            <span class="n">size_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&gt;</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># If size-check fails, append new zero samples to the array</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">size_check</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_sample_size</span><span class="p">)),</span>
                                                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">size_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">&gt;</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Set moment tensor samples in array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="o">+</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">moment_tensors</span>
            <span class="c1"># Handle scale factors</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="c1"># Scale factor dict containing mu and s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">):</span>
                <span class="c1"># Scale factor dict containing mu and s</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extensions_scale_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions_scale_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="c1"># Append to PDF</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">[:,</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()])</span>
            <span class="c1"># Update moment tensor index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">+=</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">discard</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">mcmc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns nonzero probability samples in a dictionary</span>

<span class="sd">        Keyword Arguments</span>
<span class="sd">            normalise:[True] boolean flag for normalising the PDF output or not.</span>
<span class="sd">            convert:[False] boolean flag for converting the moment tensor output into different parameterisations</span>
<span class="sd">            n_samples:[0] Total number of samples (not using self.pdf.n as multiple samplings for e.g. MPI inversions)</span>
<span class="sd">            discard:[10000] float, if non-zero discard is a multiplier on n_samples so that samples with probability less than 1/(n_samples*discard) are discarded as negligeable</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of nonzero probability samples as:</span>
<span class="sd">                {&#39;MTSpace&#39;:nonzeromoment_tensors,&#39;Probability&#39;:nonzeroProbability,&#39;dV&#39;:volumeElement}</span>

<span class="sd">        Raises</span>
<span class="sd">            ValueError: No nonzero probability samples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Gets normalised and unnormalised pdfs</span>
        <span class="n">ln_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">normalise</span><span class="p">)</span>
        <span class="n">un_normalised_ln_pdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">normalise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">------------MTfit Forward Model Output------------</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># Check if any non-zero samples</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;No Non-Zero probability samples</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="p">[]},</span> <span class="n">output_string</span>
        <span class="c1"># Get max probability solutions</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Sample Max Probability: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">moment_tensors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">max_p_mt</span> <span class="o">=</span> <span class="n">unique_columns</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_pdf</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">))[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_p_mt</span> <span class="o">=</span> <span class="n">unique_columns</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ln_pdf</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="p">))])</span>
        <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Sample Max Probability MT:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">max_p_mt</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># Check if discarding samples</span>
        <span class="k">if</span> <span class="n">discard</span> <span class="ow">and</span> <span class="n">n_samples</span><span class="p">:</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Discarding samples less than 1/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">discard</span><span class="o">*</span><span class="n">n_samples</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; of the maximum likelihood value as negligeable</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="c1"># Check if there are samples</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">):</span>
            <span class="c1"># Get non_zero samples</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">discard</span><span class="o">=</span><span class="n">discard</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">discard</span> <span class="ow">and</span> <span class="n">n_samples</span><span class="p">:</span>
                <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;After discard, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">non_zero</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; samples remain</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">[:,</span> <span class="n">non_zero</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">probability</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">[</span><span class="n">non_zero</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">un_normalised_ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">un_normalised_ln_pdf</span> <span class="o">=</span> <span class="n">un_normalised_ln_pdf</span><span class="p">[:,</span> <span class="n">non_zero</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">un_normalised_ln_pdf</span> <span class="o">=</span> <span class="n">un_normalised_ln_pdf</span><span class="p">[</span><span class="n">non_zero</span><span class="p">]</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;probability&#39;</span><span class="p">:</span> <span class="n">probability</span><span class="p">,</span> <span class="s1">&#39;dV&#39;</span><span class="p">:</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">dV</span><span class="p">,</span> <span class="s1">&#39;ln_pdf&#39;</span><span class="p">:</span> <span class="n">un_normalised_ln_pdf</span><span class="p">}</span>
            <span class="c1"># Multiple events</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;scale_factor&#39;</span><span class="p">):</span>
                    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;scale_factors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">[</span><span class="n">non_zero</span><span class="p">])</span>
                <span class="c1"># Create MTspace for multiple events</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="p">):</span>
                    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">moment_tensors</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">non_zero</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
                        <span class="c1"># convert results</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_convert</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">non_zero</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
                    <span class="c1"># convert results</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_convert</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;moment_tensor_space&#39;</span><span class="p">]))</span>
            <span class="c1"># Bayesian evidence calculation</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mcmc</span><span class="p">:</span>
                    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_bayesian_evidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ln_bayesian_evidence</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prior</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># Should fail when McMC and not MC</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mcmc</span><span class="p">:</span>
                    <span class="c1"># DKL</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="c1"># Multiple events</span>
                        <span class="n">g</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">))],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">))],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gi</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
                                <span class="n">V</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">V</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Single event</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.000001</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.000001</span><span class="p">:</span>
                            <span class="n">V</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">V</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="n">output_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">V</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;dkl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dkl_estimate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
                    <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;PDF Kullback-Leibler Divergence Estimate (Dkl): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;dkl&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="n">LnPDF</span><span class="p">):</span>
                <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_ln_pdf</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">output_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No non zero probability samples found.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns number of tried samples.</span>

<span class="sd">        Returns</span>
<span class="sd">            n: number of forward modelled MT samples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span>

    <span class="k">def</span> <span class="nf">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return non zero indices&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FileSample</span><span class="p">(</span><span class="n">Sample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FileSample object stores sample values on disk rather than in memory (writes to disk each time)</span>

<span class="sd">    These then need to be cleaned up but should allow for simple restore and recover values.</span>

<span class="sd">    NEEDS hdf5 (MATLAB -v7.3) storage</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;MTfit_run&#39;</span><span class="p">,</span> <span class="n">file_safe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FileSample initialisation</span>

<span class="sd">        Args</span>
<span class="sd">            fname:[&#39;MTfit_run&#39;] Filename for storage.</span>
<span class="sd">            file_safe:[True] Boolean flag for file safe output (i.e. write and move).</span>

<span class="sd">        Returns</span>
<span class="sd">            FileSample object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileSample</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Check if hdf5storage is installed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">savemat</span>
            <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">loadmat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span> <span class="o">=</span> <span class="n">savemat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadmat</span> <span class="o">=</span> <span class="n">loadmat</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;hdf5storage module missing - required for FileSample sample type&#39;</span><span class="p">)</span>
        <span class="c1"># Set default filename</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;MTfit_run&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_in_progress.mat&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_samples</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdf</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span> <span class="o">=</span> <span class="n">file_safe</span>
        <span class="c1"># Load data if file exists (recover)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;non_zero_samples&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moment_tensors</span><span class="p">,</span> <span class="n">ln_pdf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extensions_scale_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends new samples to the FileSample file.</span>

<span class="sd">        Args</span>
<span class="sd">            moment_tensors: numpy matrix of moment tensors to append.</span>
<span class="sd">            ln_pdf: numpy matrix/array or PDF object containing ln_pdf samples corresponding to the moment tensors in moment_tensors (must be same length).</span>
<span class="sd">            n: number of tried samples (including zero probability samples).</span>
<span class="sd">            scale_factor:[False] scale_factor estimates for relative amplitude inversion.</span>
<span class="sd">            extensions_scale_factor:[False] scale_factor estimates for extensions carrying out relative inversion.</span>

<span class="sd">        Returns</span>
<span class="sd">            None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">)</span>
            <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="ow">and</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape must be 6x1 when using a float ln_pdf&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="ow">and</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape[2] and ln_pdf shape[2] must be the same&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)):</span>
            <span class="n">ln_pdf</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">ln_pdf</span><span class="p">)</span>
        <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">)</span>
            <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">scale_factor</span><span class="p">[</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">):</span>
            <span class="c1"># Scale factor dict containing mu and s</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">extensions_scale_factor</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">:</span>
            <span class="n">old_fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">+=</span> <span class="s1">&#39;~&#39;</span>
        <span class="k">if</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Check there are samples</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span> <span class="o">!=</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Moment Tensor shape[2] and ln_pdf shape[2] must be the same&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;MTSpace_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">):</span> <span class="n">moment_tensors</span><span class="p">},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="c1"># dict with p mu and s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;scale_factor_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">):</span> <span class="n">convert_keys_to_unicode</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scale_factor</span><span class="p">))},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions_scale_factor</span><span class="p">):</span>
                <span class="c1"># dict with p mu and s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;extensions_scale_factor_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">):</span> <span class="n">extensions_scale_factor</span><span class="p">},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;LnPDF_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">):</span> <span class="n">ln_pdf</span><span class="p">[:,</span> <span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;non_zero_samples&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_samples</span><span class="p">},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_i</span><span class="p">},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">},</span> <span class="n">appendmat</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">,</span> <span class="n">store_python_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_safe</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">,</span> <span class="n">old_fname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">old_fname</span>

    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns nonzero probability samples in a dictionary</span>

<span class="sd">        Returns</span>
<span class="sd">            Dictionary of nonzero probability samples as:</span>
<span class="sd">                {&#39;MTSpace&#39;:nonzero_moment_tensors,&#39;Probability&#39;:nonzero_probability,&#39;dV&#39;:volume_element}</span>

<span class="sd">        Raises</span>
<span class="sd">            ValueError: No nonzero probability samples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># load data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="c1"># Set up attributes for Sample.output call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">number_events</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_samples</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="s1">&#39;scale_factor&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;MTSpace&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">]:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ln_pdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LnPDF</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;LnPDF_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]))</span>
            <span class="n">moment_tensors</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;MTSpace_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moment_tensors</span><span class="p">[:,</span> <span class="n">_x</span><span class="p">:</span> <span class="n">_x</span><span class="o">+</span><span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">moment_tensors</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;scale_factor_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)])</span>
            <span class="n">_x</span> <span class="o">+=</span> <span class="n">moment_tensors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale_factor</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">output_string</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FileSample</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">output_string</span>


<span class="k">def</span> <span class="nf">ln_bayesian_evidence</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">_6sphere_prior</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bayesian evidence calculation for the output</span>

<span class="sd">    The priors are accessible as a pkg_resource, along with the sampling distribution</span>
<span class="sd">    (MTfit.algorithms.__base__), so new sampling priors can be added.</span>
<span class="sd">    If the sampling is from the prior distribution, the prior in thisfunction is</span>
<span class="sd">    just the uniform prior.</span>

<span class="sd">    Args</span>
<span class="sd">        output: dictionary from Sample.output.</span>
<span class="sd">        n_samples: total number of samples test_append.</span>
<span class="sd">        prior:[&#39;6sphere&#39;] the prior distribution to use (reflects the sampling).</span>

<span class="sd">    Returns</span>
<span class="sd">        float: returns the Bayesian evidence as a log value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get prior</span>
    <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># Multiple events</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">))],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;d&#39;</span> <span class="ow">and</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">))],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">*=</span> <span class="n">prior</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">gi</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Single event</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">prior</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">],</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">],</span> <span class="n">LnPDF</span><span class="p">):</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LnPDF</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">+</span><span class="n">output</span><span class="p">[</span><span class="s1">&#39;ln_pdf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_ln_pdf</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts the moment tensor to Tape parameters, Hudson u,v and strike dip rake pairs.</span>

<span class="sd">    Args</span>
<span class="sd">        moment_tensors: moment tensor matrix.</span>
<span class="sd">        i:[None] event index if using multiple events.</span>

<span class="sd">    Returns</span>
<span class="sd">        output dictionary containing converted parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output_convert</span><span class="p">(</span><span class="n">moment_tensors</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># Multiple events</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-run.html" class="btn btn-neutral float-right" title="3.1.5. MTfit.run" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source-probability.html" class="btn btn-neutral" title="3.1.3. MTfit.probability" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David Pugh.
      Last updated on Aug 30, 2018 (version 1.0.3a16).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.3a16',
            LANGUAGE:'English',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>