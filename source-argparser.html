

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="English" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="English" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>17.1.6.1.1. MTfit.utilities.argparser &mdash; MTfit documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="17.1.6.1.2. MTfit.utilities.extensions" href="source-utilities_extensions.html" />
    <link rel="prev" title="17.1.6. MTfit.utilities" href="source-utilities.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> MTfit
          

          
            
            <img src="_static/MTfitsphinx.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0.3a15
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="run.html">2. Running MTfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">3. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="real-tutorial.html">4. Tutorial: Real Data Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">5. Bayesian Approach</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">6. Probability Density Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">7. Search Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtconvert.html">8. Moment Tensor Conversion</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">9. Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplot.html">10. Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_classes.html">11. Plot Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtplotcli.html">12. MTplot Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="inversion.html">13. Inversion Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="extensions.html">14. Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">15. References</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">16. Glossary</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="source.html">17. Source Code</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="source.html#contents">17.1. Contents:</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="source-inversion.html">17.1.1. MTfit.inversion</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-algorithms.html">17.1.2. MTfit.algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-probability.html">17.1.3. MTfit.probability</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-sampling.html">17.1.4. MTfit.sampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-run.html">17.1.5. MTfit.run</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="source-utilities.html">17.1.6. MTfit.utilities</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="source-utilities.html#contents">17.1.6.1. Contents</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="source-extensions.html">17.1.7. MTfit.extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-convert.html">17.1.8. MTfit.convert</a></li>
<li class="toctree-l3"><a class="reference internal" href="source-plot.html">17.1.9. MTfit.plot</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/djpugh/MTfit">GitHub Repository</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MTfit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="source.html">17. MTfit Source Code</a> &raquo;</li>
        
          <li><a href="source-utilities.html">17.1.6. MTfit.utilities</a> &raquo;</li>
        
      <li>17.1.6.1.1. MTfit.utilities.argparser</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/source-argparser.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mtfit-utilities-argparser">
<h1>17.1.6.1.1. MTfit.utilities.argparser<a class="headerlink" href="#mtfit-utilities-argparser" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">argparser.py</span>
<span class="sd">*************</span>

<span class="sd">Command line argument parser code for MTfit</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># **Restricted:  For Non-Commercial Use Only**</span>
<span class="c1"># This code is protected intellectual property and is available solely for teaching</span>
<span class="c1"># and non-commercially funded academic research purposes.</span>
<span class="c1">#</span>
<span class="c1"># Applications for commercial use should be made to Schlumberger or the University of Cambridge.</span>

<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Check if argparse present</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">_ARGPARSE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_ARGPARSE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1"># Test flag for running qsub flags in test</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># python module for cluster job submission using qsub.</span>
    <span class="kn">import</span> <span class="nn">pyqsub</span>
    <span class="n">_PYQSUB</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">_PYQSUB</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">.extensions</span> <span class="k">import</span> <span class="n">get_extensions</span>
<span class="kn">from</span> <span class="nn">.extensions</span> <span class="k">import</span> <span class="n">evaluate_extensions</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">..extensions</span> <span class="k">import</span> <span class="n">default_cmd_opts</span>
<span class="kn">from</span> <span class="nn">..extensions</span> <span class="k">import</span> <span class="n">default_cmd_defaults</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">MTFIT_PARSER_DEFAULTS</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">MTFIT_PARSER_DEFAULT_TYPES</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">DEFAULT_HIST_COLORMAP</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">DEFAULT_AMP_COLORMAP</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">MTPLOT_PARSER_DEFAULTS</span>
<span class="kn">from</span> <span class="nn">.argparser_defaults</span> <span class="k">import</span> <span class="n">MTPLOT_PARSER_DEFAULT_TYPES</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;MTfit&#39;</span><span class="p">)</span>

<span class="c1"># qsub test flag</span>
<span class="n">_QSUBTEST</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">get_details_json</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">get_details_json</span> <span class="k">as</span> <span class="n">_get_details_json</span>
    <span class="k">return</span> <span class="n">_get_details_json</span><span class="p">()</span>


<span class="k">if</span> <span class="n">_ARGPARSE</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">ArgparseIndentedHelpFormatterWithNewLines</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        argparse help formatted with new lines</span>

<span class="sd">        Formats the argparse help with newlines.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_format_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Formats the action with newlines. Adapted from base function.&quot;&quot;&quot;</span>
            <span class="c1"># determine the required width and the entry label</span>
            <span class="n">help_position</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_max_length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_max_help_position</span><span class="p">)</span>
            <span class="n">help_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span> <span class="o">-</span> <span class="n">help_position</span>
            <span class="n">action_width</span> <span class="o">=</span> <span class="n">help_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">action_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_action_invocation</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># no help; start on same line and add a final newline</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">action</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
                <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">action_header</span>
                <span class="n">action_header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tup</span>

            <span class="c1"># short action name; start on the same line and pad two spaces</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">action_header</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">action_width</span><span class="p">:</span>
                <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">action_width</span><span class="p">,</span> <span class="n">action_header</span>
                <span class="n">action_header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%*s%-*s</span><span class="s1">  &#39;</span> <span class="o">%</span> <span class="n">tup</span>
                <span class="n">indent_first</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># long action name; start on the next line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">action_header</span>
                <span class="n">action_header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tup</span>
                <span class="n">indent_first</span> <span class="o">=</span> <span class="n">help_position</span>

            <span class="c1"># collect the pieces of the action help</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">action_header</span><span class="p">]</span>
            <span class="c1"># if there was help for the action, add lines of help text</span>
            <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
                <span class="n">help_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_help</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="n">help_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="n">help_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">help_width</span><span class="p">)):</span>
                        <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">help_width</span><span class="p">))</span>

                <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent_first</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">help_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">help_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">help_position</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

            <span class="c1"># or add a newline if the description doesn&#39;t end with one</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">action_header</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># if there are any sub-actions, add their help as well</span>
            <span class="k">for</span> <span class="n">subaction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_indented_subactions</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_action</span><span class="p">(</span><span class="n">subaction</span><span class="p">))</span>

            <span class="c1"># return a single string</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_parts</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_format_action_invocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ArgparseIndentedHelpFormatterWithNewLines</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_format_action_invocation</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="o">+</span><span class="mi">5</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">checked</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">-</span><span class="n">ind</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="o">+</span><span class="mi">5</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                        <span class="k">break</span>

                    <span class="n">checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;, -&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">+</span><span class="n">result</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_width</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;, -&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">checked</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">checked</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checked</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_indent</span><span class="p">:</span>
                    <span class="n">checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">checked</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">OptparseIndentedHelpFormatterWithNewLines</span><span class="p">(</span><span class="n">optparse</span><span class="o">.</span><span class="n">IndentedHelpFormatter</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    optparse help formatted with new lines</span>

<span class="sd">    Formats the optparse help with newlines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">format_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format the description with newlines. Adapted from base function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">desc_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span>
    <span class="c1"># the above is still the same</span>
        <span class="n">bits</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">formatted_bits</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">textwrap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">bit</span><span class="p">,</span>
                          <span class="n">desc_width</span><span class="p">,</span>
                          <span class="n">initial_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span>
                          <span class="n">subsequent_indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="n">bits</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_bits</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">format_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Format the option with newlines. Adapted from base function.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
        <span class="n">opt_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">opt_width</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
            <span class="n">indent_first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_position</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># start help on same line as opts</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%*s%-*s</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_indent</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">opt_width</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
            <span class="n">indent_first</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">help</span><span class="p">:</span>
            <span class="n">help_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_default</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
        <span class="c1"># Everything is the same up through here</span>
            <span class="n">help_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="n">help_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_width</span><span class="p">)):</span>
                    <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">help_width</span><span class="p">))</span>
            <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">help_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="c1"># Everything is the same after here</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">indent_first</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%*s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">help_position</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">help_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">elif</span> <span class="n">opts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_MTfit_defaults</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_defaults</span><span class="o">=</span><span class="p">{},</span> <span class="n">extension_default_types</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">return</span> <span class="n">_get_env_defaults</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">extension_defaults</span><span class="p">,</span> <span class="n">extension_default_types</span><span class="p">,</span> <span class="s2">&quot;MTfit&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_MTplot_defaults</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_defaults</span><span class="o">=</span><span class="p">{},</span> <span class="n">extension_default_types</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">return</span> <span class="n">_get_env_defaults</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">extension_defaults</span><span class="p">,</span> <span class="n">extension_default_types</span><span class="p">,</span> <span class="s2">&quot;MTplot&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_env_defaults</span><span class="p">(</span><span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extension_defaults</span><span class="o">=</span><span class="p">{},</span> <span class="n">extension_default_types</span><span class="o">=</span><span class="p">{},</span> <span class="n">app</span><span class="o">=</span><span class="s2">&quot;MTfit&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets environment defaults either from file or otherwise. Looks in the following locations in this order, with</span>
<span class="sd">    later files overriding the defaults:</span>
<span class="sd">        1. ~/MTfitdefaults (MTplotdefaults for MTplot)</span>
<span class="sd">        2. At the location specified by the MTFITDEFAULTSPATH (or MTPLOTDEFAULTSPATH)</span>
<span class="sd">        3. for a defaults file in the current working directory</span>

<span class="sd">    Default Format is simple on each line key:attr.</span>
<span class="sd">    Keys are given in the MTfit.utilities.argparser_defaults module</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MTfit_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;mtplot&quot;</span><span class="p">:</span>
        <span class="n">defaults_fname</span> <span class="o">=</span> <span class="s2">&quot;.MTplotdefaults&quot;</span>
        <span class="n">env_variable</span> <span class="o">=</span> <span class="s2">&quot;MTPLOTDEFAULTSPATH&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">defaults_fname</span> <span class="o">=</span> <span class="s2">&quot;.MTfitdefaults&quot;</span>
        <span class="n">env_variable</span> <span class="o">=</span> <span class="s2">&quot;MTFITDEFAULTSPATH&quot;</span>
        <span class="n">MTfit_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">default_files</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>
        <span class="n">home_defaults</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOMEPATH&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">defaults_fname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">home_defaults</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">defaults_fname</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">home_defaults</span><span class="p">):</span>
        <span class="n">default_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">home_defaults</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">env_variable</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">default_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">env_variable</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">defaults_fname</span><span class="p">):</span>
        <span class="n">default_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">defaults_fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MTfit_flag</span><span class="p">:</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">MTFIT_PARSER_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">default_types</span> <span class="o">=</span> <span class="n">MTFIT_PARSER_DEFAULT_TYPES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">MTPLOT_PARSER_DEFAULTS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">default_types</span> <span class="o">=</span> <span class="n">MTPLOT_PARSER_DEFAULT_TYPES</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extension_defaults</span><span class="p">)</span>
    <span class="n">default_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extension_default_types</span><span class="p">)</span>

    <span class="n">output_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">defaults</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">default_files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;--------------</span><span class="se">\n</span><span class="s1">Using default file: </span><span class="si">{}</span><span class="s1"> for default parameters</span><span class="se">\n</span><span class="s1">----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;--------------</span><span class="se">\n</span><span class="s1">Updating default parameters using default file: </span><span class="si">{}</span><span class="se">\n</span><span class="s1">----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Error parsing defaults line </span><span class="si">{}</span><span class="s1"> - value ignored</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default_types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">default_types</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">attr</span> <span class="o">=</span> <span class="n">tp</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Error parsing attribute type for </span><span class="si">{}</span><span class="s1">, expecting</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_types</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="n">defaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Error parsing defaults key </span><span class="si">{}</span><span class="s1"> not in default keys</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">MTfit_flag</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">MTFIT_PARSER_DEFAULTS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">MTPLOT_PARSER_DEFAULTS</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extension_defaults</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">))</span>
            <span class="n">output_string</span> <span class="o">+=</span> <span class="s1">&#39;Errors in parsing defaults. Expecting file of the form </span><span class="se">\n\n</span><span class="s1">key:attr</span><span class="se">\n</span><span class="s1">key:attr</span><span class="se">\n\n</span><span class="s1">Valid keys are:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">)))</span>
    <span class="n">log</span><span class="p">(</span><span class="n">output_string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">defaults</span>


<span class="c1">#</span>
<span class="c1"># Command line parser helper code and main functions</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MPI print function&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s1">&#39;OMPI_COMM_WORLD_RANK&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMPI_COMM_WORLD_RANK&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lower_string</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert string to lower TestCase</span>

<span class="sd">    argparse type function</span>

<span class="sd">    Args</span>
<span class="sd">        input_string: Input string to converts</span>

<span class="sd">    Returns:</span>
<span class="sd">        lower case of input string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">input_string</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">check_path</span><span class="p">(</span><span class="n">input_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the input string is a path, if * wildcard  present, checks the path using glob.glob.</span>

<span class="sd">    Args</span>
<span class="sd">        input_string: Input string to check if a path, can contain * as a wildcard. Can submit a comma separated list.</span>

<span class="sd">    Returns</span>
<span class="sd">        abspath for input_string. If the input_string is a comma delimited list, returns a list for all the paths, and if it contains a * wildcard,</span>
<span class="sd">            returns the list from glob.glob.</span>

<span class="sd">    Raises</span>
<span class="sd">        argparse.ArgumentTypeError if path doesn&#39;t exist and argparse is installed</span>
<span class="sd">        ValueError if path doesn&#39;t exist and argparse is not installed</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">input_string</span>
    <span class="k">elif</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">input_string</span><span class="p">:</span>
        <span class="c1"># list</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">input_string</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">files</span>
    <span class="k">elif</span> <span class="n">input_string</span> <span class="ow">and</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">input_string</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">input_string</span><span class="p">)[</span><span class="mi">0</span><span class="p">])):</span>
        <span class="c1"># Check abspath when making file list</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">input_string</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">input_string</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">elif</span> <span class="n">input_string</span> <span class="ow">and</span> <span class="s1">&#39;*&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_string</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_string</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_ARGPARSE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentTypeError</span><span class="p">(</span><span class="s1">&#39;Path: &quot;&#39;</span><span class="o">+</span><span class="n">input_string</span><span class="o">+</span><span class="s1">&#39;&quot; does not exist&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Path: &quot;&#39;</span><span class="o">+</span><span class="n">input_string</span><span class="o">+</span><span class="s1">&#39;&quot; does not exist&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_data_file_search</span><span class="p">(</span><span class="n">data_path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">data_extension</span><span class="o">=</span><span class="s1">&#39;inv&#39;</span><span class="p">,</span> <span class="n">angle_extension</span><span class="o">=</span><span class="s1">&#39;scatangle&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searches for data and angle scatter file pairs</span>

<span class="sd">    Searches on the given data path for data files paired to angle scatter files (same file name for initial characters). Searches for data files using gloc:</span>
<span class="sd">    data_path+*.+data_extension, so data_path must have a path separator (ie slash) if a folder.</span>

<span class="sd">    Args</span>
<span class="sd">        data_path:[&#39;./&#39;] Data path to search over.</span>
<span class="sd">        data_extension:[&#39;inv&#39;] Extension for data files.</span>
<span class="sd">        angle_extension:[&#39;scatangle&#39;] Extension for angle scatter files.</span>
<span class="sd">    Returns</span>
<span class="sd">        data_files,scatter_files:A list of data_files and a list of angle scatter files if there are any otherwise scatter_files is set to False.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="s1">&#39;*.&#39;</span><span class="o">+</span><span class="n">data_extension</span><span class="p">)</span>
    <span class="n">scatter_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scatout</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_files</span><span class="p">):</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">_search</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">angle_extension</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scatter</span><span class="p">:</span>
            <span class="n">scatter_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
            <span class="n">scatout</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scatter_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scatout</span><span class="p">:</span>
        <span class="n">scatter_files</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data_files</span><span class="p">,</span> <span class="n">scatter_files</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scatter_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">data_path</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s2">&quot;*.&quot;</span><span class="o">+</span><span class="n">angle_extension</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_files</span><span class="p">,</span> <span class="n">scatter_files</span>


<span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;scatangle&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">it</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">imax</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic search for a matching file with a given basename and extension</span>

<span class="sd">    Searches using glob for a matching file with the extension given, where the match is over some length, so that there is at most 5 matching characters.</span>

<span class="sd">    Args</span>
<span class="sd">        file_name:base file name to search for.</span>
<span class="sd">        extension:[&#39;scatangle&#39;] file extension to match to.</span>
<span class="sd">        n:[12] default inital length to match to.</span>
<span class="sd">        it:[1] iteration number (do not adjust from 1).</span>
<span class="sd">        imax:[7] maximum number of iterations to try.</span>

<span class="sd">    Returns</span>
<span class="sd">        matched file name if at least one exists, otherwise False.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scatter</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
        <span class="n">file_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="n">n</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;*.&quot;</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="n">imax</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scatter</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_search</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_search</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">imax</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scatter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># MTfit</span>


<span class="k">def</span> <span class="nf">_MTfit_argparser</span><span class="p">(</span><span class="n">input_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return arguments parsed from command line</span>

<span class="sd">    Creates a command line argument parser (using argparse if present otherwise optparse (python &lt;=2.6))</span>
<span class="sd">    and parses the command line arguments (or input_args if provided as a list). Contains some help formatter classes.</span>

<span class="sd">    Args</span>
<span class="sd">        input_args:[None] If provided, these are parsed instead of the command line arguments</span>

<span class="sd">    Returns</span>
<span class="sd">        parser,options,options_map: Parser object, the parsed options and the mapping from the parser options to the command line flags</span>

<span class="sd">    Raises</span>
<span class="sd">        Exception: If there is an error parsing the arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;MTfit - Moment Tensor Inversion Code by David J Pugh</span>

<span class="s2">    MTfit is a forward modelling based probabilistic evaluator of the source PDF.</span>
<span class="s2">    The inversion can be constrained to double-couple solutions only, or allowed to use the full moment tensor range.</span>

<span class="s2">    The approach evaluates the probability for a possible source given the observed data consisting of Polarity and/or Amplitude Ratio Information.</span>

<span class="s2">    Location uncertainty and model uncertainty can be included in the inversion as these correspond to uncertainties in the station ray path angles. These are included with a suitable ray path angle PDF.</span>



<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># optparse parser description extra</span>
    <span class="n">optparse_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Arguments are set as below, syntax is -dTest.i or --datafile=Test.i</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># argparse parser description extra</span>
    <span class="n">argparse_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Arguments are set as below, syntax is -dTest.i or -d Test.i</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># Help for the angle scatter option</span>
    <span class="n">location_pdf_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Path to location scatter angle files - wild cards behave as normal.</span>
<span class="s2">    To include the model and location uncertainty, a ray path angle pdf file must be provided.</span>
<span class="s2">    This is of the form:</span>
<span class="s2">    probability1</span>
<span class="s2">    Station1    Azimuth1    TakeOffAngle1</span>
<span class="s2">    Station2    Azimuth2    TakeOffAngle2</span>
<span class="s2">    .</span>
<span class="s2">    .</span>
<span class="s2">    .</span>
<span class="s2">    StationN    AzimuthN    TakeOffAngleN</span>

<span class="s2">    probability2</span>
<span class="s2">    Station1    Azimuth1    TakeOffAngle1</span>
<span class="s2">    Station2    Azimuth2    TakeOffAngle2</span>
<span class="s2">    .</span>
<span class="s2">    .</span>
<span class="s2">    .</span>
<span class="s2">    StationN    AzimuthN    TakeOffAngleN</span>

<span class="s2">    e.g.:</span>
<span class="s2">    504.7</span>
<span class="s2">    S0529   326.1   131.7</span>
<span class="s2">    S0083   223.7   118.2</span>
<span class="s2">    S0595   42.6    117.8</span>
<span class="s2">    S0236   253.6   118.6</span>
<span class="s2">    &amp;&amp;</span>
<span class="s2">    504.7</span>
<span class="s2">    S0529   326.1   131.8</span>
<span class="s2">    S0083   223.7   118.2</span>
<span class="s2">    S0595   42.7    117.9</span>
<span class="s2">    S0236   253.5   118.7&quot;&quot;&quot;</span>
    <span class="c1"># Help for the data file structure</span>
    <span class="n">data_file_arg_help</span> <span class="o">=</span> <span class="s2">&quot;Data file to use for the inversion, optional but must be specified either&quot;</span>
    <span class="n">data_file_arg_help</span> <span class="o">+=</span> <span class="s2">&quot; as a positional argument or as an optional argument (see -d below) If not&quot;</span>
    <span class="n">data_file_arg_help</span> <span class="o">+=</span> <span class="s2">&quot; specified defaults to all *.inv files in current directory, and searches&quot;</span>
    <span class="n">data_file_arg_help</span> <span class="o">+=</span> <span class="s2">&quot; for all anglescatterfiles in the directory too. Inversion file extension &quot;</span>
    <span class="n">data_file_arg_help</span> <span class="o">+=</span> <span class="s2">&quot;can be set using --invext option. Angle scatter file extension can be set &quot;</span>
    <span class="n">data_file_arg_help</span> <span class="o">+=</span> <span class="s2">&quot;using --angleext option&quot;</span>
    <span class="n">data_file_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Data file to use for the inversion. Can be provided as a positional argument.</span>
<span class="s2">    There are several different data file types:</span>

<span class="s2">        * pickled dictionary</span>
<span class="s2">        * csv file</span>
<span class="s2">        * NLLOC hyp file</span>

<span class="s2">    The data file is a pickled python dictionary of the form:</span>
<span class="s2">      {&#39;DataType&#39;:{&#39;Stations&#39;:{&#39;Name&#39;:[&#39;STA1&#39;,&#39;STA2&#39;,...],</span>
<span class="s2">        &#39;Azimuth&#39;:np.matrix([[190],[40],...]),</span>
<span class="s2">        &#39;TakeOffAngle&#39;:np.matrix([[70],[40],...])},</span>
<span class="s2">        &#39;Measured&#39;:np.matrix([[1],[-1],...]),</span>
<span class="s2">        &#39;Error&#39;:np.matrix([[0.01],[0.02],...])}}</span>

<span class="s2">    e.g.:</span>
<span class="s2">      {&#39;P/SHRMSAmplitudeRatio&#39;:{&#39;Stations&#39;:{&#39;Name&#39;:[&#39;S0649&#39;,&quot;S0162&quot;],</span>
<span class="s2">        &#39;Azimuth&#39;:np.array([90.0,270.0]),</span>
<span class="s2">        &#39;TakeOffAngle&#39;:np.array([30.0,60.0])},</span>
<span class="s2">        &#39;Measured&#39;:np.matrix([[1],[-1]]),</span>
<span class="s2">        &#39;Error&#39;:np.matrix([[ 0.001,0.02],[ 0.001,0.001]])}}</span>

<span class="s2">    Or a CSV file with events split by blank lines, a header line showing which row corresponds to which information (default is as shown here),</span>
<span class="s2">    UID and data-type information stored in the first column,</span>
<span class="s2">    e.g.:</span>
<span class="s2">            UID=123,,,,</span>
<span class="s2">            PPolarity,,,,</span>
<span class="s2">            Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="s2">            S001,120,70,1,0.01</span>
<span class="s2">            S002,160,60,-1,0.02</span>
<span class="s2">            P/SHRMSAmplitudeRatio,,,,</span>
<span class="s2">            Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="s2">            S003,110,10,1,0.05 0.04</span>
<span class="s2">            ,,,,</span>
<span class="s2">            PPolarity ,,,,</span>
<span class="s2">            Name,Azimuth,TakeOffAngle,Measured,Error</span>
<span class="s2">            S003,110,10,1,0.05</span>

<span class="s2">    Is a CSV file with 2 events, one event UID of 123, and PPolarity data at S001 and S002 and P/SHRMSAmplitude data at S003,</span>
<span class="s2">    and a second event with no UID (will default to the event number, in this case 2) with PPolarity data at S003.</span>

<span class="s2">    This data format can be constructed manually or automatically.&quot;&quot;&quot;</span>
    <span class="c1"># Help for the algorithm option</span>
    <span class="n">algorithm_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Selects the algorithm used for the search. [default=time]</span>
<span class="s2">    Possible algorithms are:</span>
<span class="s2">        iterate (random sampling of the source space for a set number of samples)</span>
<span class="s2">        time (random sampling of the source space for a set time)</span>
<span class="s2">        mcmc (Markov chain Monte Carlo sampling) &quot;&quot;&quot;</span>
    <span class="c1"># Help for the inversion options</span>
    <span class="n">inversion_options_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Set the inversion data types to use: comma delimited.</span>
<span class="s2">    If not set, the inversion uses all the data types in the data file.</span>
<span class="s2">    e.g.</span>
<span class="s2">    PPolarity,P/SHRMSAmplitudeRatio</span>

<span class="s2">    Needs to correspond to the data types in the data file.</span>

<span class="s2">    If not specified can lead to independence errors: e.g.</span>
<span class="s2">    P/SH Amplitude Ratio and P/SV Amplitude Ratio can give SH/SV Amplitude Ratio.</span>
<span class="s2">    Therefore using SH/SV Amplitude Ratio in the inversion is reusing data and will artificially sharpen the PDF.</span>
<span class="s2">    This applies to all forms of dependent measurements.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">warnings_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Sets the warning visibility.</span>

<span class="s2">    options are:</span>

<span class="s2">        * &quot;e&quot;,&quot;error&quot; - turn matching warnings into exceptions</span>
<span class="s2">        * &quot;i&quot;,&quot;ignore&quot; - never print matching warnings</span>
<span class="s2">        * &quot;a&quot;,&quot;always&quot; - always print matching warnings</span>
<span class="s2">        * &quot;d&quot;,&quot;default&quot; - print the first occurrence of matching warnings for each location where the warning is issued</span>
<span class="s2">        * &quot;m&quot;,&quot;module&quot; - print the first occurrence of matching warnings for each module where the warning is issued</span>
<span class="s2">        * &quot;o&quot;,&quot;once&quot; - print only the first occurrence of matching warnings, regardless of location</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># Set up qsub defaults</span>
    <span class="n">options_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">algorithm_options</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;iterate&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;mcmc&quot;</span><span class="p">,</span> <span class="s2">&quot;transdmcmc&quot;</span><span class="p">]</span>
    <span class="n">output_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;matlab&#39;</span><span class="p">,</span> <span class="s1">&#39;pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;hyp&#39;</span><span class="p">]</span>
    <span class="n">output_formats</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.output_formats&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">output_formats</span><span class="p">)</span>
    <span class="n">output_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">output_options</span><span class="p">))</span>
    <span class="n">output_data_options</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full_pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;hyp&#39;</span><span class="p">]</span>
    <span class="n">output_data_formats</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.output_data_formats&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_data_options</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">output_data_formats</span><span class="p">)</span>
    <span class="n">output_data_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">output_data_options</span><span class="p">))</span>
    <span class="c1"># Get extension defaults</span>
    <span class="n">cmd_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cmd_default_types</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.cmd_defaults&#39;</span><span class="p">,</span> <span class="n">default_cmd_defaults</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">cmd_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cmd_default_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Try loading MTfitdefaults from env var or ~/.MTfitdefaults</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">get_MTfit_defaults</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">cmd_defaults</span><span class="p">,</span> <span class="n">cmd_default_types</span><span class="p">)</span>
    <span class="c1"># Get extension options</span>
    <span class="n">cmd_opt_names</span><span class="p">,</span> <span class="n">cmd_opts</span> <span class="o">=</span> <span class="n">get_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.cmd_opts&#39;</span><span class="p">,</span> <span class="n">default_cmd_opts</span><span class="p">)</span>
    <span class="n">extension_parser_checks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--datafile&quot;</span><span class="p">,</span> <span class="s2">&quot;--data_file&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">data_file_help</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="n">check_path</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="s2">&quot;--anglescatterfilepath&quot;</span><span class="p">,</span> <span class="s2">&quot;--location_pdf_file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;--location_file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;--scatterfilepath&quot;</span><span class="p">,</span> <span class="s2">&quot;--scatter_file_path&quot;</span><span class="p">],</span>
             <span class="nb">type</span><span class="o">=</span><span class="n">check_path</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;location_pdf_file_path&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">location_pdf_help</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;location_pdf_file_path&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="s2">&quot;--algorithm&quot;</span><span class="p">],</span> <span class="n">choices</span><span class="o">=</span><span class="n">algorithm_options</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">lower_string</span><span class="p">,</span>
             <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;algorithm&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">algorithm_help</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--singlethread&quot;</span><span class="p">,</span> <span class="s2">&quot;--single&quot;</span><span class="p">,</span> <span class="s2">&quot;--single_thread&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
             <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;single_threaded&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Flag to disable parallel computation&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;singlethread&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--numberworkers&quot;</span><span class="p">,</span> <span class="s2">&quot;--number_workers&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;number_workers&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the number of workers used in the parallel computation. [default=all available cpus]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;--mem&quot;</span><span class="p">,</span> <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="s2">&quot;--physical_memory&quot;</span><span class="p">,</span> <span class="s2">&quot;--physicalmemory&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum memory used in Gb if psutil not available [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;Gb]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mem&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--doublecouple&quot;</span><span class="p">,</span> <span class="s2">&quot;--double-couple&quot;</span><span class="p">,</span> <span class="s2">&quot;--double_couple&quot;</span><span class="p">,</span> <span class="s2">&quot;--dc&quot;</span><span class="p">,</span> <span class="s2">&quot;--DC&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
             <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;double-couple&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot; Flag to constrain the inversion to double-couple sources only&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dc&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--compareconstrained&quot;</span><span class="p">,</span> <span class="s2">&quot;--compare_constrained&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;compare_constrained&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot; Flag to run two inversions, one constrained to double-couple and one unconstrained&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dc_mt&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--nstations&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;number_stations&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum number of stations without having to load an angle pdf file - used for calculating sample sizes and memory sizes, and can speed up the calculation a bit, but has no effect on result.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;number_stations&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--nanglesamples&quot;</span><span class="p">,</span> <span class="s2">&quot;--nlocationsamples&quot;</span><span class="p">,</span> <span class="s2">&quot;--number_location_samples&quot;</span><span class="p">,</span> <span class="s2">&quot;--number-location-samples&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;number_location_samples&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum number of angle pdf samples to use. If this is less than the total number of samples, a subset are randomly selected [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;number_location_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;].&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;number_location_samples&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--file_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;--file-sample&quot;</span><span class="p">,</span> <span class="s2">&quot;--filesample&quot;</span><span class="p">,</span> <span class="s2">&quot;--disk_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;--disk-sample&quot;</span><span class="p">,</span> <span class="s2">&quot;--disksample&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;disk_sample&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save sampling to disk (allows for easier recovery and reduces memory requirements, but can be slower)&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;file_sample&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--not_file_safe&quot;</span><span class="p">,</span> <span class="s2">&quot;--not-file-safe&quot;</span><span class="p">,</span> <span class="s2">&quot;--notfilesafe&quot;</span><span class="p">,</span> <span class="s2">&quot;--no_file_safe&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-file-safe&quot;</span><span class="p">,</span> <span class="s2">&quot;--nofilesafe&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;no_file_safe&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable file safe saving (i.e. copy and write to .mat~ then copy back&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;no_file_safe&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--inversionoptions&quot;</span><span class="p">,</span> <span class="s2">&quot;--inversion_options&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;inversion_options&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">inversion_options_help</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;inversion_options&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="s2">&quot;--out&quot;</span><span class="p">,</span> <span class="s2">&quot;--fid&quot;</span><span class="p">,</span> <span class="s2">&quot;--outputfile&quot;</span><span class="p">,</span> <span class="s2">&quot;--outfile&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;output_file&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set output file basename [default=MTfitOutput]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;fid&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-x&quot;</span><span class="p">,</span> <span class="s2">&quot;--samples&quot;</span><span class="p">,</span> <span class="s2">&quot;--maxsamples&quot;</span><span class="p">,</span> <span class="s2">&quot;--max_samples&quot;</span><span class="p">,</span> <span class="s2">&quot;--chain_length&quot;</span><span class="p">,</span> <span class="s2">&quot;--max-samples&quot;</span><span class="p">,</span> <span class="s2">&quot;--chain-length&quot;</span><span class="p">,</span> <span class="s2">&quot;--chainlength&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Iteration algorithm: Set maximum number of samples to use [default=&quot;</span> <span class="o">+</span>
             <span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;max_iteration_samples&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]. McMC algorithms: Set chain length [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mcmc_chain_length&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;], trans-d McMC [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;transdmcmc_chain_length&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;max_samples&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--time&quot;</span><span class="p">,</span> <span class="s2">&quot;--maxtime&quot;</span><span class="p">,</span> <span class="s2">&quot;--max_time&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time algorithm: Set maximum time to use [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;max_time&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-e&#39;</span><span class="p">,</span> <span class="s1">&#39;--multiple_events&#39;</span><span class="p">,</span> <span class="s1">&#39;--multiple-events&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run using events using joint PDF approach&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--relative_amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;--relative-amplitude&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run using events using joint PDF approach&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;--marginalise_relative&#39;</span><span class="p">,</span> <span class="s1">&#39;--marginalise&#39;</span><span class="p">,</span> <span class="s1">&#39;--marginalise-relative&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;marginalise_relative&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Flag to marginalise location uncertainty in relative amplitude case [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;marginalise_relative&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;marginalise_relative&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-R&quot;</span><span class="p">,</span> <span class="s2">&quot;--recover&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;recover&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Recover crashed run (ie restart from last event not written out)]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;recover&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--invext&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataextension&quot;</span><span class="p">,</span> <span class="s2">&quot;--dataext&quot;</span><span class="p">,</span> <span class="s2">&quot;--data-extension&quot;</span><span class="p">,</span> <span class="s2">&quot;--data_extension&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;data_extension&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set data file extension to search for when inverting on a folder&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;data_extension&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--angleext&quot;</span><span class="p">,</span> <span class="s2">&quot;--locationextension&quot;</span><span class="p">,</span> <span class="s2">&quot;--locationext&quot;</span><span class="p">,</span> <span class="s2">&quot;--location-extension&quot;</span><span class="p">,</span> <span class="s2">&quot;--location_extension&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;location_extension&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set location sample file extension to search for when inverting on a folder&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;angle_extension&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-S&quot;</span><span class="p">,</span> <span class="s2">&quot;--minimum_number_intersections&quot;</span><span class="p">,</span> <span class="s2">&quot;--min_number_intersections&quot;</span><span class="p">,</span> <span class="s2">&quot;--minimum-number-intersections&quot;</span><span class="p">,</span> <span class="s2">&quot;--min-number-intersections&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;min_number_intersections&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For relative amplitude inversion, the minimum number of intersecting stations required (must be greater than 1) [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;min_number_intersections&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;minimum_number_intersections&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-M&#39;</span><span class="p">,</span> <span class="s1">&#39;--mpi&#39;</span><span class="p">,</span> <span class="s1">&#39;--MPI&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run using mpi - will reinitialise using mpirun (mpi etc needs to be added to path)&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mpi&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-B&#39;</span><span class="p">,</span> <span class="s1">&#39;--benchmark&#39;</span><span class="p">,</span> <span class="s1">&#39;--benchmarking&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;benchmark&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run benchmark tests for the event&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;benchmark&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;--min_number_check_samples&#39;</span><span class="p">,</span> <span class="s1">&#39;--min_number_initialisation_samples&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum number of samples for McMC initialiser, or the minimum number of samples required when using quality check (-Q)&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-T&quot;</span><span class="p">,</span> <span class="s2">&quot;--test&quot;</span><span class="p">,</span> <span class="s2">&quot;--test&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run MTfit Test suite (if combined with -q runs test suite on cluster&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-Q&quot;</span><span class="p">,</span> <span class="s2">&quot;--quality&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;quality&#39;</span><span class="p">],</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run MTfit with quality checks enabled [default=False]. Checks if an event has a percentage of non-zero samples lower than the flag - values from 0-100.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;quality_check&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-D&quot;</span><span class="p">,</span> <span class="s2">&quot;--debug&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run MTfit with debugging enabled.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-V&quot;</span><span class="p">,</span> <span class="s2">&quot;--verbosity&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;verbosity&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set verbosity level for non-fatal errors [default=0].&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;verbosity&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-g&quot;</span><span class="p">,</span> <span class="s2">&quot;--diagnostics&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;diagnostics&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run MTfit with diagnostic output. Outputs the full chain and sampling - wil make a large file.&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;diagnostic_output&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-j&quot;</span><span class="p">,</span> <span class="s2">&quot;--jumpProbability&quot;</span><span class="p">,</span> <span class="s2">&quot;--jumpProb&quot;</span><span class="p">,</span> <span class="s2">&quot;--jumpprob&quot;</span><span class="p">,</span> <span class="s2">&quot;--jumpProb&quot;</span><span class="p">,</span> <span class="s2">&quot;--dimensionJumpProb&quot;</span><span class="p">,</span> <span class="s2">&quot;--dimensionjumpprob&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;jump_probability&#39;</span><span class="p">],</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the probability of making a dimension jump in the Trans-Dimensional McMC algorithm [default=0.01]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;dimension_jump_prob&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-y&quot;</span><span class="p">,</span> <span class="s2">&quot;--initialSampling&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;initial_sampling&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the initialisation sampling method for McMC algorithms choices:</span><span class="se">\n</span><span class="s2">grid - use grid based sampling to find non-zero initial sample [default=grid]&quot;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;initial_sample&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-u&quot;</span><span class="p">,</span> <span class="s2">&quot;--minAcceptanceRate&quot;</span><span class="p">,</span> <span class="s2">&quot;--minacceptancerate&quot;</span><span class="p">,</span> <span class="s2">&quot;--min_acceptance_rate&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the minimum acceptance rate for the McMC algorithm [mcmc default=&quot;</span> <span class="o">+</span>
             <span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mcmc_min_acceptance_rate&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;, transdmcmc default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;transdmcmc_min_acceptance_rate&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;min_acceptance_rate&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-v&quot;</span><span class="p">,</span> <span class="s2">&quot;--maxAcceptanceRate&quot;</span><span class="p">,</span> <span class="s2">&quot;--maxacceptancerate&quot;</span><span class="p">,</span> <span class="s2">&quot;--max_acceptance_rate&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the maximum acceptance rate for the McMC algorithm [mcmc default=&quot;</span> <span class="o">+</span>
             <span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mcmc_max_acceptance_rate&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;, transdmcmc default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;transdmcmc_max_acceptance_rate&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;max_acceptance_rate&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-w&quot;</span><span class="p">,</span> <span class="s2">&quot;--acceptanceLearningWindow&quot;</span><span class="p">,</span> <span class="s2">&quot;--acceptancelearningwindow&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;acceptance_rate_window&#39;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the window for calculating and updating the acceptance rate for McMC algorithms [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;acceptance_rate_window&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;acceptance_rate_window&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-W&quot;</span><span class="p">,</span> <span class="s2">&quot;--warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;--Warnings&quot;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
             <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="n">warnings_help</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;warnings&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-z&quot;</span><span class="p">,</span> <span class="s2">&quot;--learningLength&quot;</span><span class="p">,</span> <span class="s2">&quot;--learninglength&quot;</span><span class="p">,</span> <span class="s2">&quot;--learning_length&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;learning_length&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sets the number of samples to discard as the learning period [default=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;learning_length&#39;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;learning_length&quot;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--version&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
             <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> &quot;</span><span class="o">+</span><span class="n">__version__</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--detail&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
             <span class="n">version</span><span class="o">=</span><span class="n">get_details_json</span><span class="p">()),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--mpi_call&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;DO NOT USE - only for spawning mpi subprocess&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--output-format&quot;</span><span class="p">,</span> <span class="s2">&quot;--output_format&quot;</span><span class="p">,</span> <span class="s2">&quot;--outputformat&quot;</span><span class="p">,</span> <span class="s2">&quot;--format&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;output_format&#39;</span><span class="p">],</span>
             <span class="n">choices</span><span class="o">=</span><span class="n">output_options</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">lower_string</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output file format [default=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;output_format&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;output_format&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--results-format&quot;</span><span class="p">,</span> <span class="s2">&quot;--results_format&quot;</span><span class="p">,</span> <span class="s2">&quot;--resultsformat&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;results_format&#39;</span><span class="p">],</span> <span class="n">choices</span><span class="o">=</span><span class="n">output_data_options</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Output results data format (extensible) [default=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;results_format&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;results_format&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--no-dist&quot;</span><span class="p">,</span> <span class="s2">&quot;--no_dist&quot;</span><span class="p">,</span> <span class="s2">&quot;--nodist&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;no_dist&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not output station distribution if running location samples&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;no_station_distribution&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--dc-prior&quot;</span><span class="p">,</span> <span class="s2">&quot;--dc_prior&quot;</span><span class="p">,</span> <span class="s2">&quot;--dcprior&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;dc_prior&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Prior probability for the double-couple model when using the Trans-Dimensional McMC algorithm&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;dc_prior&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--sampling&quot;</span><span class="p">,</span> <span class="s2">&quot;--sampling&quot;</span><span class="p">,</span> <span class="s2">&quot;--sampling&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;sampling&#39;</span><span class="p">],</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Random moment tensor sampling distribution&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sampling&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--sample-models&quot;</span><span class="p">,</span> <span class="s2">&quot;--sample_distribution&quot;</span><span class="p">,</span> <span class="s2">&quot;--samplemodels&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">],</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Alternate models for random sampling (Monte Carlo algorithms only)&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--sampling-prior&quot;</span><span class="p">,</span> <span class="s2">&quot;--sampling_prior&quot;</span><span class="p">,</span> <span class="s2">&quot;--samplingprior&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Prior probability for the model distribution when using the McMC algorithm, alternatively the prior distribution for the source type parameters gamma and delta for use by the Bayesian evidence calculation for the MC algorithms&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--no-normalise&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-norm&quot;</span><span class="p">,</span> <span class="s2">&quot;--no_normalise&quot;</span><span class="p">,</span> <span class="s2">&quot;--no_norm&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
             <span class="s1">&#39;no_normalise&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Do not normalise the output pdf&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;no_normalise&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--convert&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;convert&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Convert the output MTs to Tape parameters, hudson parameters and strike dip rakes.&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;convert&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--discard&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;discard&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Fraction of maxProbability * total samples to discard as negligeable.&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;discard&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--mpioutput&quot;</span><span class="p">,</span> <span class="s2">&quot;--mpi_output&quot;</span><span class="p">,</span> <span class="s2">&quot;--mpi-output&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;mpi_output&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;When the mpi flag -M is used outputs each processor individually rather than combining&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mpi_output&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--combine_mpi_output&quot;</span><span class="p">,</span> <span class="s2">&quot;--combine-mpi-output&quot;</span><span class="p">,</span> <span class="s2">&quot;--combinempioutput&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;combine_mpi_output&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Combine the mpi output from the mpioutput flag. The data path corresponds to the root path for the mpi output&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;combine_mpi_output&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--c_generate&quot;</span><span class="p">,</span> <span class="s2">&quot;--c-generate&quot;</span><span class="p">,</span> <span class="s2">&quot;--generate&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;c_generate&#39;</span><span class="p">],</span>
             <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Generate moment tensor samples in the probability evaluation&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;c_generate&#39;</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--relative_loop&quot;</span><span class="p">,</span> <span class="s2">&quot;--relative-loop&quot;</span><span class="p">,</span> <span class="s2">&quot;--relativeloop&quot;</span><span class="p">,</span> <span class="s2">&quot;--loop&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;relative_loop&#39;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Loop over independent non-zero samples randomly to construct joint rather than joint samples&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;relative_loop&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">_ARGPARSE</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;MTfit&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="o">+</span><span class="n">argparse_description</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">ArgparseIndentedHelpFormatterWithNewLines</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;data_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">check_path</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">data_file_arg_help</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;flags&#39;</span><span class="p">}</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cmd_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Commands for the extension &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">extension_parser_check</span><span class="p">)</span> <span class="o">=</span> <span class="n">extension</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">_ARGPARSE</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
            <span class="n">extension_parser_checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extension_parser_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_PYQSUB</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Commands for using MTfit on a cluster environment using qsub/PBS&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">pyqsub</span><span class="o">.</span><span class="n">parser_group</span><span class="p">(</span><span class="n">module_name</span><span class="o">=</span><span class="s1">&#39;MTfit&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">default_nodes</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">],</span> <span class="n">default_ppn</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;ppn&#39;</span><span class="p">],</span> <span class="n">default_pmem</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;pmem&#39;</span><span class="p">],</span>
                                        <span class="n">default_walltime</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">],</span> <span class="n">default_queue</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;queue&#39;</span><span class="p">],</span> <span class="n">default_email_options</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;email_options&#39;</span><span class="p">],</span>
                                        <span class="n">default_email</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">_actions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">option_strings</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">option_strings</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;--&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">options_map</span><span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">option_strings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># For testing</span>
        <span class="k">if</span> <span class="n">input_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;singlethread&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Data file not provided, using current directory.&quot;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple data files specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;MTfit&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="o">+</span><span class="n">optparse_description</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">OptparseIndentedHelpFormatterWithNewLines</span><span class="p">(),</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> &quot;</span><span class="o">+</span><span class="n">__version__</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="s2">&quot;%prog [options]</span><span class="se">\n</span><span class="s2">Use -h to get more information&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;flags&#39;</span><span class="p">}</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cmd_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionGroup</span><span class="p">(</span>
                <span class="n">parser</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Commands for the extension &quot;</span><span class="o">+</span><span class="n">name</span><span class="p">)</span>
            <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">extension_parser_check</span><span class="p">)</span> <span class="o">=</span> <span class="n">extension</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span> <span class="n">_ARGPARSE</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="n">extension_parser_checks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extension_parser_check</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_PYQSUB</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionGroup</span><span class="p">(</span>
                <span class="n">parser</span><span class="p">,</span> <span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Commands for using MTfit on a cluster environment using qsub/PBS&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">pyqsub</span><span class="o">.</span><span class="n">parser_group</span><span class="p">(</span><span class="n">module_name</span><span class="o">=</span><span class="s1">&#39;MTfit&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">default_nodes</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">],</span> <span class="n">default_ppn</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;ppn&#39;</span><span class="p">],</span> <span class="n">default_pmem</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span>
                                        <span class="s1">&#39;pmem&#39;</span><span class="p">],</span> <span class="n">default_walltime</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;walltime&#39;</span><span class="p">],</span> <span class="n">default_queue</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;queue&#39;</span><span class="p">],</span> <span class="n">default_email_options</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;email_options&#39;</span><span class="p">],</span> <span class="n">default_email</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option_group</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">option_list</span><span class="p">:</span>
            <span class="n">options_map</span><span class="p">[</span><span class="n">option</span><span class="o">.</span><span class="n">dest</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="o">.</span><span class="n">get_opt_string</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">input_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_args</span><span class="p">):</span>
            <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;singlethread&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Data file not provided, using current directory.&quot;</span><span class="p">)</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple data files specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]):</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_path</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;bin_scatangle&#39;</span><span class="p">]:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Data file: &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;location_pdf_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_path</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;location_pdf_file_path&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Angle Scatter file path: &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;location_pdf_file_path&#39;</span><span class="p">]))</span>
    <span class="c1"># Check sampling_priors</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sampling_prior&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;sampling&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sampling&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;sample_distribution&#39;</span><span class="p">)</span>
    <span class="c1"># Set path variable</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">])):</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">])</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;chain_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_samples&#39;</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">extension_parser_check</span> <span class="ow">in</span> <span class="n">extension_parser_checks</span><span class="p">:</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">ext_flags</span> <span class="o">=</span> <span class="n">extension_parser_check</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">defaults</span><span class="p">)</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ext_flags</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">parser</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">flags</span>


<span class="k">def</span> <span class="nf">MTfit_parser</span><span class="p">(</span><span class="n">input_args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the command line arguments using _argparser and handles and returns the options</span>

<span class="sd">    Args</span>
<span class="sd">        input_args:[False] If provided, these are parsed instead of the command line arguments</span>

<span class="sd">    Returns</span>
<span class="sd">        options,options_map: The parsed options and the mapping from the parser options to the command line flags</span>

<span class="sd">    Raises</span>
<span class="sd">        Exception: If there is an error parsing the arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">options_map</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">_MTfit_argparser</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_PYQSUB</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;multiple_events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;minimum_number_intersections&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Minimum number of stations for intersection must be greater than 1&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;marginalise_relative&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;relative_amplitude&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Marginalise relative flag requires -r relative flag too.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;quality_check_value&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">])</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">],</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;quality_check&#39;</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;recover&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Recovering most recent run&#39;</span><span class="p">)</span>
        <span class="n">qsub</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">p_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.p&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]):</span>
            <span class="n">p_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.p&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;.p&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]:</span>
            <span class="c1"># Have a pfile in options [&#39;Datafile&#39;]</span>
            <span class="n">qsub</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]:</span>
                <span class="n">p_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">p_files</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Look for .p files in options[&#39;Datafile&#39;]</span>
            <span class="n">p_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="o">+</span><span class="s1">&#39;*.p*&#39;</span><span class="p">)</span>
            <span class="n">qsub</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;PBS&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;PBS_DEFAULT&#39;</span><span class="p">]):</span>
            <span class="n">qsub</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="s2">&quot;qsub&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Allow testing of qsub output</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_QSUBTEST</span><span class="p">:</span>
                <span class="n">qsub</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">pbs_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">pbs_file</span> <span class="k">for</span> <span class="n">pbs_file</span> <span class="ow">in</span> <span class="n">p_files</span> <span class="k">if</span> <span class="s1">&#39;.py&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pbs_file</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qsub</span> <span class="ow">or</span> <span class="n">_QSUBTEST</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pbs_files</span><span class="p">):</span>
            <span class="c1"># try looking for MTfit.p with highest number - corresponds to cluster environment</span>
            <span class="c1"># append r and re qsub unless on cluster</span>
            <span class="c1"># sort by ascending job no</span>
            <span class="n">pbs_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.p&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pbs_file</span> <span class="ow">in</span> <span class="n">pbs_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;##mtfit qsub script&#39;</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">pbs_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Recovering Run: &#39;</span><span class="o">+</span><span class="n">pbs_file</span><span class="p">)</span>
                    <span class="c1"># MTfit Script therefore read, parse and act</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">pbs_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;python -c &quot;import&#39;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">and</span> <span class="s1">&#39;#&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[:</span><span class="mi">10</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                    <span class="n">qsub_args</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;MTfit.__run__()&quot;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">arg</span> <span class="ow">or</span> <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                            <span class="n">qsub_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                            <span class="n">qsub_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">arg</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">qsub_options</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">_MTfit_argparser</span><span class="p">(</span><span class="n">qsub_args</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">option_name</span> <span class="ow">in</span> <span class="n">qsub_options</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;qsub&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">option_name</span><span class="p">:</span>
                            <span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">qsub_options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span>
                    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;recover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;PBS&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;PBS_DEFAULT&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_QSUBTEST</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot submit as already on cluster&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="s2">&quot;qsub&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Allow testing of qsub output</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_QSUBTEST</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find qsub - cannot run in cluster mode&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">options_map</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]):</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;combine_mpi_output&#39;</span><span class="p">]:</span>
            <span class="n">data_files</span><span class="p">,</span> <span class="n">scatter_files</span> <span class="o">=</span> <span class="n">_data_file_search</span><span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_extension&#39;</span><span class="p">],</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;angle_extension&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">):</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="s1">&#39;no_data_file_ok&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;combine_mpi_output&#39;</span><span class="p">]:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No Data files found in current folder&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_files</span>
            <span class="k">if</span> <span class="s1">&#39;no_location_update&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;location_pdf_file_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scatter_files</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;no_data_file_ok&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dc_mt&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot select --double_couple constraint and --compare_constrained flags.&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data_extension&#39;</span><span class="p">)</span>
    <span class="c1"># options.pop(&#39;angle_extension&#39;)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Parallel running disabled as number of workers set to 1&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="s1">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span>
                <span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;inversion_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;iterate&#39;</span><span class="p">]:</span>
        <span class="c1"># McMC algorithms use max samples argument for chain length</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_samples&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;max_samples argument ignored as </span><span class="si">{}</span><span class="s1"> algorithm selected.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]))</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_samples&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;max_time argument ignored as </span><span class="si">{}</span><span class="s1"> algorithm selected.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]))</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_time&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_time&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;iterate&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_samples&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_samples&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;chain_length&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;chain_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_chain_length&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;iterate&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;max_samples&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_samples&#39;</span><span class="p">])</span> <span class="ow">or</span><span class="s1">&#39;max_samples&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;max_iteration_samples&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_acceptance_rate&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_acceptance_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_min_acceptance_rate&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_acceptance_rate&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_acceptance_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_max_acceptance_rate&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_acceptance_rate&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_acceptance_rate&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Acceptance rate values cannot be the same, maximum acceptance rate must be bigger than the minimum acceptance rate&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_min_number_initialisation_samples&#39;</span><span class="p">]</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_number_check_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span>
        <span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_number_initialisation_samples&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;min_number_check_samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span>
            <span class="s1">&#39;min_number_check_samples&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Cannot run McMC with MPI - disabling mpi&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mem&#39;</span><span class="p">)</span>
    <span class="n">options_map</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;--mem&#39;</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;once&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;warnings flag not recognised&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
    <span class="c1"># Check MPI vs number_workers:</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_mpi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;PBS&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;PBS_DEFAULT&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_QSUBTEST</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot submit as already on cluster&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s2">&quot;which&quot;</span><span class="p">,</span> <span class="s2">&quot;qsub&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Allow testing of qsub output</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_QSUBTEST</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Could not find qsub - cannot run in cluster mode&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_mpi&#39;</span><span class="p">]:</span>
            <span class="n">num_procs</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_nodes&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_ppn&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_procs</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_ppn&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_nodes&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Warning MPI required for multinode running use -M/--mpi flag on command line&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_procs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;Number of workers does not match number of available processors, changing number of workers to: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_procs</span><span class="p">))</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_procs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span>
                    <span class="s1">&#39;Number of workers not set, changing to match number of available processors: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">num_procs</span><span class="p">))</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_procs</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_mpi&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]):</span>
            <span class="n">phy_mem</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Memory limit set and qsub memory limit set. Not matching so changing sampling memory limit to: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phy_mem</span><span class="p">))</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy_mem</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;phy_mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1"># set to use 8GB for sampling...</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_pmem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Walltime </span><span class="si">{}</span><span class="s1"> format incorrect, needs to be HH:MM:SS&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]))</span>
            <span class="n">walltime</span> <span class="o">=</span> <span class="mf">60.</span><span class="o">*</span><span class="mf">60.</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mf">60.</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;max_time&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="n">walltime</span> <span class="o">&lt;</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]:</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Walltime &#39;</span><span class="o">+</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; shorter than maximum time: &#39;</span><span class="o">+</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;max_time&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">and</span> <span class="mf">0.7</span><span class="o">*</span><span class="n">walltime</span> <span class="o">&lt;</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]:</span>
                <span class="n">newHrs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">10</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">)</span>
                <span class="n">newMin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((((</span><span class="mi">10</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">3600</span><span class="o">*</span><span class="n">newHrs</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
                <span class="n">newSec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                    <span class="p">(((</span><span class="mi">10</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span><span class="o">*</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;max_time&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">3600</span><span class="o">*</span><span class="n">newHrs</span><span class="o">-</span><span class="mi">60</span><span class="o">*</span><span class="n">newMin</span><span class="p">))</span>
                <span class="n">newWalltime</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">newHrs</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">newMin</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">newSec</span><span class="p">)])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
                    <span class="n">log</span><span class="p">(</span>
                        <span class="s1">&#39;Warning lengthening walltime as close to max time. Changing to &#39;</span><span class="o">+</span><span class="n">newWalltime</span><span class="p">)</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub_walltime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newWalltime</span>

    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;file_sample&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">hdf5storage</span> <span class="k">import</span> <span class="n">savemat</span><span class="p">,</span> <span class="n">loadmat</span>  <span class="c1"># noqa F401</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;file_sample option requires hdf5storage and h5py modules&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;file_sample&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;mcmc&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;file_sample option not supported for mcmc algorithms.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;qsub&#39;</span><span class="p">]:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Cannot run debug mode as batch job. Run in interactive mode only&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;_mpi_call&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="p">(</span>
                <span class="s1">&#39;Cannot run debug in parallel (issues with terminal), setting parallel to false&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;transd&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;algorithm&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dc_prior&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;dc_prior&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;dc_prior must be between 0 and 1&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;normalise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;no_normalise&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;results_format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hyp&#39;</span> <span class="ow">or</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;output_format&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hyp&#39;</span><span class="p">:</span>
        <span class="n">log</span><span class="p">(</span><span class="s1">&#39;Output format set to NonLinLoc hyp file format&#39;</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;results_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;output_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hyp&#39;</span>
    <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">options_map</span>

<span class="c1"># MTplot</span>


<span class="k">def</span> <span class="nf">_MTplot_argparser</span><span class="p">(</span><span class="n">input_args</span><span class="o">=</span><span class="p">[],</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns arguments parsed from command line</span>

<span class="sd">    Creates a command line argument parser (using argparse if present otherwise optparse (python &lt;=2.6))</span>
<span class="sd">    and parses the command line arguments (or input_args if provided as a list). Contains some help formatter classes.</span>

<span class="sd">    Args</span>
<span class="sd">        input_args:[False] If provided, these are parsed instead of the command line arguments</span>

<span class="sd">    Returns</span>
<span class="sd">        parser,options: Parser object, the parsed options and the mapping from the parser options to the command line flags</span>

<span class="sd">    Raises</span>
<span class="sd">        Exception: If there is an error parsing the arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;MTPlot - Moment Tensor Plotting Code by David J Pugh</span>

<span class="s2">    MTPlot is the moment tensor plotting code linked to the MTfit moment tensor inversion code.</span>


<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># optparse parser description extra</span>
    <span class="n">optparse_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Arguments are set as below, syntax is -dTest.i or --datafile=Test.i</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># argparse parser description extra</span>
    <span class="n">argparse_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Arguments are set as below, syntax is -dTest.i or -d Test.i</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="c1"># Get extension defaults</span>
    <span class="n">cmd_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cmd_default_types</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">evaluate_extensions</span><span class="p">(</span><span class="s1">&#39;MTfit.cmd_defaults&#39;</span><span class="p">,</span> <span class="n">default_cmd_defaults</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">cmd_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cmd_default_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Try loading MTfitdefaults from env var or ~/.MTfitdefaults</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">get_MTplot_defaults</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">cmd_defaults</span><span class="p">,</span> <span class="n">cmd_default_types</span><span class="p">)</span>
    <span class="n">mtplot_data_file_help</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;MTplot can read the output data from MTfit&quot;&quot;&quot;</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-d&quot;</span><span class="p">,</span> <span class="s2">&quot;--datafile&quot;</span><span class="p">,</span> <span class="s2">&quot;--data_file&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="n">mtplot_data_file_help</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-p&quot;</span><span class="p">,</span> <span class="s2">&quot;--plot_type&quot;</span><span class="p">,</span> <span class="s2">&quot;--plottype&quot;</span><span class="p">,</span> <span class="s2">&quot;--plot-type&quot;</span><span class="p">,</span> <span class="s2">&quot;--type&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Type of plot to make&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_type&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;--colormap&quot;</span><span class="p">,</span> <span class="s2">&quot;--color_map&quot;</span><span class="p">,</span> <span class="s2">&quot;--color-map&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Matplotlib colormap selection&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;colormap&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;colormap&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;--font_size&quot;</span><span class="p">,</span> <span class="s2">&quot;--fontsize&quot;</span><span class="p">,</span> <span class="s2">&quot;--font-size&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fontsize&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;fontsize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;fontsize&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="s2">&quot;--line_width&quot;</span><span class="p">,</span> <span class="s2">&quot;--linewidth&quot;</span><span class="p">,</span> <span class="s2">&quot;--line-width&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Linewidth&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;linewidth&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-t&quot;</span><span class="p">,</span> <span class="s2">&quot;--text&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-text&quot;</span><span class="p">,</span> <span class="s2">&quot;--show_text&quot;</span><span class="p">,</span> <span class="s2">&quot;--showtext&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Flag to show text or not&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="s2">&quot;--resolution&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Resolution for the focal sphere plot types&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-b&quot;</span><span class="p">,</span> <span class="s2">&quot;--bins&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of bins for the histogram plot types&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;bins&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--fault_plane&quot;</span><span class="p">,</span> <span class="s2">&quot;--faultplane&quot;</span><span class="p">,</span> <span class="s2">&quot;--fault-plane&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show the fault planes on a focal sphere type plot&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;fault_plane&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;fault_plane&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-n&quot;</span><span class="p">,</span> <span class="s2">&quot;--nodal_line&quot;</span><span class="p">,</span> <span class="s2">&quot;--nodal-line&quot;</span><span class="p">,</span> <span class="s2">&quot;--nodalline&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show the nodal lines on a focal sphere type plot&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;nodal_line&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;nodal_line&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--tnp&quot;</span><span class="p">,</span> <span class="s2">&quot;--tp&quot;</span><span class="p">,</span> <span class="s2">&quot;--pt&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show TNP axes on focal sphere plots&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;TNP&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;TNP&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--marker_size&quot;</span><span class="p">,</span> <span class="s2">&quot;--markersize&quot;</span><span class="p">,</span> <span class="s2">&quot;--marker-size&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set marker size&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;markersize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;markersize&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--station_marker_size&quot;</span><span class="p">,</span> <span class="s2">&quot;--stationmarkersize&quot;</span><span class="p">,</span> <span class="s2">&quot;--station-marker-size&quot;</span><span class="p">,</span> <span class="s2">&quot;--station_markersize&quot;</span><span class="p">,</span> <span class="s2">&quot;--station-markersize&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set station marker size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;station_markersize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;station_markersize&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--showmaxlikelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;--show_max_likelihood&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-max-likelihood&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show the maximum likelihood solution on a fault plane plot (shown in color set by --color).&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_max_likelihood&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;show_max_likelihood&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--showmean&quot;</span><span class="p">,</span> <span class="s2">&quot;--show-mean&quot;</span><span class="p">,</span> <span class="s2">&quot;--show_mean&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show the mean orientaion on a fault plane plot (shown in green).&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;show_mean&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;show_mean&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--grid_lines&quot;</span><span class="p">,</span> <span class="s2">&quot;--gridlines&quot;</span><span class="p">,</span> <span class="s2">&quot;--grid-lines&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show interior lines on Hudson and lune plots&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;grid_lines&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;grid_lines&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--color&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set default color&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--type_label&quot;</span><span class="p">,</span> <span class="s2">&quot;--typelabel&quot;</span><span class="p">,</span> <span class="s2">&quot;--type-label&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show source type labels on Hudson and lune plots.&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;type_label&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;type_label&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--hex_bin&quot;</span><span class="p">,</span> <span class="s2">&quot;--hexbin&quot;</span><span class="p">,</span> <span class="s2">&quot;--hex-bin&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use hex bin for histogram plottings&quot;</span><span class="p">,</span>
             <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hex_bin&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;hex_bin&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--projection&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Projection choice for focal sphere plots&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;projection&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--save&quot;</span><span class="p">,</span> <span class="s2">&quot;--save_file&quot;</span><span class="p">,</span> <span class="s2">&quot;--savefile&quot;</span><span class="p">,</span> <span class="s2">&quot;--save-file&quot;</span><span class="p">],</span>
             <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Set the filename to save to (if set the plot is saved to the file)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;save_file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;save_file&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--save-dpi&quot;</span><span class="p">,</span> <span class="s2">&quot;--savedpi&quot;</span><span class="p">,</span> <span class="s2">&quot;--save_dpi&quot;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file dpi&quot;</span><span class="p">,</span>
             <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;save_dpi&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;save_dpi&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--quiet&#39;</span><span class="p">,</span> <span class="s1">&#39;--hide&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Don&#39;t show the plot on screen&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
             <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;hide&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">defaults</span><span class="p">[</span><span class="s1">&#39;hide&#39;</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">flags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;--version&quot;</span><span class="p">],</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;version&quot;</span><span class="p">,</span>
             <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> from MTfit &quot;</span><span class="o">+</span><span class="n">__version__</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">_ARGPARSE</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
            <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;MTplot&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="o">+</span><span class="n">argparse_description</span><span class="p">,</span> <span class="n">formatter_class</span><span class="o">=</span><span class="n">ArgparseIndentedHelpFormatterWithNewLines</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s1">&#39;data_file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Data file to use for plotting, optional but must be specified either as a positional argument or as an optional argument (see -d below)&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;flags&#39;</span><span class="p">}</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># For testing</span>
        <span class="k">if</span> <span class="n">input_args</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No data file specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple data files specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;MTplot&#39;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="o">+</span><span class="n">optparse_description</span><span class="p">,</span> <span class="n">formatter</span><span class="o">=</span><span class="n">OptparseIndentedHelpFormatterWithNewLines</span><span class="p">(</span>
        <span class="p">),</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(prog)s</span><span class="s2"> from MTfit &quot;</span><span class="o">+</span><span class="n">__version__</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="s2">&quot;%prog [options]</span><span class="se">\n</span><span class="s2">Use -h to get more information&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;flags&#39;</span><span class="p">}</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="o">*</span><span class="n">arg</span><span class="p">[</span><span class="s1">&#39;flags&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_args</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_args</span><span class="p">):</span>
            <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">input_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No data file specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Multiple data files specified.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">]</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;DATAFILE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">):</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;show&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">parser</span><span class="p">,</span> <span class="n">options</span>


<span class="k">def</span> <span class="nf">MTplot_parser</span><span class="p">(</span><span class="n">input_args</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses the command line arguments using _argparser and handles and returns the options</span>

<span class="sd">    Args</span>
<span class="sd">        input_args:[False] If provided, these are parsed instead of the command line arguments</span>

<span class="sd">    Returns</span>
<span class="sd">        options,options_map: The parsed options and the mapping from the parser options to the command line flags</span>

<span class="sd">    Raises</span>
<span class="sd">        Exception: If there is an error parsing the arguments</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">_MTplot_argparser</span><span class="p">(</span><span class="n">input_args</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hudson&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;equalarea&#39;</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uv&#39;</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span> <span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="s1">&#39;tauk&#39;</span><span class="p">]:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="n">options</span><span class="p">[</span><span class="s1">&#39;projection&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; not recognised for Hudson type plot&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;colormap&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hudson&#39;</span><span class="p">,</span> <span class="s1">&#39;lune&#39;</span><span class="p">]:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;colormap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_HIST_COLORMAP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;colormap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_AMP_COLORMAP</span>

    <span class="k">return</span> <span class="n">options</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-utilities_extensions.html" class="btn btn-neutral float-right" title="17.1.6.1.2. MTfit.utilities.extensions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="source-utilities.html" class="btn btn-neutral" title="17.1.6. MTfit.utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, David Pugh.
      Last updated on Aug 30, 2018 (version 1.0.3a15).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.3a15',
            LANGUAGE:'English',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>